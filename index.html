<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ì»¤ìŠ¤í…€ CSS */
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #dc2626;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .close-btn {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close-btn:hover {
            color: #333;
        }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 1100;
            display: none;
            text-align: center;
            max-width: 80%;
            min-width: 250px;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1.4;
        }
        .message-success { background-color: #d1fae5; color: #047857; border: 2px solid #065f46; }
        .message-error { background-color: #fee2e2; color: #b91c1c; border: 2px solid #991b1b; }
        .message-info { background-color: #dbeafe; color: #1e40af; border: 2px solid #1e3a8a; }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 1099;
            display: none;
        }

    </style>
</head>
<body>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- íƒ€ì´í‹€ -->
    <h1 class="text-xl md:text-2xl font-bold bg-white p-3 shadow-md">
        <i class="fas fa-fire-extinguisher text-red-600 mr-2"></i> ë¶ˆë²• ì†Œê° ê°ì§€ ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ
    </h1>

    <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
    <div class="control-panel">
        <button onclick="openPreReportModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-flag-checkered mr-2"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ 
        </button>
        <button onclick="openManualDataModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-thermometer-half mr-2"></i> ì§ì ‘ ë°ì´í„° ì…ë ¥
        </button>
        <button onclick="fetchData()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-sync-alt mr-2"></i> ë°ì´í„° ìƒˆë¡œê³ ì¹¨
        </button>
        <button onclick="confirmDeleteAll()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-eraser mr-2"></i> ì „ì²´ ë°ì´í„° ì‚­ì œ
        </button>
    </div>

    <!-- ì§€ë„ ì˜ì—­ -->
    <div id="map"></div>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ ì˜¤ë²„ë ˆì´ -->
    <div id="messageBoxOverlay" class="message-box-overlay" onclick="closeMessageBox()"></div>
    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="messageBox"></div>

    <!-- 1. ì†Œê° ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ -->
    <div id="preReportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('preReportModal')">&times;</span>
            <h2 class="text-red-600">ì†Œê° ì‚¬ì „ ì‹ ê³ </h2>
            
            <div class="space-y-4">
                <!-- ë‚ ì§œ ë° ì‹œê°„ ì…ë ¥ í•„ë“œ ìˆ˜ì • -->
                <div>
                    <label for="pre_start_date" class="block text-sm font-medium text-gray-700">ì†Œê° ì‹œì‘ ë‚ ì§œ ë° ì‹œê°„</label>
                    <input type="datetime-local" id="pre_start_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="pre_end_date" class="block text-sm font-medium text-gray-700">ì†Œê° ì¢…ë£Œ ë‚ ì§œ ë° ì‹œê°„</label>
                    <input type="datetime-local" id="pre_end_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <!-- /ë‚ ì§œ ë° ì‹œê°„ ì…ë ¥ í•„ë“œ ìˆ˜ì • -->
                
                <div>
                    <label for="pre_range_km" class="block text-sm font-medium text-gray-700">ìœ íš¨ ë²”ìœ„ (Km)</label>
                    <input type="number" id="pre_range_km" step="0.01" min="0.01" value="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="pre_lat" class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                    <input type="text" id="pre_lat" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="pre_lon" class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                    <input type="text" id="pre_lon" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                
                <p class="text-sm text-gray-500">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ê±°ë‚˜, í•€ì„ ë“œë˜ê·¸í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì§€ì •í•˜ì„¸ìš”.</p>
                
                <button onclick="submitPreReport(this)" id="preReportSubmitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg mt-4">
                    ì‚¬ì „ ì‹ ê³  ë“±ë¡
                </button>
            </div>
        </div>
    </div>

    <!-- 2. ì§ì ‘ ê°ì§€ ë°ì´í„° ì…ë ¥ ëª¨ë‹¬ -->
    <div id="manualDataModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('manualDataModal')">&times;</span>
            <h2 class="text-blue-600">ì§ì ‘ ê°ì§€ ë°ì´í„° ë“±ë¡</h2>
            
            <div class="space-y-4">
                <!-- ì‹œê°„ í•„ë“œë¥¼ ì˜¨ë„ í•„ë“œë¡œ ìˆ˜ì • -->
                <div>
                    <label for="manual_temp" class="block text-sm font-medium text-gray-700">ì˜¨ë„ (Â°C)</label>
                    <!-- ì‹œê°„(time) ëŒ€ì‹  ì˜¨ë„(temp)ë¥¼ ì…ë ¥ë°›ìŠµë‹ˆë‹¤. -->
                    <input type="number" id="manual_temp" step="1" placeholder="ê°ì§€ ì˜¨ë„ (Â°C, ì˜ˆ: 300)" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- /ì‹œê°„ í•„ë“œë¥¼ ì˜¨ë„ í•„ë“œë¡œ ìˆ˜ì • -->
                
                <div>
                    <label for="manual_smoke" class="block text-sm font-medium text-gray-700">ì—°ê¸°ëŸ‰ (0.0~1.0)</label>
                    <input type="number" id="manual_smoke" step="0.01" min="0" max="1" value="0.5" placeholder="0.0~1.0 ì‚¬ì´ ê°’" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="manual_lat" class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                    <input type="text" id="manual_lat" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="manual_lon" class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                    <input type="text" id="manual_lon" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                
                <p class="text-sm text-gray-500">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ê±°ë‚˜, í•€ì„ ë“œë˜ê·¸í•˜ì—¬ ì •í™•í•œ ìœ„ì¹˜ë¥¼ ì§€ì •í•˜ì„¸ìš”.</p>
                
                <button onclick="submitManualData(this)" id="manualSubmitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg mt-4">
                    ë°ì´í„° ë“±ë¡
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let lastClickedLatLng = null; // ë§ˆì§€ë§‰ í´ë¦­/ë“œë˜ê·¸ëœ ìœ„ì¹˜
        let tempMarker = null; // ì„ì‹œ í•€ ë§ˆì»¤
        let markers = new L.LayerGroup(); // ëª¨ë“  ë§ˆì»¤ ê·¸ë£¹
        let isMessageBoxOpen = false;
        
        // --- 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ëª¨ë‹¬, ë©”ì‹œì§€ ë°•ìŠ¤) ---

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const overlay = document.getElementById('messageBoxOverlay');
            box.textContent = message;
            box.className = `message-${type}`; // í´ë˜ìŠ¤ ë³€ê²½
            box.style.display = 'block';
            overlay.style.display = 'block';
            isMessageBoxOpen = true;
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('messageBoxOverlay').style.display = 'none';
            isMessageBoxOpen = false;
        }

        // --- 2. Leaflet ê´€ë ¨ í•¨ìˆ˜ (ë§ˆì»¤ ìƒì„± ë“±) ---

        // ì»¤ìŠ¤í…€ DIV ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜
        function createDivIcon(html, className, color) {
            return L.divIcon({
                className: className,
                html: `<div style="color: ${color}; font-size: 24px; text-shadow: 0 0 2px rgba(0,0,0,0.5);">${html}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 24], // í•€ ëì´ ìœ„ì¹˜ë¥¼ ê°€ë¦¬í‚¤ë„ë¡ ì„¤ì •
                popupAnchor: [0, -20]
            });
        }

        // ì‚¼ê°í˜• ì•„ì´ì½˜ (ì‹œë¯¼ ì‹ ê³ )
        function createTriangleIcon(color) {
            return createDivIcon('<i class="fas fa-exclamation-triangle"></i>', 'citizen-report-icon', color);
        }

        // ì›í˜• ì•„ì´ì½˜ (ì§ì ‘ ê°ì§€)
        function createCircleIcon(color) {
            return createDivIcon('<i class="fas fa-circle-notch fa-spin"></i>', 'direct-data-icon', color);
        }

        // --- 3. ë°ì´í„° ì…ë ¥ ëª¨ë‹¬ ì—´ê¸° ---

        function openPreReportModal() {
            if (!lastClickedLatLng) {
                showMessageBox('âŒ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì†Œê° ìœ„ì¹˜ë¥¼ ë¨¼ì € ì§€ì •í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            document.getElementById('pre_lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('pre_lon').value = lastClickedLatLng.lng.toFixed(6);
            
            // ë‚ ì§œ/ì‹œê°„ ì´ˆê¸°ê°’ ì„¤ì • (ì„ íƒ ì‚¬í•­)
            const now = new Date();
            // YYYY-MM-DDTHH:MM í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
            const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('pre_start_date').value = isoString;
            document.getElementById('pre_end_date').value = isoString;

            openModal('preReportModal');
        }

        function openManualDataModal() {
            if (!lastClickedLatLng) {
                showMessageBox('âŒ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê°ì§€ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì§€ì •í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }
            document.getElementById('manual_lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('manual_lon').value = lastClickedLatLng.lng.toFixed(6);
            // ì˜¨ë„ í•„ë“œëŠ” ë¹„ì›Œë‘ê±°ë‚˜ ê¸°ë³¸ê°’ ì„¤ì •
            document.getElementById('manual_temp').value = '300';
            document.getElementById('manual_smoke').value = '0.5';

            openModal('manualDataModal');
        }


        // --- 4. ë°ì´í„° ì „ì†¡ (API) ---

        /**
         * ì†Œê° ì‚¬ì „ ì‹ ê³  ë°ì´í„° ì „ì†¡
         */
        async function submitPreReport(submitBtn) {
            submitBtn.disabled = true;
            
            // ë‚ ì§œ/ì‹œê°„ ê°’ì„ ISO ë¬¸ìì—´ë¡œ ê°€ì ¸ì˜¨ í›„ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜
            const startDateStr = document.getElementById('pre_start_date').value;
            const endDateStr = document.getElementById('pre_end_date').value;
            const rangeKm = document.getElementById('pre_range_km').value;
            const lat = document.getElementById('pre_lat').value;
            const lon = document.getElementById('pre_lon').value;

            // Date.parseëŠ” ISO 8601 ë¬¸ìì—´ì„ ë°€ë¦¬ì´ˆ íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
            const startDate = Date.parse(startDateStr); 
            const endDate = Date.parse(endDateStr); 

            if (isNaN(startDate) || isNaN(endDate) || !rangeKm || !lat || !lon) {
                showMessageBox('âŒ ëª¨ë“  í•„ë“œë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”. (ë‚ ì§œ/ì‹œê°„ í¬í•¨)', 'error');
                submitBtn.disabled = false;
                return;
            }

            if (startDate >= endDate) {
                showMessageBox('âŒ ì¢…ë£Œ ë‚ ì§œ/ì‹œê°„ì€ ì‹œì‘ ë‚ ì§œ/ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                submitBtn.disabled = false;
                return;
            }
            
            closeModal('preReportModal');
            showMessageBox("ì‚¬ì „ ì‹ ê³  ë“±ë¡ ì¤‘...", 'info');
            
            try {
                const payload = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    startDate: startDate, // ë°€ë¦¬ì´ˆ íƒ€ì„ìŠ¤íƒ¬í”„ ì „ì†¡
                    endDate: endDate,     // ë°€ë¦¬ì´ˆ íƒ€ì„ìŠ¤íƒ¬í”„ ì „ì†¡
                    rangeKm: parseFloat(rangeKm)
                };

                const response = await fetch('/api/add/pre', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showMessageBox('âœ… ì‚¬ì „ ì‹ ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData();
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì‚¬ì „ ì‹ ê³  ë“±ë¡ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }

            } catch (error) {
                console.error('ì‚¬ì „ ì‹ ê³  API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        /**
         * ì§ì ‘ ê°ì§€ ë°ì´í„° (ì˜¨ë„, ì—°ê¸°ëŸ‰) ì „ì†¡
         */
        async function submitManualData(submitBtn) {
            submitBtn.disabled = true;

            // 'manual_time' ëŒ€ì‹  'manual_temp'ì—ì„œ ì˜¨ë„ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const tempStr = document.getElementById('manual_temp').value; 
            const smokeStr = document.getElementById('manual_smoke').value;
            const lat = document.getElementById('manual_lat').value;
            const lon = document.getElementById('manual_lon').value;

            const temp = parseFloat(tempStr);
            const smoke = parseFloat(smokeStr);

            if (isNaN(temp) || isNaN(smoke) || smoke < 0 || smoke > 1 || !lat || !lon) {
                showMessageBox('âŒ ì˜¨ë„ì™€ ì—°ê¸°ëŸ‰(0.0~1.0), ìœ„ì¹˜ë¥¼ ëª¨ë‘ ì •í™•íˆ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                submitBtn.disabled = false;
                return;
            }
            
            closeModal('manualDataModal');
            showMessageBox("ì§ì ‘ ë°ì´í„° ë“±ë¡ ì¤‘...", 'info');
            
            try {
                const payload = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    temp: temp, // ì˜¨ë„ ë°ì´í„° ì „ì†¡
                    smoke: smoke,
                    time: Date.now() // ê°ì§€ ì‹œê°„ì€ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •
                };

                const response = await fetch('/api/add/manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showMessageBox('âœ… ì§ì ‘ ê°ì§€ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData();
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì§ì ‘ ë°ì´í„° ë“±ë¡ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }

            } catch (error) {
                console.error('ì§ì ‘ ë°ì´í„° API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        // --- 5. ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ë° ì‹œê°í™” ---

        function isInPreReport(lat, lon, time, preReports) {
            // ì‚¬ì „ ì‹ ê³ ëœ ìœ„ì¹˜ì—ì„œ 0.1km(ê¸°ë³¸ê°’) ì´ë‚´, ì§€ì •ëœ ì‹œê°„ ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸
            const point = L.latLng(lat, lon);
            
            return preReports.some(report => {
                const reportCenter = L.latLng(report.lat, report.lon);
                const distanceMeters = point.distanceTo(reportCenter);
                const rangeMeters = (report.rangeKm || 0.1) * 1000;
                
                // ê±°ë¦¬ ë° ì‹œê°„ ë¹„êµ
                return distanceMeters <= rangeMeters && time >= report.startDate && time <= report.endDate;
            });
        }

        function renderData(directData, citizenReports, preReports) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.clearLayers();

            try {
                // A. ì§ì ‘ ê°ì§€ ë°ì´í„° (directData) ì²˜ë¦¬
                directData.forEach(row => {
                    // directDataì—ëŠ” ì´ì œ 'time', 'temp', 'smoke'ê°€ í¬í•¨ë©ë‹ˆë‹¤.
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    
                    // ë¶ˆë²• ì†Œê° ì˜ì‹¬ ê¸°ì¤€: ì—°ê¸°ëŸ‰ 0.4 ì´ˆê³¼ AND ì˜¨ë„ 100Â°C ì´ˆê³¼ (ì„ì‹œ ê¸°ì¤€)
                    const isBurn = row.smoke > 0.4 && row.temp > 100;

                    let color;
                    if (isReported) {
                        color = '#ff8c00'; // ì£¼í™©: ì‹ ê³ ëœ ì†Œê°
                    } else if (isBurn) {
                        color = '#dc2626'; // ë¹¨ê°•: ë¶ˆë²• ì†Œê° ì˜ì‹¬
                    } else {
                        color = '#10b981'; // ì´ˆë¡: ì •ìƒ ë²”ìœ„
                    }

                    const icon = createCircleIcon(color);
                    
                    // íŒì—… ë‚´ìš© ìˆ˜ì •: 'ì˜¨ë„' í•„ë“œ ì¶”ê°€ ë° 'ì‹œê°„' í¬ë§·íŒ… ê°œì„ 
                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[ì§ì ‘ ê°ì§€]</b><br>
                        <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>ì˜¨ë„:</b> ${row.temp}Â°C<br> 
                        <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : (isBurn ? 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬' : 'ğŸŸ¢ ì •ìƒ')}<br>
                        <small>ë“±ë¡ ì‹œê°„: ${new Date(row.createdAt).toLocaleString()}</small>
                    `);
                    markers.addLayer(marker);
                });

                // B. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                    // citizenReportsì—ëŠ” 'time'(ì‹ ê³ ëœ ì‹œì )ì´ í¬í•¨ë©ë‹ˆë‹¤.
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; 
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                        <b>ì‹ ê³  ì‹œì :</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë°ì´í„° ì‹œê°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ.', 'error');
            }
        }

        async function fetchData() {
            showMessageBox("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", 'info');
            try {
                // index.js API í˜¸ì¶œ
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Firestore TimestampëŠ” ì´ˆ ë‹¨ìœ„ë¡œ ì €ì¥ë˜ë¯€ë¡œ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
                const preReports = data.preReports.map(report => ({
                    ...report,
                    startDate: report.startDate, // ì´ë¯¸ í´ë¼ì´ì–¸íŠ¸ì—ì„œ msë¡œ ì „ì†¡
                    endDate: report.endDate
                }));

                const directData = data.directData.map(d => ({
                    ...d,
                    time: d.time, // í´ë¼ì´ì–¸íŠ¸ì—ì„œ msë¡œ ì „ì†¡
                    createdAt: d.createdAt ? d.createdAt.seconds * 1000 : Date.now()
                }));

                const citizenReports = data.citizenReports.map(r => ({
                    ...r,
                    time: r.time, // í´ë¼ì´ì–¸íŠ¸ì—ì„œ msë¡œ ì „ì†¡
                    createdAt: r.createdAt ? r.createdAt.seconds * 1000 : Date.now()
                }));
                
                renderData(directData, citizenReports, preReports);
                closeMessageBox();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                showMessageBox(`âŒ ë°ì´í„° ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}. Vercel API ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.`, 'error');
            }
        }
        
        // --- 6. ì§€ë„ í´ë¦­ ë° ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ì„ì‹œ í•€ ë° ì¢Œí‘œ ì €ì¥) ---
        function setupMapEvents() {
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. ê¸°ì¡´ ì„ì‹œ ë§ˆì»¤ ì œê±°
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. ìƒˆ ì„ì‹œ ë§ˆì»¤ ìƒì„± (íŒŒë€ìƒ‰ í•€) - draggable: true ì¶”ê°€
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>í´ë¦­ëœ ìœ„ì¹˜:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // ì „ì—­ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    
                    // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
                    marker.setPopupContent(`<b>ë“œë˜ê·¸ëœ ìœ„ì¹˜:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œë„ ì—…ë°ì´íŠ¸
                    const preReportModal = document.getElementById('preReportModal');
                    const manualDataModal = document.getElementById('manualDataModal');

                    if (preReportModal.style.display === 'flex') {
                        document.getElementById('pre_lat').value = position.lat.toFixed(6);
                        document.getElementById('pre_lon').value = position.lng.toFixed(6);
                    } else if (manualDataModal.style.display === 'flex') {
                        document.getElementById('manual_lat').value = position.lat.toFixed(6);
                        document.getElementById('manual_lon').value = position.lng.toFixed(6);
                    }
                });
            });
        }
        
        // --- 7. ì „ì²´ ì‚­ì œ í™•ì¸ ---
        function confirmDeleteAll() {
            if (isMessageBoxOpen) return;

            const box = document.getElementById('messageBox');
            const overlay = document.getElementById('messageBoxOverlay');
            
            box.innerHTML = `
                <p class="text-lg mb-4">âš ï¸ ê²½ê³ : ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition duration-200">
                    ì‚­ì œ í™•ì¸
                </button>
                <button onclick="closeMessageBox()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    ì·¨ì†Œ
                </button>
            `;
            box.className = 'message-error';
            box.style.display = 'block';
            overlay.style.display = 'block';
            isMessageBoxOpen = true;

            document.getElementById('confirmDeleteBtn').onclick = deleteAllData;
        }

        async function deleteAllData() {
            closeMessageBox();
            showMessageBox("ë°ì´í„° ì‚­ì œ ì¤‘...", 'info');
            
            try {
                // index.jsì— êµ¬í˜„ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ API í˜¸ì¶œ
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('âœ… ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData(); // ì‚­ì œ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. ì´ˆê¸°í™” ---

        function initializeMap() {
            // ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            setupMapEvents(); // ì§€ë„ ì´ë²¤íŠ¸ ì„¤ì •
            fetchData();      // ì´ˆê¸° ë°ì´í„° ë¡œë“œ

            // ë§µ í¬ê¸° ë³€ê²½ ì‹œ íƒ€ì¼ ë‹¤ì‹œ ë¡œë“œ
            window.addEventListener('resize', () => map.invalidateSize());
        }

        window.onload = initializeMap;

    </script>
</body>
</html>
