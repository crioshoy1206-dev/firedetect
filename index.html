<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Noto Sans KR Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ: í™”ë©´ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
        body { 
            margin: 0; 
            font-family: 'Noto Sans KR', sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background-color: #f8f8f8;
        }
        
        /* ë§µ ì»¨í…Œì´ë„ˆ: flex-growë¡œ ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
        #map { 
            flex-grow: 1; 
            width: 100%; 
            z-index: 0; 
            min-height: 50vh; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .control-panel {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        /* ì»¤ìŠ¤í…€ ë§ˆì»¤ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .custom-div-icon {
            text-align: center;
            line-height: 1;
            font-size: 1.5rem;
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
        }

        .temp-pin-icon {
            font-size: 1.8rem;
            animation: none;
            box-shadow: none;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.8; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.8; }
        }

        /* ë©”ì‹œì§€ ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-weight: 700;
            text-align: center;
            display: none;
            max-width: 90%;
            min-width: 250px;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box-content {
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .message-box-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
    </style>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase JS Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); // Firestore ë¡œê·¸ ë ˆë²¨ ì„¤ì •

        // --- ê¸€ë¡œë²Œ ë³€ìˆ˜ ì„¤ì • (Canvas í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase ì´ˆê¸°í™” ---
        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // ì‚¬ìš©ì ì¸ì¦ ì²˜ë¦¬
            if (initialAuthToken) {
                signInWithCustomToken(window.auth, initialAuthToken)
                    .then(() => {
                        console.log("âœ… Firebase Custom Token Sign-In Success.");
                    })
                    .catch((error) => {
                        console.error("âŒ Firebase Custom Token Sign-In Failed:", error);
                        signInAnonymously(window.auth); // ì‹¤íŒ¨ ì‹œ ìµëª… ë¡œê·¸ì¸ ì‹œë„
                    });
            } else {
                signInAnonymously(window.auth)
                    .then(() => console.log("âœ… Firebase Anonymous Sign-In Success."))
                    .catch((error) => console.error("âŒ Firebase Anonymous Sign-In Failed:", error));
            }
        } else {
            console.warn("âš ï¸ Firebase Config is missing. Data persistence/API usage may be affected.");
        }
        window.appId = appId;
    </script>
</head>
<body>
    <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center">
        <h1 class="text-xl font-bold text-red-600 mb-2 sm:mb-0">
            <i class="fas fa-fire-extinguisher mr-2"></i>ë¶ˆë²• ì†Œê° ê°ì§€ ì‹œìŠ¤í…œ ì§€ë„
        </h1>
        <div class="flex flex-wrap justify-center gap-2">
            <button onclick="openPreReportModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-calendar-alt mr-1"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ 
            </button>
            <button onclick="openAddDetectionModal()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-plus-circle mr-1"></i> ê°ì§€ ë°ì´í„° ì¶”ê°€
            </button>
            <a href="/citizen_report.html" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                <i class="fas fa-megaphone mr-1"></i> ì‹œë¯¼ ì‹ ê³  í˜ì´ì§€
            </a>
            <button onclick="confirmDeleteAllData()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-trash-alt mr-1"></i> ë°ì´í„° ì „ì²´ ì‚­ì œ
            </button>
        </div>
    </header>

    <main class="p-4 flex-grow relative">
        <div id="map" class="h-full w-full"></div>
    </main>

    <!-- ----------------------- ëª¨ë‹¬ í…œí”Œë¦¿ (ì‚¬ì „ ì‹ ê³  / ê°ì§€ ë°ì´í„° ì¶”ê°€) ----------------------- -->

    <!-- 1. ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ -->
    <div id="preReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">ì†Œê° ì‚¬ì „ ì‹ ê³  (ì˜ˆì •)</h2>
            <form id="preReportForm" onsubmit="submitPreReport(event)">
                <div class="mb-4">
                    <label for="preLat" class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                    <input type="number" id="preLat" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preLon" class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                    <input type="number" id="preLon" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preRangeKm" class="block text-sm font-medium text-gray-700">ì†Œê° ë²”ìœ„ (Km)</label>
                    <input type="number" id="preRangeKm" step="0.1" value="0.5" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preStartDate" class="block text-sm font-medium text-gray-700">ì‹œì‘ ì¼ì‹œ</label>
                    <input type="datetime-local" id="preStartDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-6">
                    <label for="preEndDate" class="block text-sm font-medium text-gray-700">ì¢…ë£Œ ì¼ì‹œ</label>
                    <input type="datetime-local" id="preEndDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closePreReportModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" id="preSubmitBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                        ì‹ ê³  ì ‘ìˆ˜
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. ê°ì§€ ë°ì´í„° ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addDetectionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-green-600 border-b pb-2">ê°ì§€ ë°ì´í„° ìˆ˜ë™ ì¶”ê°€</h2>
            <form id="addDetectionForm" onsubmit="submitDetectionData(event)">
                <div class="mb-4">
                    <label for="detLat" class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                    <input type="number" id="detLat" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="detLon" class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                    <input type="number" id="detLon" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="detSmoke" class="block text-sm font-medium text-gray-700">ì—°ê¸°ëŸ‰ (1-100)</label>
                    <input type="number" id="detSmoke" min="1" max="100" value="50" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-6">
                    <label for="detTime" class="block text-sm font-medium text-gray-700">ê°ì§€ ì‹œê°</label>
                    <input type="datetime-local" id="detTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddDetectionModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        ì·¨ì†Œ
                    </button>
                    <button type="submit" id="detSubmitBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">
                        ë°ì´í„° ì¶”ê°€
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. ë²”ìš© ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="message-box" class="hidden">
        <div class="message-box-content" id="message-text"></div>
        <button class="message-box-close" onclick="closeMessageBox()">&times;</button>
    </div>


    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let map; // Leaflet ì§€ë„ ê°ì²´
        let markers; // ë§ˆì»¤ ê·¸ë£¹ ë ˆì´ì–´
        let tempMarker = null; // ì§€ë„ í´ë¦­ ì‹œ ìƒì„±ë˜ëŠ” ì„ì‹œ ë§ˆì»¤
        let lastClickedLatLng = null; // ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¦­ëœ/ë“œë˜ê·¸ëœ ì¢Œí‘œ
        let preReportCircles = []; // ì‚¬ì „ ì‹ ê³  ë²”ìœ„ ì‹œê°í™” (Circle Marker)
        let isMessageBoxOpen = false;

        // --- 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: ë©”ì‹œì§€ ë°•ìŠ¤ í‘œì‹œ ---
        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const closeBtn = box.querySelector('.message-box-close');
            
            // ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            box.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden');
            box.style.color = 'white';

            // íƒ€ì…ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
            switch (type) {
                case 'success':
                    box.classList.add('bg-green-500');
                    break;
                case 'error':
                    box.classList.add('bg-red-500');
                    break;
                case 'warning':
                    box.classList.add('bg-yellow-500');
                    box.style.color = '#333'; // ê²½ê³ ëŠ” í…ìŠ¤íŠ¸ ìƒ‰ìƒì„ ì–´ë‘¡ê²Œ
                    closeBtn.style.color = '#333';
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-500');
                    break;
            }

            text.textContent = message;
            box.style.display = 'block';
            isMessageBoxOpen = true;

            // 3ì´ˆ í›„ ìë™ ë‹«ê¸° (ì˜¤ë¥˜/ê²½ê³ ëŠ” ì œì™¸)
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (isMessageBoxOpen) closeMessageBox();
                }, 3000);
            }
        }

        function closeMessageBox() {
            document.getElementById('message-box').style.display = 'none';
            document.getElementById('message-box').querySelector('.message-box-close').style.color = 'white'; // ìƒ‰ìƒ ë³µêµ¬
            isMessageBoxOpen = false;
        }

        // --- 2. Leaflet ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ìƒì„± ---

        /**
         * ì—°ê¸° ê°ì§€ ë§ˆì»¤ (ì›í˜• ì•„ì´ì½˜) ìƒì„±
         * @param {string} color - CSS ìƒ‰ìƒ
         * @param {number} smokeLevel - ì—°ê¸°ëŸ‰ (1~100)
         * @returns {L.DivIcon}
         */
        function createSmokeIcon(color, smokeLevel) {
            const size = 30 + (smokeLevel / 100) * 20; // ì—°ê¸°ëŸ‰ì— ë”°ë¼ í¬ê¸° ì¡°ì ˆ (30px ~ 50px)
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<i class="fas fa-smog" style="color: ${color}; font-size: ${size * 0.6}px;"></i>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                style: `background-color: ${color}20; border: 2px solid ${color}; width: ${size}px; height: ${size}px;`
            });
        }

        /**
         * ì‹œë¯¼ ì‹ ê³  ë§ˆì»¤ (ì‚¼ê°í˜• ì•„ì´ì½˜) ìƒì„±
         * @param {string} color - CSS ìƒ‰ìƒ
         * @returns {L.DivIcon}
         */
        function createTriangleIcon(color) {
            const size = 30;
            return L.divIcon({
                className: 'custom-div-icon temp-pin-icon', // ì• ë‹ˆë©”ì´ì…˜ ë¯¸ì ìš©
                html: `<i class="fas fa-exclamation-triangle" style="color: ${color}; font-size: 24px;"></i>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                style: `background-color: ${color}20; border: 2px solid ${color}; width: ${size}px; height: ${size}px;`
            });
        }
        
        /**
         * ì¼ë°˜ í•€ ì•„ì´ì½˜ ìƒì„± (ëª¨ë‹¬ ìœ„ì¹˜ ì§€ì •ìš©)
         */
        function createDivIcon(htmlContent, className, color) {
            return L.divIcon({
                className: `custom-div-icon ${className}`,
                html: htmlContent,
                iconSize: [35, 35],
                iconAnchor: [17, 35],
                style: `color: ${color}; background-color: white; border: 2px solid ${color};`
            });
        }

        // --- 3. ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ---

        /**
         * ì‚¬ì „ ì‹ ê³  êµ¬ì—­ ë‚´ì— ê°ì§€/ì‹ ê³  ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ìœ í‹¸ë¦¬í‹°
         * @param {number} lat - ê°ì§€/ì‹ ê³  ìœ„ë„
         * @param {number} lon - ê°ì§€/ì‹ ê³  ê²½ë„
         * @param {number} time - ê°ì§€/ì‹ ê³  ì‹œê°„ (timestamp)
         * @param {Array<Object>} preReports - ì‚¬ì „ ì‹ ê³  ëª©ë¡
         * @returns {boolean} - ì‚¬ì „ ì‹ ê³  êµ¬ì—­ ë‚´ì— ìˆìœ¼ë©´ true
         */
        function isInPreReport(lat, lon, time, preReports) {
            const point = L.latLng(lat, lon);
            
            return preReports.some(report => {
                const center = L.latLng(report.lat, report.lon);
                const distance = center.distanceTo(point); // Leafletì˜ ê±°ë¦¬ ê³„ì‚° (ë¯¸í„°)
                const rangeMeters = report.rangeKm * 1000;
                
                // ì‹œê°„ ì¡°ê±´: ê°ì§€/ì‹ ê³  ì‹œê°„ì´ ì‚¬ì „ ì‹ ê³  ê¸°ê°„ ë‚´ì— ìˆì–´ì•¼ í•¨
                const isTimeValid = time >= report.startDate && time <= report.endDate;
                
                // ê±°ë¦¬ ì¡°ê±´: ê°ì§€/ì‹ ê³  ìœ„ì¹˜ê°€ ì‚¬ì „ ì‹ ê³  ë²”ìœ„ ë‚´ì— ìˆì–´ì•¼ í•¨
                const isLocationValid = distance <= rangeMeters;

                return isTimeValid && isLocationValid;
            });
        }

        /**
         * APIë¥¼ í˜¸ì¶œí•˜ì—¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ì‹œê°í™”
         */
        async function fetchData() {
            showMessageBox("ë°ì´í„°ë¥¼ ì§€ë„ì— ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...", 'info');
            
            try {
                // API í˜¸ì¶œ: ëª¨ë“  ë°ì´í„° í•œ ë²ˆì— ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: [HTTP ${response.status}]`);
                }
                
                const data = await response.json();
                
                const detectionData = data.detectionData || [];
                const citizenReports = data.citizenReports || [];
                const preReports = data.preReports || [];
                
                visualizeData(detectionData, citizenReports, preReports);

                showMessageBox(`âœ… ë°ì´í„° ë¡œë“œ ì™„ë£Œ. (ê°ì§€ ${detectionData.length}, ì‹ ê³  ${citizenReports.length}, ì‚¬ì „ ${preReports.length})`, 'success');

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                showMessageBox(`âŒ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message || 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'}`, 'error');
            }
        }

        /**
         * ë°ì´í„°ë¥¼ Leaflet ë§ˆì»¤ë¡œ ì‹œê°í™”
         */
        function visualizeData(detectionData, citizenReports, preReports) {
            // ê¸°ì¡´ ë§ˆì»¤/ë ˆì´ì–´ ì œê±°
            if (markers) {
                map.removeLayer(markers);
            }
            markers = L.layerGroup(); // ìƒˆë¡œìš´ ë§ˆì»¤ ê·¸ë£¹ ìƒì„±

            // ê¸°ì¡´ ì‚¬ì „ ì‹ ê³  ë²”ìœ„ ì› ì œê±°
            preReportCircles.forEach(circle => map.removeLayer(circle));
            preReportCircles = [];

            // A. ì‚¬ì „ ì‹ ê³  ë°ì´í„° (preReports) ì‹œê°í™” (ë²”ìœ„ ì›í˜• í‘œì‹œ)
            preReports.forEach(report => {
                const color = '#3b82f6'; // íŒŒë€ìƒ‰
                const circle = L.circle([report.lat, report.lon], {
                    color: color,
                    fillColor: `${color}80`, // ë°˜íˆ¬ëª…
                    fillOpacity: 0.2,
                    radius: report.rangeKm * 1000 // Kmë¥¼ Meterë¡œ ë³€í™˜
                }).bindPopup(`
                    <b>[ì‚¬ì „ ì‹ ê³  êµ¬ì—­]</b><br>
                    <b>ë²”ìœ„:</b> ${report.rangeKm} Km<br>
                    <b>ê¸°ê°„:</b> ${new Date(report.startDate).toLocaleString()} ~ ${new Date(report.endDate).toLocaleString()}
                `).addTo(map);
                preReportCircles.push(circle);
            });


            // B. ì§ì ‘ ê°ì§€ ë°ì´í„° (detectionData) ì²˜ë¦¬
            detectionData.forEach(row => {
                // ì‚¬ì „ ì‹ ê³  ì—¬ë¶€ í™•ì¸
                const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);

                // ë§ˆì»¤ ìƒ‰ìƒ ë° ì•„ì´ì½˜ ê²°ì •
                const color = isReported ? '#ff8c00' : '#dc2626'; // ì‹ ê³ ë¨: ì£¼í™©, ë¶ˆë²• ì˜ì‹¬: ë¹¨ê°•
                const icon = createSmokeIcon(color, row.smoke);

                const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                    <b>[ì§ì ‘ ê°ì§€]</b><br>
                    <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                    <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                    <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                `);
                markers.addLayer(marker);
            });

            // C. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
            citizenReports.forEach(row => {
                // ì‚¬ì „ ì‹ ê³  ì—¬ë¶€ í™•ì¸ (ì‹œë¯¼ ì‹ ê³  ìœ„ì¹˜ì™€ ì‹œê°„ ê¸°ë°˜)
                const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                
                // ë§ˆì»¤ ìƒ‰ìƒ ë° ì•„ì´ì½˜ ê²°ì •
                const color = isReported ? '#1e40af' : '#65a30d'; // ì‹ ê³ ë¨: íŒŒë‘, ë¶ˆë²• ì˜ì‹¬: ì´ˆë¡
                const icon = createTriangleIcon(color);

                const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                    <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                    <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                    <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸ”” ë‹¨ìˆœ ì‹ ê³ '}
                `);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
        }
        
        // --- 4. ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ìœ í‹¸ë¦¬í‹° ---
        function openPreReportModal() {
            const modal = document.getElementById('preReportModal');
            modal.style.display = 'flex';
            // ë§ˆì§€ë§‰ í´ë¦­ ì¢Œí‘œê°€ ìˆìœ¼ë©´ ìœ„ë„/ê²½ë„ ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
            if (lastClickedLatLng) {
                document.getElementById('preLat').value = lastClickedLatLng.lat.toFixed(6);
                document.getElementById('preLon').value = lastClickedLatLng.lng.toFixed(6);
            }
        }

        function closePreReportModal() {
            document.getElementById('preReportModal').style.display = 'none';
        }

        function openAddDetectionModal() {
            const modal = document.getElementById('addDetectionModal');
            modal.style.display = 'flex';
            // ë§ˆì§€ë§‰ í´ë¦­ ì¢Œí‘œê°€ ìˆìœ¼ë©´ ìœ„ë„/ê²½ë„ ì…ë ¥ í•„ë“œì— ì±„ìš°ê¸°
            if (lastClickedLatLng) {
                document.getElementById('detLat').value = lastClickedLatLng.lat.toFixed(6);
                document.getElementById('detLon').value = lastClickedLatLng.lng.toFixed(6);
            }
            // í˜„ì¬ ì‹œê°ìœ¼ë¡œ ì„¤ì •
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('detTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function closeAddDetectionModal() {
            document.getElementById('addDetectionModal').style.display = 'none';
        }
        
        // --- 5. ë°ì´í„° ì œì¶œ API í˜¸ì¶œ í•¨ìˆ˜ ---

        // Unix Timestamp (ms) ë³€í™˜ ìœ í‹¸ë¦¬í‹°
        function toTimestamp(dateTimeLocalString) {
            // Input format: YYYY-MM-DDTHH:MM
            return new Date(dateTimeLocalString).getTime();
        }


        /**
         * ì‚¬ì „ ì‹ ê³  ë°ì´í„° ì œì¶œ
         */
        async function submitPreReport(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('preSubmitBtn');
            submitBtn.disabled = true;

            const lat = parseFloat(document.getElementById('preLat').value);
            const lon = parseFloat(document.getElementById('preLon').value);
            const rangeKm = parseFloat(document.getElementById('preRangeKm').value);
            const startDateStr = document.getElementById('preStartDate').value;
            const endDateStr = document.getElementById('preEndDate').value;

            if (isNaN(lat) || isNaN(lon) || !startDateStr || !endDateStr) {
                showMessageBox("ìœ„ë„, ê²½ë„, ì‹œì‘/ì¢…ë£Œ ì¼ì‹œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'warning');
                submitBtn.disabled = false;
                return;
            }
            
            const startDate = toTimestamp(startDateStr);
            const endDate = toTimestamp(endDateStr);

            if (endDate <= startDate) {
                showMessageBox("ì¢…ë£Œ ì¼ì‹œëŠ” ì‹œì‘ ì¼ì‹œë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.", 'warning');
                submitBtn.disabled = false;
                return;
            }

            showMessageBox("ì‚¬ì „ ì‹ ê³  ì ‘ìˆ˜ ì¤‘...", 'info');
            
            const payload = { lat, lon, rangeKm, startDate, endDate };

            try {
                const response = await fetch('/api/add/pre', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closePreReportModal();

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`âœ… ì‚¬ì „ ì‹ ê³  ì ‘ìˆ˜ ì„±ê³µ! (ID: ${result.id})`, 'success');
                    fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessageBox(`âŒ ì‚¬ì „ ì‹ ê³  ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        /**
         * ê°ì§€ ë°ì´í„° ìˆ˜ë™ ì¶”ê°€
         */
        async function submitDetectionData(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('detSubmitBtn');
            submitBtn.disabled = true;

            const lat = parseFloat(document.getElementById('detLat').value);
            const lon = parseFloat(document.getElementById('detLon').value);
            const smoke = parseInt(document.getElementById('detSmoke').value, 10);
            const timeStr = document.getElementById('detTime').value;

            if (isNaN(lat) || isNaN(lon) || isNaN(smoke) || !timeStr) {
                showMessageBox("ìœ„ë„, ê²½ë„, ì—°ê¸°ëŸ‰, ê°ì§€ ì‹œê°ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.", 'warning');
                submitBtn.disabled = false;
                return;
            }
            
            const time = toTimestamp(timeStr);

            showMessageBox("ê°ì§€ ë°ì´í„° ì¶”ê°€ ì¤‘...", 'info');

            const payload = { lat, lon, smoke, time };

            try {
                const response = await fetch('/api/add/detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closeAddDetectionModal();

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`âœ… ê°ì§€ ë°ì´í„° ì¶”ê°€ ì„±ê³µ! (ID: ${result.id})`, 'success');
                    fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessageBox(`âŒ ë°ì´í„° ì¶”ê°€ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        // --- 6. ì§€ë„ í´ë¦­ ë° ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ì„ì‹œ í•€ ë° ì¢Œí‘œ ì €ì¥) ---
        function setupMapEvents() {
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. ê¸°ì¡´ ì„ì‹œ ë§ˆì»¤ ì œê±°
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. ìƒˆ ì„ì‹œ ë§ˆì»¤ ìƒì„± (íŒŒë€ìƒ‰ í•€) - draggable: true ì¶”ê°€
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>í´ë¦­ëœ ìœ„ì¹˜:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // ì „ì—­ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    
                    // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
                    marker.setPopupContent(`<b>ë“œë˜ê·¸ëœ ìœ„ì¹˜:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                    updateModalLatLng(position);
                });

                // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                updateModalLatLng(lastClickedLatLng);
            });
        }
        
        function updateModalLatLng(position) {
            const preModalOpen = document.getElementById('preReportModal').style.display === 'flex';
            const detModalOpen = document.getElementById('addDetectionModal').style.display === 'flex';

            if (preModalOpen) {
                document.getElementById('preLat').value = position.lat.toFixed(6);
                document.getElementById('preLon').value = position.lng.toFixed(6);
            }
            if (detModalOpen) {
                document.getElementById('detLat').value = position.lat.toFixed(6);
                document.getElementById('detLon').value = position.lng.toFixed(6);
            }
        }
        
        // --- 7. ë°ì´í„° ì „ì²´ ì‚­ì œ (ì£¼ì˜ í•„ìš”) ---

        /**
         * ë°ì´í„° ì „ì²´ ì‚­ì œ í™•ì¸
         */
        function confirmDeleteAllData() {
            // ê²½ê³  ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” ë©”ì‹œì§€ ë°•ìŠ¤ ì‚¬ìš©
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const closeBtn = box.querySelector('.message-box-close');
            
            box.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden');
            box.classList.add('bg-red-700');
            box.style.color = 'white';
            closeBtn.style.color = 'white';
            
            text.innerHTML = `
                <div class="text-xl mb-4">ğŸš¨ ê²½ê³ : ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                <div class="mb-6">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Firestore ë°ì´í„°ë² ì´ìŠ¤ì˜<br>
                'detectionData', 'citizenReports', 'preReports' ì»¬ë ‰ì…˜ì˜<br>
                ëª¨ë“  ë¬¸ì„œê°€ ì‚­ì œë©ë‹ˆë‹¤.</div>
                <button id="finalDeleteBtn" class="bg-white hover:bg-gray-200 text-red-700 font-bold py-2 px-4 rounded-lg mr-3 shadow-lg" onclick="deleteAllData()">
                    ì˜ˆ, ëª¨ë‘ ì‚­ì œí•©ë‹ˆë‹¤
                </button>
                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-lg" onclick="closeMessageBox()">
                    ì·¨ì†Œ
                </button>
            `;
            box.style.display = 'block';
            isMessageBoxOpen = true; // ìë™ ë‹«ê¸° ë°©ì§€
        }

        /**
         * ë°ì´í„° ì „ì²´ ì‚­ì œ ì‹¤í–‰
         */
        async function deleteAllData() {
            closeMessageBox(); // í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°
            showMessageBox("ë°ì´í„° ì‚­ì œ ì¤‘...", 'info');
            
            try {
                // index.jsì— êµ¬í˜„ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ API í˜¸ì¶œ
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('âœ… ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData(); // ì‚­ì œ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. ì´ˆê¸°í™” ---

        function initializeMap() {
            // ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ì§€ë„ ì´ë²¤íŠ¸ ì„¤ì •
            setupMapEvents();

            // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
            fetchData();
        }

        // --- 9. ì‹œì‘ ---
        window.onload = initializeMap;

    </script>
</body>
</html>
