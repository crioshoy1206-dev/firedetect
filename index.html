<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
        }

        .action-button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .action-button:hover { opacity: 0.9; }
        
        #btn-sensor { background-color: #3b82f6; color: white; } /* Blue */
        #btn-citizen { background-color: #22c55e; color: white; } /* Green */
        #btn-pre-report { background-color: #f59e0b; color: white; } /* Amber */

        /* ì •ë³´ ë° ìƒíƒœ í‘œì‹œ */
        .info-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .status-message {
            margin-top: 10px;
            font-size: 0.85rem;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }
        .status-message.success { background-color: #d1fae5; color: #065f46; }
        .status-message.error { background-color: #fee2e2; color: #991b1b; }
        .status-message.waiting { background-color: #fffbeb; color: #b45309; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 50px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border-radius: 8px;
            width: 90%; 
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-content label, .modal-content input { display: block; width: 100%; margin-bottom: 10px; }
        .modal-content input[type="number"], .modal-content input[type="date"], .modal-content input[type="datetime-local"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-actions button { padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ë¶ˆë²• ì†Œê° ê°ì§€ ì‹¤ì‹œê°„ ì§€ë„</h1>

    <div class="control-panel">
        <button id="btn-sensor" class="action-button" onclick="startInput('sensor')"><i class="fas fa-microchip"></i> ì§ì ‘ ê°ì§€ ê°’ ì‹œë®¬ë ˆì´ì…˜</button>
        <button id="btn-citizen" class="action-button" onclick="startInput('citizen')"><i class="fas fa-user-edit"></i> ì‹œë¯¼ ì‹ ê³ </button>
        <button id="btn-pre-report" class="action-button" onclick="startInput('pre-report')"><i class="fas fa-flag"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ </button>
    </div>

    <div id="map"></div>

    <div id="info-panel" class="info-panel">
        <p><b>ì„ íƒ ìœ„ì¹˜ (ë“œë˜ê·¸ ê°€ëŠ¥):</b></p>
        <p id="current-coords">ì§€ë„ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”.</p>
        <hr>
        <div class="legend">
            <p>â— ì§ì ‘ ê°ì§€ / â–² ì‹œë¯¼ ì‹ ê³ </p>
            <span style="color: #ff8c00;">â–  ì‹ ê³ O (ì£¼í™©ìƒ‰)</span>
            <span style="color: #dc2626;">â–  ì‹ ê³ X (ë¹¨ê°„ìƒ‰)</span>
            <span style="color: #f59e0b;">â¬¤ ì‚¬ì „ ì‹ ê³  êµ¬ì—­</span>
        </div>
    </div>
    
    <!-- ëª¨ë‹¬ UI -->
    <div id="input-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="modal-form-content"></div>
            <p id="modal-coords"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">ì·¨ì†Œ</button>
                <button id="submit-data" style="background-color: #3b82f6; color: white;">ë“±ë¡</button>
            </div>
            <div id="modal-status" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        // Leaflet ì§€ë„ ì´ˆê¸°í™”
        const map = L.map('map').setView([37.5665, 126.9780], 12); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„° ê·¸ë£¹ ì´ˆê¸°í™”
        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        // ì‚¬ì „ ì‹ ê³  êµ¬ì—­ ë ˆì´ì–´ ê·¸ë£¹ (í´ëŸ¬ìŠ¤í„°ì™€ ë³„ë„ë¡œ ê´€ë¦¬)
        const preReportLayers = L.layerGroup().addTo(map);

        let currentInputType = null;
        let selectedCoords = null;
        let tempMarker = null; 

        // DOM ìš”ì†Œ ìºì‹œ
        const currentCoordsEl = document.getElementById('current-coords');
        const modalEl = document.getElementById('input-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalFormContentEl = document.getElementById('modal-form-content');
        const modalCoordsEl = document.getElementById('modal-coords');
        const modalStatusEl = document.getElementById('modal-status');
        const submitButton = document.getElementById('submit-data');


        // ---------------------------------------------------------------------
        // 1. ì»¤ìŠ¤í…€ ì•„ì´ì½˜ íŒ©í† ë¦¬
        // ---------------------------------------------------------------------

        const createCircleIcon = (color) => L.divIcon({
            html: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="${color}" stroke="black" stroke-width="1.5"/></svg>`,
            className: 'circle-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10], 
            popupAnchor: [0, -10]
        });

        const createTriangleIcon = (color) => L.divIcon({
            html: `<svg width="20" height="20" viewBox="0 0 100 100" class="triangle-icon"><polygon points="50,10 90,90 10,90" fill="${color}" stroke="black" stroke-width="5"/></svg>`,
            className: 'triangle-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10], 
            popupAnchor: [0, -10]
        });


        // ---------------------------------------------------------------------
        // 2. ì§€ë„ í´ë¦­ ë° ë“œë˜ê·¸ ë¡œì§ (ìˆ˜ì •ë¨)
        // ---------------------------------------------------------------------

        function updateSelectedPosition(latlng) {
            const lat = latlng.lat.toFixed(6);
            const lon = latlng.lng.toFixed(6);
            selectedCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
            currentCoordsEl.innerHTML = `ìœ„ë„: ${lat}, ê²½ë„: ${lon}`;
        }

        map.on('click', (e) => {
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            updateSelectedPosition(e.latlng);

            // ì„ì‹œ ë§ˆì»¤ í‘œì‹œ ë˜ëŠ” ì—…ë°ì´íŠ¸
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            
            // ì„ì‹œ ë§ˆì»¤ ìƒì„± (ë“œë˜ê·¸ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •)
            tempMarker = L.marker(selectedCoords, {
                draggable: true, // ë“œë˜ê·¸ ê°€ëŠ¥
                icon: L.divIcon({ className: 'current-selection', html: '<i class="fas fa-map-marker-alt" style="color:#007bff; font-size:24px;"></i>' })
            }).addTo(map);

            // ë“œë˜ê·¸ ì¢…ë£Œ ì‹œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            tempMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                updateSelectedPosition(position);
            });

            // ì…ë ¥ ëª¨ë“œë¼ë©´ ëª¨ë‹¬ ì—´ê¸°
            if (currentInputType) {
                openModal(currentInputType);
                currentInputType = null; // ëª¨ë‹¬ì„ ì—´ì—ˆìœ¼ë¯€ë¡œ ì…ë ¥ ëª¨ë“œ ì¢…ë£Œ
            }
        });

        // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì…ë ¥ ëª¨ë“œ ì‹œì‘
        function startInput(type) {
            currentInputType = type;
            if (selectedCoords) {
                // ì´ë¯¸ ìœ„ì¹˜ê°€ ì„ íƒëœ ê²½ìš° ì¦‰ì‹œ ëª¨ë‹¬ ì—´ê¸°
                openModal(type);
                currentInputType = null; 
            } else {
                // ìœ„ì¹˜ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
                showCustomAlert('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ë¨¼ì € í´ë¦­í•´ ì£¼ì„¸ìš”.');
            }
        }


        // ---------------------------------------------------------------------
        // 3. ëª¨ë‹¬ ë° í¼ ìƒì„± ë¡œì§ (ì‚¬ì „ ì‹ ê³  í¼ì— datetime-local ì¶”ê°€)
        // ---------------------------------------------------------------------

        function openModal(type) {
            if (!selectedCoords) return;

            let title = '';
            let formHtml = '';
            
            modalCoordsEl.textContent = `ì„ íƒ ìœ„ì¹˜: ìœ„ë„ ${selectedCoords.lat.toFixed(6)}, ê²½ë„ ${selectedCoords.lon.toFixed(6)}`;
            
            // í¼ HTML ì •ì˜
            if (type === 'sensor') {
                title = 'ì§ì ‘ ê°ì§€ ê°’ ì‹œë®¬ë ˆì´ì…˜';
                formHtml = `
                    <label for="sensor-smoke">ì—°ê¸°ëŸ‰ (50 ì´ìƒ ê¶Œì¥):</label>
                    <input type="number" id="sensor-smoke" value="100" min="0" required>
                    <label for="sensor-temp">ì˜¨ë„ (Â°C):</label>
                    <input type="number" id="sensor-temp" value="30" min="0" required>
                    <input type="hidden" id="sensor-time" value="${Date.now()}">
                `;
            } else if (type === 'citizen') {
                title = 'ì‹œë¯¼ ì‹ ê³ ';
                formHtml = `
                    <p>ì‹ ê³  ì‹œê°„: ${new Date().toLocaleString()}</p>
                    <input type="hidden" id="citizen-time" value="${Date.now()}">
                `;
            } else if (type === 'pre-report') {
                title = 'ì†Œê° ì‚¬ì „ ì‹ ê³ ';
                // datetime-localì˜ ê¸°ë³¸ê°’ìœ¼ë¡œ í˜„ì¬ ì‹œê° ì„¤ì • (UTC ê¸°ì¤€ì´ ì•„ë‹Œ ë¡œì»¬ ì‹œê°)
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000; // Timezone offset in milliseconds
                const localISOTime = (new Date(now - offset)).toISOString().slice(0, 16);

                formHtml = `
                    <label for="pre-report-start">ì†Œê° ì‹œì‘ ë‚ ì§œ/ì‹œê°„:</label>
                    <input type="datetime-local" id="pre-report-start" value="${localISOTime}" required>
                    <label for="pre-report-end">ì†Œê° ì¢…ë£Œ ë‚ ì§œ/ì‹œê°„:</label>
                    <input type="datetime-local" id="pre-report-end" value="${localISOTime}" required>
                    <label for="pre-report-range">ì†Œê° ë°˜ê²½ (km):</label>
                    <input type="number" id="pre-report-range" value="0.5" min="0.1" step="0.1" required>
                `;
            }

            modalTitleEl.textContent = title;
            modalFormContentEl.innerHTML = formHtml;
            submitButton.onclick = () => submitData(type);
            modalStatusEl.style.display = 'none';
            modalEl.style.display = 'block';
        }

        function closeModal() {
            modalEl.style.display = 'none';
            modalStatusEl.style.display = 'none';
        }


        // ---------------------------------------------------------------------
        // 4. ë°ì´í„° ì „ì†¡ (POST ìš”ì²­) ë¡œì§ (ë³€ë™ ì—†ìŒ)
        // ---------------------------------------------------------------------

        async function submitData(type) {
            if (!selectedCoords) return;

            modalStatusEl.className = 'status-message waiting';
            modalStatusEl.textContent = 'ë°ì´í„° ë“±ë¡ ì¤‘...';
            modalStatusEl.style.display = 'block';

            let payload = { lat: selectedCoords.lat, lon: selectedCoords.lon };
            let endpoint = '';

            // í¼ ë°ì´í„° ìˆ˜ì§‘
            if (type === 'sensor') {
                const smoke = document.getElementById('sensor-smoke').value;
                const temp = document.getElementById('sensor-temp').value;
                if (!smoke || !temp) { return updateStatus('error', 'ì—°ê¸°ëŸ‰ê³¼ ì˜¨ë„ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); }

                payload = { 
                    ...payload, 
                    smoke: parseFloat(smoke), 
                    temp: parseFloat(temp), 
                    time: Date.now(),
                    humidity: 60 
                };
                endpoint = '/api/add/sensor';
            } else if (type === 'citizen') {
                payload = { ...payload, time: Date.now() };
                endpoint = '/api/add/citizen';
            } else if (type === 'pre-report') {
                const startTimeStr = document.getElementById('pre-report-start').value;
                const endTimeStr = document.getElementById('pre-report-end').value;
                const range = document.getElementById('pre-report-range').value;
                if (!startTimeStr || !endTimeStr || !range) { return updateStatus('error', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); }
                
                // ISO ë¬¸ìì—´ì„ UTC ê¸°ì¤€ìœ¼ë¡œ íŒŒì‹± í›„ getTime()ìœ¼ë¡œ Unix Milliseconds ì–»ìŒ
                const startDate = new Date(startTimeStr).getTime();
                const endDate = new Date(endTimeStr).getTime();
                
                if (endDate <= startDate) { return updateStatus('error', 'ì¢…ë£Œ ì‹œê°ì€ ì‹œì‘ ì‹œê°ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.'); }

                payload = { 
                    ...payload, 
                    startDate: startDate, 
                    endDate: endDate, 
                    rangeKm: parseFloat(range) 
                };
                endpoint = '/api/add/pre';
            } else {
                return;
            }

            // POST ìš”ì²­
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `API ë“±ë¡ ì‹¤íŒ¨ (${response.status} ${response.statusText})`;
                    
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            try {
                                const errorData = JSON.parse(errorText);
                                errorMessage = errorData.error || errorData.message || JSON.stringify(errorData);
                            } catch (e) {
                                errorMessage = errorText.substring(0, 200); 
                            }
                        } else {
                            errorMessage = response.statusText || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ';
                        }
                    } catch (e) {
                        errorMessage = `ì‘ë‹µ ë³¸ë¬¸ ì½ê¸° ì˜¤ë¥˜. ìƒíƒœ ì½”ë“œ: ${response.status}`;
                    }

                    throw new Error(errorMessage);
                }

                updateStatus('success', `${modalTitleEl.textContent}ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                setTimeout(() => {
                    closeModal();
                    loadAndDisplayData();
                }, 1000);

            } catch (error) {
                console.error('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:', error);
                updateStatus('error', `ë“±ë¡ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function updateStatus(type, message) {
            modalStatusEl.className = `status-message ${type}`;
            modalStatusEl.textContent = message;
        }

        function showCustomAlert(message) {
            let box = document.getElementById('custom-alert');
            if (!box) {
                box = document.createElement('div');
                box.id = 'custom-alert';
                box.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    padding: 20px; background: #fff; border: 1px solid #ccc; border-radius: 8px;
                    box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 9999; text-align: center;
                    min-width: 250px; font-size: 1rem;
                `;
                box.innerHTML = `<p id="alert-text" style="margin-bottom: 10px;"></p><button onclick="document.getElementById('custom-alert').style.display='none';" style="padding: 5px 15px; background-color: #dc2626; color: white; border: none; border-radius: 5px; cursor: pointer;">í™•ì¸</button>`;
                document.body.appendChild(box);
            }
            document.getElementById('alert-text').innerText = message;
            box.style.display = 'block';
        }


        // ---------------------------------------------------------------------
        // 5. ì‹œê°í™” ë¡œì§ (ì‚¬ì „ ì‹ ê³  ë²”ìœ„ í‘œì‹œ ì¶”ê°€)
        // ---------------------------------------------------------------------
        
        const isInPreReport = (lat, lon, time, preReports) => {
            const currentTime = time; 
            
            for (const report of preReports) {
                const radiusKm = report.rangeKm || 0.1;
                const centerLat = report.lat;
                const centerLon = report.lon;
                const startTime = report.startDate; 
                const endTime = report.endDate; 
                
                // ì‹œê°„ ì²´í¬
                const isWithinTime = currentTime >= startTime && currentTime <= endTime;
                if (!isWithinTime) continue;

                // Haversine ê³µì‹ (ëŒ€ëµì ì¸ ê±°ë¦¬ ê³„ì‚°)
                const R = 6371; // ì§€êµ¬ ë°˜ê²½ (km)
                const dLat = (lat - centerLat) * (Math.PI / 180);
                const dLon = (lon - centerLon) * (Math.PI / 180);

                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(centerLat * (Math.PI / 180)) * Math.cos(lat * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distanceKm = R * c;

                const isWithinRange = distanceKm <= radiusKm;
                
                if (isWithinRange) {
                    return true;
                }
            }
            return false;
        };
        
        async function loadAndDisplayData() {
            try {
                const response = await fetch('/api/data'); 
                if (!response.ok) throw new Error('Failed to fetch data from API');
                
                const allData = await response.json();
                
                const preReports = allData.preReports || [];
                const sensorData = allData.sensorData || [];
                const citizenReports = allData.citizenReports || [];
                
                // ì´ì „ ë§ˆì»¤/ë ˆì´ì–´ ì´ˆê¸°í™”
                markers.clearLayers(); 
                preReportLayers.clearLayers(); // ì‚¬ì „ ì‹ ê³  êµ¬ì—­ ì´ˆê¸°í™”

                // C. ì‚¬ì „ ì‹ ê³  ë°ì´í„° (preReports) ì‹œê°í™” (ì¶”ê°€ëœ ê¸°ëŠ¥)
                preReports.forEach(report => {
                    const radiusMeters = report.rangeKm * 1000;
                    
                    // ì› (Circle) ë ˆì´ì–´ ìƒì„±: ë°˜ê²½(ë¯¸í„°), ìƒ‰ìƒ, íˆ¬ëª…ë„ ì„¤ì •
                    const circle = L.circle([report.lat, report.lon], {
                        radius: radiusMeters,
                        color: '#f59e0b', // Amber
                        fillColor: '#fcd34d', // Light Amber
                        fillOpacity: 0.3,
                        weight: 2
                    }).addTo(preReportLayers);

                    // íŒì—… ë‚´ìš© ì„¤ì • (ì‹œê°„ ë²”ìœ„ í¬í•¨)
                    const startDateStr = new Date(report.startDate).toLocaleString('ko-KR');
                    const endDateStr = new Date(report.endDate).toLocaleString('ko-KR');

                    circle.bindPopup(`
                        <b>[ì‚¬ì „ ì‹ ê³  êµ¬ì—­]</b><br>
                        <b>ë°˜ê²½:</b> ${report.rangeKm} km<br>
                        <b>ì‹œì‘ ì‹œê°:</b> ${startDateStr}<br>
                        <b>ì¢…ë£Œ ì‹œê°:</b> ${endDateStr}
                    `);

                    // í•€ ë§ˆì»¤ë„ í•¨ê»˜ í‘œì‹œ (ì¤‘ì‹¬ì )
                    L.marker([report.lat, report.lon], {
                        icon: L.divIcon({ className: 'pre-report-center', html: '<i class="fas fa-flag" style="color:#f59e0b; font-size:18px;"></i>' })
                    }).bindPopup(`<b>ì‚¬ì „ ì‹ ê³  ì¤‘ì‹¬</b><br>ë°˜ê²½: ${report.rangeKm} km`).addTo(preReportLayers);

                });


                // A. ì§ì ‘ ê°ì§€ ë°ì´í„° (sensorData) ì²˜ë¦¬
                sensorData.forEach(row => {
                    if (row.smoke && row.smoke > 50) { 
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createCircleIcon(color);
                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[ì§ì ‘ ê°ì§€]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // B. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; 
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                        <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
            }
        }
        
        loadAndDisplayData();
        setInterval(loadAndDisplayData, 10000); 

    </script>
</body>
</html>