<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불법 소각 감지 지도</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* 모바일 대응 */
        }

        /* Custom Marker Styles */
        .custom-marker {
            font-size: 25px;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* 모달 스타일 (데이터 추가/일괄 삭제 기능에 필요) */
        #dataModal, #preReportModal, #messageBox, #confirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
            position: relative; /* 닫기 버튼을 위해 추가 */
        }
        
        .modal-content-lg {
            max-width: 500px;
            text-align: left;
        }

        .modal-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    
    <h1><i class="fas fa-smog text-red-600 mr-2"></i> 불법 소각 감지 시스템 지도</h1>
    
    <div class="control-panel">
        <button onclick="fetchData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-sync mr-2"></i> 지도 새로고침
        </button>
        
        <!-- 원본 파일의 버튼 1: 직접 감지 데이터 추가 -->
        <button onclick="showDataModal('sensor')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-microchip mr-2"></i> 직접 감지 데이터 추가
        </button>
        
        <!-- 원본 파일의 버튼 2: 시민 신고 -->
        <button onclick="showDataModal('citizen')" class="bg-yellow-500 hover:bg-yellow-700 text-gray-800 font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-user-edit mr-2"></i> 시민 신고
        </button>

        <!-- 원본 파일의 버튼 3: 사전 신고 -->
        <button onclick="showPreReportModal()" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-calendar-alt mr-2"></i> 소각 사전 신고
        </button>

        <!-- ✅ 요청 사항 2: 데이터 일괄 삭제 버튼 추가 -->
        <button id="deleteAllBtn" onclick="showConfirmDelete()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-trash-alt mr-2"></i> 데이터 일괄 소각
        </button>
        
    </div>

    <div id="map"></div>
    
    <!-- 직접 감지 / 시민 신고 데이터 추가 모달 -->
    <div id="dataModal" class="fixed hidden">
        <div class="modal-content modal-content-lg" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeDataModal()">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            
            <form id="dataForm" class="space-y-4">
                <p class="text-sm text-gray-500 mb-4">지도를 클릭하여 위치를 설정하거나, 핀을 드래그하세요.</p>
                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                        <input type="text" id="lat" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                        <input type="text" id="lon" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                </div>

                <div id="smokeSection">
                    <label for="smoke" class="block text-sm font-medium text-gray-700">연기량</label>
                    <input type="number" id="smoke" min="0" max="100" placeholder="0-100" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-700">시간 (발생 시점)</label>
                    <input type="datetime-local" id="time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                
                <button type="submit" id="submitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 mt-6">데이터 추가</button>
            </form>
        </div>
    </div>

    <!-- 사전 신고 모달 -->
    <div id="preReportModal" class="fixed hidden">
        <div class="modal-content modal-content-lg" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closePreReportModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">소각 사전 신고 등록</h2>
            <form id="preReportForm" class="space-y-4">
                <p class="text-sm text-gray-500 mb-4">지도를 클릭하여 신고 위치를 설정하세요.</p>
                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                        <input type="text" id="preLat" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                        <input type="text" id="preLon" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                </div>

                <div>
                    <label for="rangeKm" class="block text-sm font-medium text-gray-700">소각 반경 (Km)</label>
                    <input type="number" id="rangeKm" min="0.1" step="0.1" value="0.5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>

                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label for="startDate" class="block text-sm font-medium text-gray-700">시작 시간</label>
                        <input type="datetime-local" id="startDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label for="endDate" class="block text-sm font-medium text-gray-700">종료 시간</label>
                        <input type="datetime-local" id="endDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                
                <button type="submit" id="preReportSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 mt-6">사전 신고 등록</button>
            </form>
        </div>
    </div>


    <!-- 메시지 박스 (알림용 - 모든 기능에 필요) -->
    <div id="messageBox" class="fixed hidden" onclick="closeMessageBox()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="messageIcon" class="modal-icon text-blue-500"></div>
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <button onclick="closeMessageBox()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">확인</button>
        </div>
    </div>
    
    <!-- ✅ 요청 사항 2: 확인 모달 (일괄 삭제용) -->
    <div id="confirmModal" class="fixed hidden">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-icon text-red-500"><i class="fas fa-exclamation-triangle"></i></div>
            <p id="confirmText" class="text-lg font-semibold mb-4 text-red-700">⚠️ **경고**: 모든 센서, 신고, 사전 신고 데이터가 영구적으로 삭제됩니다. 계속하시겠습니까?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeConfirmBox()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow">취소</button>
                <button onclick="deleteAllData(true)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow">삭제 진행</button>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수
        let map;
        let markers = new L.FeatureGroup();
        let preReportGroup = new L.FeatureGroup();
        let tempMarker = null; // 임시로 클릭된 위치를 표시하는 마커
        let lastClickedLatLng = null; // 마지막으로 클릭된 좌표 저장
        let currentDataType = null; // 현재 열린 모달의 데이터 타입 ('sensor' 또는 'citizen')

        // --- 1. 유틸리티 함수 (마커/아이콘) ---

        // 마커 아이콘 생성 함수 (센서: 사각형, 신고: 삼각형)
        function createDivIcon(html, className, color) {
            return L.divIcon({
                className: `custom-marker ${className}`,
                html: `<div style="color: ${color};">${html}</div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            });
        }
        
        function createSquareIcon(color) {
            // 연기 감지 (사각형)
            return createDivIcon('<i class="fas fa-square-full"></i>', 'square-icon', color);
        }

        function createTriangleIcon(color) {
            // 시민 신고 (삼각형)
            return createDivIcon('<i class="fas fa-caret-up"></i>', 'triangle-icon', color);
        }

        // --- 2. 데이터 처리 로직 ---

        // 사전 신고 범위 내인지 확인하는 헬퍼 함수
        function isInPreReport(lat, lon, time, preReports) {
            const currentPoint = L.latLng(lat, lon);
            const currentTime = time;

            return preReports.some(report => {
                const centerPoint = L.latLng(report.lat, report.lon);
                const rangeMeters = (report.rangeKm || 0.1) * 1000; 
                
                // 시간 조건 확인
                const isTimeValid = currentTime >= report.startDate && currentTime <= report.endDate;
                
                // 거리 조건 확인 (미터 단위)
                const distance = currentPoint.distanceTo(centerPoint);
                const isDistanceValid = distance <= rangeMeters;

                return isTimeValid && isDistanceValid;
            });
        }

        async function fetchData() {
            try {
                // 데이터 로딩 중 표시
                document.querySelector('.control-panel button:first-child').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 로딩 중...';

                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const { sensorData, citizenReports, preReports } = await response.json();
                
                renderData(sensorData, citizenReports, preReports);

            } catch (error) {
                console.error('데이터 로딩 실패:', error);
                if (typeof showMessageBox === 'function') {
                    showMessageBox(`데이터를 불러오는데 실패했습니다. 서버 상태(Vercel 배포)를 확인하세요: ${error.message}`, 'error');
                }
            } finally {
                // 로딩 완료 후 버튼 복구
                document.querySelector('.control-panel button:first-child').innerHTML = '<i class="fas fa-sync mr-2"></i> 지도 새로고침';
            }
        }

        function renderData(sensorData, citizenReports, preReports) {
            try {
                // 기존 마커 및 원 초기화
                markers.clearLayers();
                preReportGroup.clearLayers();
                
                // A. 사전 신고 데이터 (preReports) 처리 (범위 표시)
                preReports.forEach(row => {
                    // ✅ 요청 사항 1: 소각 정보 범위를 초록색으로 변경
                    L.circle([row.lat, row.lon], {
                        color: '#10b981',      /* 초록색 테두리 (emerald-600) */
                        fillColor: '#34d399',   /* 초록색 채우기 (emerald-400) */
                        fillOpacity: 0.2,
                        radius: (row.rangeKm || 0.1) * 1000 // KM to meters, 안전을 위해 기본값 0.1km
                    }).bindPopup(`
                        <b>[사전 신고]</b><br>
                        <b>시작:</b> ${new Date(row.startDate).toLocaleString()}<br>
                        <b>종료:</b> ${new Date(row.endDate).toLocaleString()}<br>
                        <b>반경:</b> ${row.rangeKm || 0.1} km
                    `).addTo(preReportGroup);
                });

                map.addLayer(preReportGroup); // 사전 신고 원 먼저 지도에 추가

                // B. 센서 데이터 (sensorData) 처리
                sensorData.forEach(row => {
                    if (row.lat && row.lon) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        const color = isReported ? '#ff8c00' : '#dc2626'; // 신고됨: 주황색, 미신고: 빨간색
                        const icon = createSquareIcon(color);
                        
                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[직접 감지]</b><br>
                            <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>연기량:</b> ${row.smoke}<br>
                            <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // C. 시민 신고 데이터 (citizenReports) 처리
                citizenReports.forEach(row => {
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; // 신고됨: 주황색, 미신고: 빨간색
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[시민 신고]</b><br>
                        <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('데이터 로딩 및 시각화 오류:', error);
            }
        }
        
        // --- 3. 데이터 추가 모달 로직 (원본 복원) ---
        
        function showDataModal(type) {
            currentDataType = type;
            const modal = document.getElementById('dataModal');
            const title = document.getElementById('modalTitle');
            const smokeSection = document.getElementById('smokeSection');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!lastClickedLatLng) {
                showMessageBox('지도에서 위치를 먼저 클릭하거나 드래그하여 지정하세요.', 'info');
                return;
            }

            // 제목 설정 및 필드 표시/숨김
            if (type === 'sensor') {
                title.textContent = '직접 감지 데이터 추가';
                smokeSection.style.display = 'block';
                document.getElementById('smoke').setAttribute('required', 'required');
                submitBtn.textContent = '직접 감지 데이터 추가';
                submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else if (type === 'citizen') {
                title.textContent = '시민 신고 등록';
                smokeSection.style.display = 'none';
                document.getElementById('smoke').removeAttribute('required');
                submitBtn.textContent = '시민 신고 등록';
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            }

            // 좌표 입력
            document.getElementById('lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('lon').value = lastClickedLatLng.lng.toFixed(6);
            
            // 현재 시간 설정
            const now = new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('time').value = now;

            modal.style.display = 'flex';
        }

        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
            // 모달 닫을 때 임시 마커 제거
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
                lastClickedLatLng = null;
            }
        }
        
        document.getElementById('dataForm').addEventListener('submit', handleDataSubmit);

        async function handleDataSubmit(e) {
            e.preventDefault();

            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            const smoke = document.getElementById('smoke').value;
            const timeISO = document.getElementById('time').value;

            // ISO 시간을 Unix Timestamp로 변환
            const time = new Date(timeISO).getTime(); 

            if (!lat || !lon || !time) {
                showMessageBox('위치, 시간을 모두 입력해야 합니다.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 저장 중...';
            
            closeDataModal();
            showMessageBox('데이터 저장 중...', 'info');

            try {
                let url;
                let payload = { lat: parseFloat(lat), lon: parseFloat(lon), time: time };

                if (currentDataType === 'sensor') {
                    if (!smoke) {
                        showMessageBox('직접 감지는 연기량을 입력해야 합니다.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }
                    url = '/api/add/sensor';
                    payload.smoke = parseInt(smoke);
                } else if (currentDataType === 'citizen') {
                    url = '/api/add/citizen';
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                closeMessageBox(); 

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`✅ 데이터 추가 성공! (ID: ${result.id})`, 'success');
                    fetchData(); // 성공 후 지도 새로고침
                } else {
                    let errorDetails = `[HTTP Status: ${response.status}] 서버 오류`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || errorDetails;
                    } catch (e) {
                        errorDetails = `[HTTP Status: ${response.status}] 서버 응답을 읽을 수 없습니다. Vercel 로그를 확인하세요.`;
                    }
                    showMessageBox(`❌ 데이터 추가 실패: ${errorDetails}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("❌ 네트워크 연결 오류: 서버와 통신할 수 없습니다.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = (currentDataType === 'sensor') ? '직접 감지 데이터 추가' : '시민 신고 등록';
            }
        }
        
        // --- 4. 사전 신고 모달 로직 (원본 복원) ---
        
        function showPreReportModal() {
            const modal = document.getElementById('preReportModal');
            
            if (!lastClickedLatLng) {
                showMessageBox('지도에서 위치를 먼저 클릭하거나 드래그하여 지정하세요.', 'info');
                return;
            }

            document.getElementById('preLat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('preLon').value = lastClickedLatLng.lng.toFixed(6);
            
            // 현재 시간으로 시작/종료 시간 초기화
            const now = new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('startDate').value = now;
            document.getElementById('endDate').value = now;

            modal.style.display = 'flex';
        }

        function closePreReportModal() {
            document.getElementById('preReportModal').style.display = 'none';
            // 모달 닫을 때 임시 마커 제거
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
                lastClickedLatLng = null;
            }
        }

        document.getElementById('preReportForm').addEventListener('submit', handlePreReportSubmit);

        async function handlePreReportSubmit(e) {
            e.preventDefault();

            const lat = document.getElementById('preLat').value;
            const lon = document.getElementById('preLon').value;
            const rangeKm = document.getElementById('rangeKm').value;
            const startDateISO = document.getElementById('startDate').value;
            const endDateISO = document.getElementById('endDate').value;

            const startDate = new Date(startDateISO).getTime();
            const endDate = new Date(endDateISO).getTime();

            if (!lat || !lon || !startDate || !endDate || !rangeKm) {
                showMessageBox('모든 필드를 입력해야 합니다.', 'error');
                return;
            }

            if (startDate >= endDate) {
                showMessageBox('시작 시간은 종료 시간보다 빨라야 합니다.', 'error');
                return;
            }

            const submitBtn = document.getElementById('preReportSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> 등록 중...';
            
            closePreReportModal();
            showMessageBox('사전 신고 등록 중...', 'info');

            try {
                const url = '/api/add/pre';
                const payload = { 
                    lat: parseFloat(lat), 
                    lon: parseFloat(lon), 
                    startDate: startDate, 
                    endDate: endDate, 
                    rangeKm: parseFloat(rangeKm)
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closeMessageBox(); 

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`✅ 사전 신고 등록 성공! (ID: ${result.id})`, 'success');
                    fetchData(); // 성공 후 지도 새로고침
                } else {
                    let errorDetails = `[HTTP Status: ${response.status}] 서버 오류`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || errorDetails;
                    } catch (e) {
                        errorDetails = `[HTTP Status: ${response.status}] 서버 응답을 읽을 수 없습니다.`;
                    }
                    showMessageBox(`❌ 사전 신고 등록 실패: ${errorDetails}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("❌ 네트워크 연결 오류: 서버와 통신할 수 없습니다.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '사전 신고 등록';
            }
        }
        
        // --- 5. 지도 클릭 및 드래그 이벤트 (임시 핀 및 좌표 저장) ---
        map.on('click', (e) => {
            lastClickedLatLng = e.latlng;

            // 1. 기존 임시 마커 제거
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }

            // 2. 새 임시 마커 생성 (파란색 핀) - draggable: true 추가
            const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
            tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
            tempMarker.bindPopup(`<b>클릭된 위치:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
            
            // 3. 드래그 이벤트 리스너 추가
            tempMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                lastClickedLatLng = position; // 전역 좌표 업데이트
                
                // 팝업 내용 업데이트
                marker.setPopupContent(`<b>드래그된 위치:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                // 모달이 열려있는 경우, 좌표 필드 업데이트
                if (document.getElementById('dataModal').style.display === 'flex') {
                    document.getElementById('lat').value = position.lat.toFixed(6);
                    document.getElementById('lon').value = position.lng.toFixed(6);
                } else if (document.getElementById('preReportModal').style.display === 'flex') {
                    document.getElementById('preLat').value = position.lat.toFixed(6);
                    document.getElementById('preLon').value = position.lng.toFixed(6);
                }
            });
        });
        
        // --- 6. 유틸리티 모달 로직 (메시지/확인) ---

        function showMessageBox(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');
            
            messageText.textContent = message;
            
            let iconClass = '';
            let iconColor = '';

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle';
                    iconColor = 'text-red-500';
                    break;
                default: // info
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-blue-500';
            }
            
            messageIcon.innerHTML = `<i class="${iconClass} ${iconColor}"></i>`;
            messageBox.style.display = 'flex';
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }

        // --- 7. 데이터 일괄 삭제 기능 로직 (추가 요청 사항) ---
        
        function showConfirmDelete() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmBox() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        async function deleteAllData(confirmed) {
            closeConfirmBox();

            if (!confirmed) return;

            showMessageBox("데이터 삭제 중...", 'info');
            
            try {
                // index.js에 구현된 모든 데이터 삭제 API 호출
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('✅ 데이터베이스의 모든 데이터가 성공적으로 삭제되었습니다.', 'success');
                    fetchData(); // 삭제 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 삭제 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error('삭제 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 삭제에 실패했습니다.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. 초기화 ---

        function initializeMap() {
            // 서울 시청을 중심으로 지도 초기화
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 초기 데이터 로드
            fetchData();
        }

        window.onload = initializeMap;

    </script>
</body>
</html>
