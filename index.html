<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        }

        /* Custom Marker Styles */
        .custom-marker {
            font-size: 25px;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* Message Box / Modal Styles (ì¶”ê°€) */
        #messageBox, #confirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    
    <h1><i class="fas fa-smog text-red-600 mr-2"></i> ë¶ˆë²• ì†Œê° ê°ì§€ ì‹œìŠ¤í…œ ì§€ë„</h1>
    
    <div class="control-panel">
        <button onclick="fetchData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-sync mr-2"></i> ì§€ë„ ìƒˆë¡œê³ ì¹¨
        </button>
        <a href="./citizen_report.html" target="_blank" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-fire mr-2"></i> ì†Œê° ì‹ ê³ /ë“±ë¡
        </a>
        
        <!-- ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´„ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
        <button id="deleteAllBtn" onclick="showConfirmDelete()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-trash-alt mr-2"></i> ë°ì´í„°ë² ì´ìŠ¤ ì¼ê´„ ì‚­ì œ
        </button>
    </div>

    <div id="map"></div>
    
    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ (ì•Œë¦¼ìš© - ì¶”ê°€) -->
    <div id="messageBox" class="fixed hidden" onclick="closeMessageBox()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="messageIcon" class="modal-icon text-blue-500"></div>
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <button onclick="closeMessageBox()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">í™•ì¸</button>
        </div>
    </div>
    
    <!-- í™•ì¸ ëª¨ë‹¬ (ì‚­ì œìš© - ì¶”ê°€) -->
    <div id="confirmModal" class="fixed hidden">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-icon text-red-500"><i class="fas fa-exclamation-triangle"></i></div>
            <p id="confirmText" class="text-lg font-semibold mb-4 text-red-700">âš ï¸ **ê²½ê³ **: ëª¨ë“  ì„¼ì„œ, ì‹ ê³ , ì‚¬ì „ ì‹ ê³  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeConfirmBox()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow">ì·¨ì†Œ</button>
                <button onclick="deleteAllData(true)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow">ì‚­ì œ ì§„í–‰</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let markers = new L.FeatureGroup(); // ì„¼ì„œ ë° ì‹œë¯¼ ì‹ ê³  ë§ˆì»¤ ê·¸ë£¹
        let preReportGroup = new L.FeatureGroup(); // ì‚¬ì „ ì‹ ê³  ì› ê·¸ë£¹

        // --- 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ëª¨ë‹¬, ì•„ì´ì½˜ ë“± - ì‚­ì œ ê¸°ëŠ¥ ê´€ë ¨ ì¶”ê°€) ---

        function showMessageBox(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');
            
            messageText.textContent = message;
            
            let iconClass = '';
            let iconColor = '';

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle';
                    iconColor = 'text-red-500';
                    break;
                default: // info
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-blue-500';
            }
            
            messageIcon.innerHTML = `<i class="${iconClass} ${iconColor}"></i>`;
            messageBox.style.display = 'flex';
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }

        function showConfirmDelete() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmBox() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        // ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜ (ì„¼ì„œ: ì‚¬ê°í˜•, ì‹ ê³ : ì‚¼ê°í˜•)
        function createDivIcon(html, className, color) {
            return L.divIcon({
                className: `custom-marker ${className}`,
                html: `<div style="color: ${color};">${html}</div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            });
        }
        
        function createSquareIcon(color) {
            // ì—°ê¸° ê°ì§€ (ì‚¬ê°í˜•)
            return createDivIcon('<i class="fas fa-square-full"></i>', 'square-icon', color);
        }

        function createTriangleIcon(color) {
            // ì‹œë¯¼ ì‹ ê³  (ì‚¼ê°í˜•)
            return createDivIcon('<i class="fas fa-caret-up"></i>', 'triangle-icon', color);
        }

        // --- 2. ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ---

        // ì‚¬ì „ ì‹ ê³  ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function isInPreReport(lat, lon, time, preReports) {
            const currentPoint = L.latLng(Number(lat), Number(lon));
            const currentTime = Number(time);

            return preReports.some(report => {
                const centerPoint = L.latLng(Number(report.lat), Number(report.lon));
                // NaN ë°©ì§€ë¥¼ ìœ„í•´ rangeKmì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ 0.1km (100m) ì‚¬ìš©
                const rangeMeters = Number(report.rangeKm || 0.1) * 1000; 
                
                // ì‹œê°„ ì¡°ê±´ í™•ì¸
                const isTimeValid = currentTime >= Number(report.startDate) && currentTime <= Number(report.endDate);
                
                // ê±°ë¦¬ ì¡°ê±´ í™•ì¸ (ë¯¸í„° ë‹¨ìœ„)
                const distance = currentPoint.distanceTo(centerPoint);
                const isDistanceValid = distance <= rangeMeters;

                return isTimeValid && isDistanceValid;
            });
        }

        async function fetchData() {
            try {
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const { sensorData, citizenReports, preReports } = await response.json();
                
                renderData(sensorData, citizenReports, preReports);

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ë©”ì‹œì§€ ë°•ìŠ¤ í˜¸ì¶œ ì¶”ê°€
                showMessageBox(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœ(Vercel ë°°í¬)ë¥¼ í™•ì¸í•˜ì„¸ìš”: ${error.message}`, 'error');
            }
        }

        function renderData(sensorData, citizenReports, preReports) {
            try {
                // ê¸°ì¡´ ë§ˆì»¤ ë° ì› ì´ˆê¸°í™”
                markers.clearLayers();
                preReportGroup.clearLayers();
                
                // A. ì‚¬ì „ ì‹ ê³  ë°ì´í„° (preReports) ì²˜ë¦¬ (ë²”ìœ„ í‘œì‹œ)
                preReports.forEach(row => {
                    // ğŸš¨ ì†Œê° ì •ë³´ ë²”ìœ„ë¥¼ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½
                    L.circle([Number(row.lat), Number(row.lon)], {
                        color: '#10b981',      /* ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬ (emerald-600) */
                        fillColor: '#34d399',   /* ì´ˆë¡ìƒ‰ ì±„ìš°ê¸° (emerald-400) */
                        fillOpacity: 0.2,
                        radius: Number(row.rangeKm || 0.1) * 1000 // KM to meters, ì•ˆì „ì„ ìœ„í•´ ê¸°ë³¸ê°’ 0.1km
                    }).bindPopup(`
                        <b>[ì‚¬ì „ ì‹ ê³ ]</b><br>
                        <b>ì‹œì‘:</b> ${new Date(Number(row.startDate)).toLocaleString()}<br>
                        <b>ì¢…ë£Œ:</b> ${new Date(Number(row.endDate)).toLocaleString()}<br>
                        <b>ë°˜ê²½:</b> ${Number(row.rangeKm || 0.1).toFixed(2)} km
                    `).addTo(preReportGroup);
                });

                map.addLayer(preReportGroup); // ì‚¬ì „ ì‹ ê³  ì› ë¨¼ì € ì§€ë„ì— ì¶”ê°€

                // B. ì„¼ì„œ ë°ì´í„° (sensorData) ì²˜ë¦¬
                sensorData.forEach(row => {
                    if (row.lat && row.lon) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        // ì‹ ê³ ë¨: ì£¼í™©ìƒ‰, ë¯¸ì‹ ê³ : ë¹¨ê°„ìƒ‰ (ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€)
                        const color = isReported ? '#f97316' : '#dc2626'; 
                        const icon = createSquareIcon(color);
                        
                        const marker = L.marker([Number(row.lat), Number(row.lon)], { icon: icon }).bindPopup(`
                            <b>[ì§ì ‘ ê°ì§€]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(Number(row.time)).toLocaleString()}<br>
                            <b>ì—°ê¸°ëŸ‰:</b> ${Number(row.smoke).toFixed(2)}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // C. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    // ì‹ ê³ ë¨: ì£¼í™©ìƒ‰, ë¯¸ì‹ ê³ : ì§„í•œ ë¹¨ê°• (ê¸°ì¡´ ìƒ‰ìƒ ìœ ì§€)
                    const color = isReported ? '#f97316' : '#b91c1c'; 
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([Number(row.lat), Number(row.lon)], { icon: icon }).bindPopup(`
                        <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                        <b>ì‹œê°„:</b> ${new Date(Number(row.time)).toLocaleString()}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
                showMessageBox('ë°ì´í„° ì‹œê°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        // --- 3. ë°ì´í„° ì¼ê´„ ì‚­ì œ ê¸°ëŠ¥ (ì¶”ê°€) ---

        async function deleteAllData(confirmed) {
            closeConfirmBox();

            if (!confirmed) return;

            showMessageBox("ë°ì´í„° ì‚­ì œ ì¤‘...", 'info');
            
            try {
                // index.jsì— êµ¬í˜„ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ API í˜¸ì¶œ
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('âœ… ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData(); // ì‚­ì œ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({})); // JSON íŒŒì‹± ì˜¤ë¥˜ ì˜¤ë¥˜ ì²˜ë¦¬
                    showMessageBox(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }


        // --- 4. ì´ˆê¸°í™” ---

        function initializeMap() {
            // ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            fetchData();
        }

        window.onload = initializeMap;

    </script>
</body>
</html>
