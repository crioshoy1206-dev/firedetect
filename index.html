<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { 
            flex-grow: 1; 
            width: 100%; 
            z-index: 0; 
            position: relative; /* ë²”ë¡€ë¥¼ í¬í•¨í•˜ê¸° ìœ„í•´ relative ì„¤ì • */
        }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none; /* for <a> tag */
            color: white;
            font-size: 0.9rem;
        }
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        /* [ìˆ˜ì •] ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .action-btn.primary { background-color: #059669; } /* Green for Add Direct Data */
        .action-btn.secondary { background-color: #f59e0b; } /* Amber for Report */
        .action-btn.success { background-color: #10b981; } /* Green for Pre-Report */
        .action-btn.danger { background-color: #dc2626; } /* Red for Delete All */

        /* Custom Marker Icon Styles */
        .circle-icon {
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .triangle-icon {
            /* Using a div and Font Awesome for a distinctive pin look */
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            color: white;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border-radius: 50%;
        }

        /* ì„ì‹œ í•€ ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
        .temp-pin-icon {
            font-size: 24px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            color: #1e40af; /* íŒŒë€ìƒ‰ */
        }
        
        /* MessageBox Styles */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
            min-width: 300px;
            font-weight: bold;
            display: none;
            color: #333;
        }

        #messageBox.info { background-color: #bfdbfe; border: 2px solid #3b82f6; }
        #messageBox.success { background-color: #d1fae5; border: 2px solid #10b981; }
        #messageBox.error { background-color: #fee2e2; border: 2px solid #ef4444; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
            /* [ìˆ˜ì •] ì§ì ‘ ê°ì§€ ëª¨ë‹¬ í—¤ë” ìƒ‰ìƒ ë³€ê²½ */
            color: #059669; 
            border-bottom: 2px solid #d1fae5;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4b5563;
            font-size: 0.9rem;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .modal-content button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            /* [ìˆ˜ì •] ì§ì ‘ ê°ì§€ ëª¨ë‹¬ ë²„íŠ¼ ìƒ‰ìƒ ë³€ê²½ */
            background-color: #059669;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-content button:hover:not(:disabled) {
            background-color: #047857;
        }
        .modal-content button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover,
        .close:focus {
            color: #333;
            text-decoration: none;
        }

        /* --- New Legend Styles (ë²”ë¡€ ìŠ¤íƒ€ì¼) --- */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000; /* Ensure it's above the map */
            max-width: 250px;
            line-height: 1.6;
        }
        .legend h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .legend-icon {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        /* Icon Shapes */
        .legend-icon.circle {
            border-radius: 50%;
        }
        .legend-icon.triangle {
            width: 0;
            height: 0;
            background: none; /* No background needed for CSS triangle */
            box-shadow: none;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            /* Color is set via specific class */
            border-bottom-width: 14px;
            border-bottom-style: solid;
        }
        .legend-icon.square {
            border-radius: 4px;
            box-shadow: none;
            color: inherit; /* Inherit color for the pin icon */
            font-size: 1.2rem;
            width: auto;
            height: auto;
        }
        /* Icon Colors */
        .legend-icon.red { background-color: #dc2626; border-bottom-color: #dc2626; }
        .legend-icon.orange { background-color: #ff8c00; border-bottom-color: #ff8c00; }
        .legend-icon.blue { color: #1e40af; } /* Pin icon color */

        /* Pre-Report Area Visual */
        .legend-icon.area {
             width: 14px;
             height: 14px;
             border: 2px solid #10b981; /* Green border */
             background-color: rgba(16, 185, 129, 0.3); /* Transparent Green fill */
             border-radius: 50%;
             box-shadow: none;
        }
    </style>
</head>
<body>
    <h1>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„ (Illegal Burning Detection Map)</h1>
    <div class="control-panel">
        <!-- [ìˆ˜ì •] ë²„íŠ¼ ì´ë¦„ ë° ID ë³€ê²½ -->
        <button id="addDirectDataBtn" class="action-btn primary"><i class="fas fa-microchip"></i> ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€</button>
        <a href="citizen_report.html" class="action-btn secondary"><i class="fas fa-bullhorn"></i> ì‹ ê³ í•˜ê¸°</a>
        <button id="addPreReportBtn" class="action-btn success"><i class="fas fa-calendar-check"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ </button>
        <button id="deleteAllBtn" class="action-btn danger"><i class="fas fa-trash-alt"></i> ë°ì´í„° ëª¨ë‘ ì‚­ì œ (Admin)</button>
    </div>

    <div id="map">
        <!-- ì§€ë„ ë ˆì „ë“œ (ë²”ë¡€) -->
        <div class="legend">
            <h3>ì§€ë„ ë²”ë¡€ (Legend)</h3>
            
            <!-- A. ì§ì ‘ ê°ì§€ (Direct Detection - Circle) -->
            <div class="legend-item">
                <div class="legend-icon circle red"></div>
                ì§ì ‘ ê°ì§€ (ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬)
            </div>
            <div class="legend-item">
                <div class="legend-icon circle orange"></div>
                ì§ì ‘ ê°ì§€ (âœ… ì‚¬ì „ ì‹ ê³ ë¨)
            </div>

            <!-- B. ì‹œë¯¼ ì‹ ê³  (Citizen Report - Triangle) -->
            <div class="legend-item">
                <div class="legend-icon triangle red"></div>
                ì‹œë¯¼ ì‹ ê³  (ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬)
            </div>
            <div class="legend-item">
                <div class="legend-icon triangle orange"></div>
                ì‹œë¯¼ ì‹ ê³  (âœ… ì‚¬ì „ ì‹ ê³ ë¨)
            </div>

            <!-- C. ì‚¬ì „ ì‹ ê³  êµ¬ì—­ (Pre-Report Area - L.Circle) -->
            <div class="legend-item">
                <div class="legend-icon area"></div>
                ì‚¬ì „ ì‹ ê³  êµ¬ì—­ (ë°˜ê²½)
            </div>

            <!-- D. ì§€ë„ í´ë¦­ ìœ„ì¹˜ (Temporary Pin) -->
            <div class="legend-item">
                <div class="legend-icon square blue"><i class="fas fa-thumbtack"></i></div>
                ì„ì‹œ ìœ„ì¹˜ í•€ (í´ë¦­/ë“œë˜ê·¸)
            </div>
        </div>
    </div>

    <!-- [ì¶”ê°€] ì§ì ‘ ê°ì§€ ë°ì´í„° ì…ë ¥ ëª¨ë‹¬ (Direct Data Input Modal) -->
    <div id="directDataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDirectDataModal()">&times;</span>
            <h2><i class="fas fa-fire-alt"></i> ì§ì ‘ ê°ì§€ ë°ì´í„° ì…ë ¥</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #6b7280;">
                ì„ íƒëœ ìœ„ì¹˜ì— ëŒ€í•œ ì˜¨ë„ì™€ ì—°ê¸°ëŸ‰ì„ ì…ë ¥í•©ë‹ˆë‹¤.
            </p>
            <form id="directDataForm">
                <label for="directLat">ìœ„ë„ (Latitude):</label>
                <input type="text" id="directLat" name="directLat" required readonly>
                
                <label for="directLon">ê²½ë„ (Longitude):</label>
                <input type="text" id="directLon" name="directLon" required readonly>

                <label for="temperature">ì˜¨ë„ (Â°C):</label>
                <!-- ì˜¨ë„ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
                <input type="number" id="temperature" name="temperature" placeholder="ì˜¨ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 50.5)" step="0.1" min="0" required>

                <label for="smokeLevel">ì—°ê¸°ëŸ‰ (0-100):</label>
                <!-- ì—°ê¸°ëŸ‰ ì…ë ¥ í•„ë“œ ì¶”ê°€ -->
                <input type="number" id="smokeLevel" name="smokeLevel" placeholder="ì—°ê¸°ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš” (0-100)" min="0" max="100" required>

                <button type="submit" id="directDataSubmitBtn"><i class="fas fa-upload"></i> ê°ì§€ ë°ì´í„° ë“±ë¡</button>
            </form>
        </div>
    </div>
    
    <!-- ì†Œê° ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ (Pre-Report Modal) -->
    <div id="preReportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreReportModal()">&times;</span>
            <h2><i class="fas fa-calendar-check"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ </h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #6b7280;">
                ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„ íƒí•˜ê³  ì†Œê° ì˜ˆì • ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.
            </p>
            <form id="preReportForm">
                <label for="preLat">ìœ„ë„ (Latitude):</label>
                <input type="text" id="preLat" name="preLat" required readonly>
                
                <label for="preLon">ê²½ë„ (Longitude):</label>
                <input type="text" id="preLon" name="preLon" required readonly>

                <label for="preStartDate">ì‹œì‘ì¼ì‹œ (Start Date/Time):</label>
                <input type="datetime-local" id="preStartDate" name="preStartDate" required>

                <label for="preEndDate">ì¢…ë£Œì¼ì‹œ (End Date/Time):</label>
                <input type="datetime-local" id="preEndDate" name="preEndDate" required>

                <label for="preRangeKm">ì˜í–¥ ë°˜ê²½ (Km):</label>
                <input type="number" id="preRangeKm" name="preRangeKm" value="0.1" min="0.01" step="0.01" required>

                <button type="submit" id="preReportSubmitBtn"><i class="fas fa-upload"></i> ì‹ ê³  ë“±ë¡</button>
            </form>
        </div>
    </div>

    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="messageBox"></div>

    <script>
        // --- 1. ì „ì—­ ë³€ìˆ˜ ì„¤ì • ---
        let map;
        let markers = new L.LayerGroup();
        let preReportsCircles = new L.LayerGroup(); // ì‚¬ì „ ì‹ ê³  êµ¬ì—­ í‘œì‹œìš©
        let lastClickedLatLng = null; // ë§ˆì§€ë§‰ í´ë¦­ëœ ì¢Œí‘œ ì €ì¥
        let tempMarker = null; // ì§€ë„ í´ë¦­ ì‹œ ì„ì‹œ ë§ˆì»¤ ì €ì¥

        // --- 2. Leaflet Custom Icon ìƒì„± í•¨ìˆ˜ (DivIcon ì‚¬ìš©) ---
        
        // ğŸ› ï¸ ì„ì‹œ í•€ ë° ì¼ë°˜ ë§ˆì»¤ì— ì‚¬ìš©ë˜ëŠ” ê¸°ë³¸ DivIcon ìƒì„± í•¨ìˆ˜
        function createDivIcon(htmlContent, className, color) {
            return L.divIcon({
                // htmlContentë¥¼ í´ë˜ìŠ¤ ë‚´ë¶€ê°€ ì•„ë‹Œ, ì§ì ‘ DivIconì˜ HTMLë¡œ ì‚¬ìš© (ì´ì „ í…œí”Œë¦¿ê³¼ ì¶©ëŒ ë°©ì§€)
                html: `<div class="${className}" style="color: ${color};">${htmlContent}</div>`,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [0, 24], // í•€ì˜ ì•„ë˜ìª½ ëì„ ì¢Œí‘œì— ë§ì¶¤
                popupAnchor: [10, -20]
            });
        }
        
        // ì§ì ‘ ê°ì§€ìš© ì›í˜• ì•„ì´ì½˜ ìƒì„± (ì‹¤ì œ ë§ˆì»¤ ë Œë”ë§ì— ì‚¬ìš©)
        function createCircleIcon(color) {
            return L.divIcon({
                html: `<div class="circle-icon" style="background-color: ${color};">S</div>`,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -10]
            });
        }

        // ì‹œë¯¼ ì‹ ê³ ìš© ì•„ì´ì½˜ (í•€ ëª¨ì–‘ìœ¼ë¡œ ëŒ€ì²´)
        function createTriangleIcon(color) {
             return L.divIcon({
                html: `<div class="triangle-icon" style="background-color: ${color};"><i class="fas fa-map-pin"></i></div>`,
                className: 'custom-div-icon',
                iconSize: [24, 30],
                iconAnchor: [12, 30],
                popupAnchor: [0, -25]
            });
        }

        // --- 3. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ê±°ë¦¬ ë° ì‹œê°„ ë¹„êµ) ---

        /**
         * ë‘ ì¢Œí‘œ ê°„ì˜ ê±°ë¦¬ë¥¼ í‚¬ë¡œë¯¸í„°(Km) ë‹¨ìœ„ë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (í‚¬ë¡œë¯¸í„°)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // ê±°ë¦¬ (Km)
        }

        /**
         * ê°ì§€/ì‹ ê³  ë°ì´í„°ê°€ ì‚¬ì „ ì‹ ê³  êµ¬ì—­ ë° ì‹œê°„ ë²”ìœ„ ë‚´ì— ìˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
         */
        function isInPreReport(lat, lon, time, preReports) {
            if (!Array.isArray(preReports) || preReports.length === 0) {
                return false;
            }
            
            return preReports.some(pre => {
                const distance = calculateDistance(lat, lon, pre.lat, pre.lon);
                const isWithinRange = distance <= pre.rangeKm;
                const isWithinTime = time >= pre.startDate && time <= pre.endDate;
                
                return isWithinRange && isWithinTime;
            });
        }

        // --- 4. ë©”ì‹œì§€ ë°•ìŠ¤ ë° ëª¨ë‹¬ ì œì–´ í•¨ìˆ˜ ---

        function showMessageBox(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = ''; // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
            box.classList.add(type);
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 4000); // 4ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }
        
        // [ì¶”ê°€] ì§ì ‘ ê°ì§€ ë°ì´í„° ëª¨ë‹¬ ì œì–´
        const directDataModal = document.getElementById('directDataModal');
        const directLatInput = document.getElementById('directLat');
        const directLonInput = document.getElementById('directLon');
        const directDataSubmitBtn = document.getElementById('directDataSubmitBtn');

        function openDirectDataModal() {
             if (lastClickedLatLng) {
                directLatInput.value = lastClickedLatLng.lat.toFixed(6);
                directLonInput.value = lastClickedLatLng.lng.toFixed(6);
                directDataModal.style.display = 'flex';
            } else {
                showMessageBox("ğŸš¨ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ê°ì§€ ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
            }
        }

        function closeDirectDataModal() {
            directDataModal.style.display = 'none';
        }


        // ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ ì œì–´
        const preReportModal = document.getElementById('preReportModal');
        const preLatInput = document.getElementById('preLat');
        const preLonInput = document.getElementById('preLon');
        const preReportSubmitBtn = document.getElementById('preReportSubmitBtn');

        function openPreReportModal() {
            if (lastClickedLatLng) {
                preLatInput.value = lastClickedLatLng.lat.toFixed(6);
                preLonInput.value = lastClickedLatLng.lng.toFixed(6);
                preReportModal.style.display = 'flex';
            } else {
                showMessageBox("ğŸš¨ ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì†Œê° ì˜ˆì • ìœ„ì¹˜ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.", 'error');
            }
        }

        function closePreReportModal() {
            preReportModal.style.display = 'none';
        }

        // --- 5. ë°ì´í„° Fetch ë° ì‹œê°í™” í•¨ìˆ˜ ---
        
        // ì„œë²„ì—ì„œ ëª¨ë“  ë°ì´í„° (ê°ì§€, ì‹ ê³ , ì‚¬ì „ì‹ ê³ )ë¥¼ ê°€ì ¸ì™€ ì§€ë„ì— í‘œì‹œ
        async function fetchData() {
            try {
                showMessageBox("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", 'info');
                
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // ğŸ› ï¸ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬ ì¶”ê°€ (null/undefined/non-array ì²˜ë¦¬)
                const directDetections = Array.isArray(data.directDetections) ? data.directDetections : [];
                const citizenReports = Array.isArray(data.citizenReports) ? data.citizenReports : [];
                const preReports = Array.isArray(data.preReports) ? data.preReports : [];
                
                showMessageBox(`âœ… ë°ì´í„° ë¡œë”© ì™„ë£Œ! (ê°ì§€: ${directDetections.length}, ì‹ ê³ : ${citizenReports.length})`, 'success');
                visualizeData(directDetections, citizenReports, preReports);

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.', 'error');
            }
        }

        // ì§€ë„ ì‹œê°í™”
        function visualizeData(directDetections, citizenReports, preReports) {
            try {
                // ê¸°ì¡´ ë§ˆì»¤ ë° ì› ì œê±°
                markers.clearLayers();
                preReportsCircles.clearLayers();

                // A. ì‚¬ì „ ì‹ ê³  êµ¬ì—­ (preReports) ì‹œê°í™” (L.Circle)
                preReports.forEach(pre => {
                    // Kmë¥¼ ë¯¸í„°ë¡œ ë³€í™˜ (Leaflet CircleMarkerëŠ” ë¯¸í„° ë‹¨ìœ„)
                    const radiusMeters = pre.rangeKm * 1000; 

                    // ì‚¬ì „ ì‹ ê³  êµ¬ì—­ì„ ë°˜íˆ¬ëª…í•œ ë…¹ìƒ‰ ì›ìœ¼ë¡œ í‘œì‹œ
                    const circle = L.circle([pre.lat, pre.lon], {
                        color: '#10b981', // Green
                        fillColor: '#10b981',
                        fillOpacity: 0.3,
                        radius: radiusMeters 
                    }).bindPopup(`
                        <b>[ì‚¬ì „ ì‹ ê³  êµ¬ì—­]</b><br>
                        <b>ì‹œì‘:</b> ${new Date(pre.startDate).toLocaleString()}<br>
                        <b>ì¢…ë£Œ:</b> ${new Date(pre.endDate).toLocaleString()}<br>
                        <b>ë°˜ê²½:</b> ${pre.rangeKm} Km
                    `);
                    preReportsCircles.addLayer(circle);
                });
                map.addLayer(preReportsCircles);

                // B. ì§ì ‘ ê°ì§€ ë°ì´í„° (directDetections) ì²˜ë¦¬
                directDetections.forEach(row => {
                    // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ ì¬í™•ì¸ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
                    if (row.lat && row.lon && row.time) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        
                        // ì‹ ê³  ì—¬ë¶€ì— ë”°ë¼ ë§ˆì»¤ ìƒ‰ìƒ ê²°ì •
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createCircleIcon(color);

                        // ì˜¨ë„ ì •ë³´ ì¶”ê°€
                        const temperature = row.temperature !== undefined ? `${row.temperature}Â°C` : 'N/A';

                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[ì§ì ‘ ê°ì§€]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>ì˜¨ë„:</b> ${temperature}<br>
                            <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // C. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                     // ë°ì´í„°ê°€ ìœ íš¨í•œì§€ ì¬í™•ì¸
                    if (row.lat && row.lon && row.time) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        
                        // ì‹ ê³  ì—¬ë¶€ì— ë”°ë¼ ë§ˆì»¤ ìƒ‰ìƒ ê²°ì •
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createTriangleIcon(color);

                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
            }
        }
        
        /**
         * ğŸ’¡ ëª¨ë“  ë°ì´í„° ì‚­ì œ (ê´€ë¦¬ììš©)
         */
        async function deleteAllData() {
            showMessageBox("ë°ì´í„° ì‚­ì œ ì¤‘...", 'info');
            
            try {
                // index.jsì— êµ¬í˜„ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ API í˜¸ì¶œ
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('âœ… ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData(); // ì‚­ì œ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. ì´ˆê¸°í™” ---

        function initializeMap() {
            // ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            fetchData();
            
            
            // --- 6. ì§€ë„ í´ë¦­ ë° ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ì„ì‹œ í•€ ë° ì¢Œí‘œ ì €ì¥) ---
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. ê¸°ì¡´ ì„ì‹œ ë§ˆì»¤ ì œê±°
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. ìƒˆ ì„ì‹œ ë§ˆì»¤ ìƒì„± (íŒŒë€ìƒ‰ í•€) - draggable: true ì¶”ê°€
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>í´ë¦­ëœ ìœ„ì¹˜:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // ì „ì—­ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                    
                    // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
                    marker.setPopupContent(`<b>ë“œë˜ê·¸ëœ ìœ„ì¹˜:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                    if (preReportModal.style.display === 'flex') {
                        preLatInput.value = position.lat.toFixed(6);
                        preLonInput.value = position.lng.toFixed(6);
                    }
                     // [ì¶”ê°€] ì§ì ‘ ê°ì§€ ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                     if (directDataModal.style.display === 'flex') {
                        directLatInput.value = position.lat.toFixed(6);
                        directLonInput.value = position.lng.toFixed(6);
                    }
                });

                // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                if (preReportModal.style.display === 'flex') {
                    preLatInput.value = lastClickedLatLng.lat.toFixed(6);
                    preLonInput.value = lastClickedLatLng.lng.toFixed(6);
                }
                // [ì¶”ê°€] ì§ì ‘ ê°ì§€ ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                if (directDataModal.style.display === 'flex') {
                    directLatInput.value = lastClickedLatLng.lat.toFixed(6);
                    directLonInput.value = lastClickedLatLng.lng.toFixed(6);
                }
            });


            // --- 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° API í˜¸ì¶œ (ë²„íŠ¼) ---
            
            // [ìˆ˜ì •] ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€ ë²„íŠ¼ (Modal Open)
            document.getElementById('addDirectDataBtn').addEventListener('click', openDirectDataModal);
            
            // [ì¶”ê°€] ì§ì ‘ ê°ì§€ ë°ì´í„° í¼ ì œì¶œ ì²˜ë¦¬
            document.getElementById('directDataForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                directDataSubmitBtn.disabled = true;

                const form = e.target;
                const lat = parseFloat(form.directLat.value);
                const lon = parseFloat(form.directLon.value);
                // [ìˆ˜ì •] ì˜¨ë„ ë° ì—°ê¸°ëŸ‰ ê°’ ê°€ì ¸ì˜¤ê¸°
                const temperature = parseFloat(form.temperature.value);
                const smoke = parseInt(form.smokeLevel.value);

                if (isNaN(temperature) || isNaN(smoke) || smoke < 0 || smoke > 100) {
                    showMessageBox("ğŸš¨ ì˜¨ë„ ë˜ëŠ” ì—°ê¸°ëŸ‰ ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", 'error');
                    directDataSubmitBtn.disabled = false;
                    return;
                }

                showMessageBox("ì§ì ‘ ê°ì§€ ë°ì´í„° ë“±ë¡ ì¤‘...", 'info');

                const payload = {
                    lat, 
                    lon, 
                    temperature, // ì˜¨ë„ ì¶”ê°€
                    smoke,       // ì—°ê¸°ëŸ‰ ì¶”ê°€
                    time: Date.now() 
                };

                try {
                    const response = await fetch('/api/add/direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        closeDirectDataModal();
                        showMessageBox('âœ… ì§ì ‘ ê°ì§€ ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                    } else {
                        const errorData = await response.json().catch(() => ({})); 
                        showMessageBox(`âŒ ì¶”ê°€ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜. ì½˜ì†” í™•ì¸.'}`, 'error');
                        console.error('Add Direct API Error:', errorData);
                    }
                } catch (error) {
                    console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                    showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë°ì´í„° ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    directDataSubmitBtn.disabled = false;
                }
            });

            // ì‚¬ì „ ì‹ ê³  ë²„íŠ¼ (Modal Open)
            document.getElementById('addPreReportBtn').addEventListener('click', openPreReportModal);

            // ì‚¬ì „ ì‹ ê³  í¼ ì œì¶œ ì²˜ë¦¬
            document.getElementById('preReportForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                preReportSubmitBtn.disabled = true;

                const form = e.target;
                const lat = parseFloat(form.preLat.value);
                const lon = parseFloat(form.preLon.value);
                const startDate = new Date(form.preStartDate.value).getTime();
                const endDate = new Date(form.preEndDate.value).getTime();
                const rangeKm = parseFloat(form.preRangeKm.value);

                if (startDate >= endDate) {
                    showMessageBox("ğŸš¨ ì¢…ë£Œ ì¼ì‹œëŠ” ì‹œì‘ ì¼ì‹œë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.", 'error');
                    preReportSubmitBtn.disabled = false;
                    return;
                }

                showMessageBox("ì†Œê° ì‚¬ì „ ì‹ ê³  ì •ë³´ ë“±ë¡ ì¤‘...", 'info');
                
                const payload = {
                    lat, lon, startDate, endDate, rangeKm
                };

                try {
                    const response = await fetch('/api/add/pre', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        closePreReportModal();
                        showMessageBox('âœ… ì†Œê° ì‚¬ì „ ì‹ ê³ ê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                    } else {
                        const errorData = await response.json().catch(() => ({})); 
                        showMessageBox(`âŒ ë“±ë¡ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                    }
                } catch (error) {
                    console.error('API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                    showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‹ ê³  ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                } finally {
                    preReportSubmitBtn.disabled = false;
                }
            });
            
            // ë°ì´í„° ëª¨ë‘ ì‚­ì œ ë²„íŠ¼ (Admin)
            document.getElementById('deleteAllBtn').addEventListener('click', () => {
                // ê²½ê³  ë©”ì‹œì§€ ëŒ€ì‹  ë©”ì‹œì§€ ë°•ìŠ¤ë¥¼ ì‚¬ìš©
                const confirmMessage = "âš ï¸ ê²½ê³ : ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!)";
                showMessageBox(confirmMessage, 'error');

                // ê°„ì†Œí™”ëœ ë²„ì „: ë°”ë¡œ ì‚­ì œ í•¨ìˆ˜ í˜¸ì¶œ (ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì¸ì¦ í•„ìš”)
                if (window.confirm("ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                    deleteAllData();
                }
            });
        }

        window.onload = initializeMap;

    </script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  try {
    if (typeof initializeMap === 'function') {
      initializeMap();
    } else {
      console.error('initializeMap í•¨ìˆ˜ê°€ ì •ì˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
  } catch (e) {
    console.error('ì§€ë„ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', e);
    if (typeof showMessageBox === 'function') {
      showMessageBox('âŒ ì§€ë„ ì´ˆê¸°í™” ì˜¤ë¥˜: ' + (e.message || e), 'error');
    }
  }
});
</script>
</body>
</html>
