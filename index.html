<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
        }

        /* Custom Marker Styles */
        .custom-marker {
            font-size: 25px;
            text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ë°ì´í„° ì¶”ê°€/ì¼ê´„ ì‚­ì œ ê¸°ëŠ¥ì— í•„ìš”) */
        #dataModal, #preReportModal, #messageBox, #confirmModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            min-width: 300px;
            text-align: center;
            animation: fadeIn 0.3s ease-out;
            position: relative; /* ë‹«ê¸° ë²„íŠ¼ì„ ìœ„í•´ ì¶”ê°€ */
        }
        
        .modal-content-lg {
            max-width: 500px;
            text-align: left;
        }

        .modal-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        
    </style>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    
    <h1><i class="fas fa-smog text-red-600 mr-2"></i> ë¶ˆë²• ì†Œê° ê°ì§€ ì‹œìŠ¤í…œ ì§€ë„</h1>
    
    <div class="control-panel">
        <button onclick="fetchData()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-sync mr-2"></i> ì§€ë„ ìƒˆë¡œê³ ì¹¨
        </button>
        
        <!-- ì›ë³¸ íŒŒì¼ì˜ ë²„íŠ¼ 1: ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€ -->
        <button onclick="showDataModal('sensor')" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-microchip mr-2"></i> ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€
        </button>
        
        <!-- ì›ë³¸ íŒŒì¼ì˜ ë²„íŠ¼ 2: ì‹œë¯¼ ì‹ ê³  -->
        <button onclick="showDataModal('citizen')" class="bg-yellow-500 hover:bg-yellow-700 text-gray-800 font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-user-edit mr-2"></i> ì‹œë¯¼ ì‹ ê³ 
        </button>

        <!-- ì›ë³¸ íŒŒì¼ì˜ ë²„íŠ¼ 3: ì‚¬ì „ ì‹ ê³  -->
        <button onclick="showPreReportModal()" class="bg-indigo-500 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-calendar-alt mr-2"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ 
        </button>

        <!-- âœ… ìš”ì²­ ì‚¬í•­ 2: ë°ì´í„° ì¼ê´„ ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ -->
        <button id="deleteAllBtn" onclick="showConfirmDelete()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 transform hover:scale-105">
            <i class="fas fa-trash-alt mr-2"></i> ë°ì´í„° ì¼ê´„ ì†Œê°
        </button>
        
    </div>

    <div id="map"></div>
    
    <!-- ì§ì ‘ ê°ì§€ / ì‹œë¯¼ ì‹ ê³  ë°ì´í„° ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="dataModal" class="fixed hidden">
        <div class="modal-content modal-content-lg" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closeDataModal()">&times;</span>
            <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800"></h2>
            
            <form id="dataForm" class="space-y-4">
                <p class="text-sm text-gray-500 mb-4">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ê±°ë‚˜, í•€ì„ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                        <input type="text" id="lat" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                        <input type="text" id="lon" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                </div>

                <div id="smokeSection">
                    <label for="smoke" class="block text-sm font-medium text-gray-700">ì—°ê¸°ëŸ‰</label>
                    <input type="number" id="smoke" min="0" max="100" placeholder="0-100" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                
                <div>
                    <label for="time" class="block text-sm font-medium text-gray-700">ì‹œê°„ (ë°œìƒ ì‹œì )</label>
                    <input type="datetime-local" id="time" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>
                
                <button type="submit" id="submitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 mt-6">ë°ì´í„° ì¶”ê°€</button>
            </form>
        </div>
    </div>

    <!-- ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ -->
    <div id="preReportModal" class="fixed hidden">
        <div class="modal-content modal-content-lg" onclick="event.stopPropagation()">
            <span class="modal-close" onclick="closePreReportModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-gray-800">ì†Œê° ì‚¬ì „ ì‹ ê³  ë“±ë¡</h2>
            <form id="preReportForm" class="space-y-4">
                <p class="text-sm text-gray-500 mb-4">ì§€ë„ë¥¼ í´ë¦­í•˜ì—¬ ì‹ ê³  ìœ„ì¹˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”.</p>
                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">ìœ„ë„ (Lat)</label>
                        <input type="text" id="preLat" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label class="block text-sm font-medium text-gray-700">ê²½ë„ (Lon)</label>
                        <input type="text" id="preLon" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" readonly required>
                    </div>
                </div>

                <div>
                    <label for="rangeKm" class="block text-sm font-medium text-gray-700">ì†Œê° ë°˜ê²½ (Km)</label>
                    <input type="number" id="rangeKm" min="0.1" step="0.1" value="0.5" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                </div>

                <div class="flex flex-wrap -mx-2">
                    <div class="w-1/2 px-2">
                        <label for="startDate" class="block text-sm font-medium text-gray-700">ì‹œì‘ ì‹œê°„</label>
                        <input type="datetime-local" id="startDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div class="w-1/2 px-2">
                        <label for="endDate" class="block text-sm font-medium text-gray-700">ì¢…ë£Œ ì‹œê°„</label>
                        <input type="datetime-local" id="endDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                
                <button type="submit" id="preReportSubmitBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150 mt-6">ì‚¬ì „ ì‹ ê³  ë“±ë¡</button>
            </form>
        </div>
    </div>


    <!-- ë©”ì‹œì§€ ë°•ìŠ¤ (ì•Œë¦¼ìš© - ëª¨ë“  ê¸°ëŠ¥ì— í•„ìš”) -->
    <div id="messageBox" class="fixed hidden" onclick="closeMessageBox()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="messageIcon" class="modal-icon text-blue-500"></div>
            <p id="messageText" class="text-lg font-semibold mb-4"></p>
            <button onclick="closeMessageBox()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow">í™•ì¸</button>
        </div>
    </div>
    
    <!-- âœ… ìš”ì²­ ì‚¬í•­ 2: í™•ì¸ ëª¨ë‹¬ (ì¼ê´„ ì‚­ì œìš©) -->
    <div id="confirmModal" class="fixed hidden">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-icon text-red-500"><i class="fas fa-exclamation-triangle"></i></div>
            <p id="confirmText" class="text-lg font-semibold mb-4 text-red-700">âš ï¸ **ê²½ê³ **: ëª¨ë“  ì„¼ì„œ, ì‹ ê³ , ì‚¬ì „ ì‹ ê³  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
            <div class="flex justify-center gap-4">
                <button onclick="closeConfirmBox()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow">ì·¨ì†Œ</button>
                <button onclick="deleteAllData(true)" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow">ì‚­ì œ ì§„í–‰</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let map;
        let markers = new L.FeatureGroup();
        let preReportGroup = new L.FeatureGroup();
        let tempMarker = null; // ì„ì‹œë¡œ í´ë¦­ëœ ìœ„ì¹˜ë¥¼ í‘œì‹œí•˜ëŠ” ë§ˆì»¤
        let lastClickedLatLng = null; // ë§ˆì§€ë§‰ìœ¼ë¡œ í´ë¦­ëœ ì¢Œí‘œ ì €ì¥
        let currentDataType = null; // í˜„ì¬ ì—´ë¦° ëª¨ë‹¬ì˜ ë°ì´í„° íƒ€ì… ('sensor' ë˜ëŠ” 'citizen')

        // --- 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ë§ˆì»¤/ì•„ì´ì½˜) ---

        // ë§ˆì»¤ ì•„ì´ì½˜ ìƒì„± í•¨ìˆ˜ (ì„¼ì„œ: ì‚¬ê°í˜•, ì‹ ê³ : ì‚¼ê°í˜•)
        function createDivIcon(html, className, color) {
            return L.divIcon({
                className: `custom-marker ${className}`,
                html: `<div style="color: ${color};">${html}</div>`,
                iconSize: [25, 25],
                iconAnchor: [12, 12]
            });
        }
        
        function createSquareIcon(color) {
            // ì—°ê¸° ê°ì§€ (ì‚¬ê°í˜•)
            return createDivIcon('<i class="fas fa-square-full"></i>', 'square-icon', color);
        }

        function createTriangleIcon(color) {
            // ì‹œë¯¼ ì‹ ê³  (ì‚¼ê°í˜•)
            return createDivIcon('<i class="fas fa-caret-up"></i>', 'triangle-icon', color);
        }

        // --- 2. ë°ì´í„° ì²˜ë¦¬ ë¡œì§ ---

        // ì‚¬ì „ ì‹ ê³  ë²”ìœ„ ë‚´ì¸ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function isInPreReport(lat, lon, time, preReports) {
            const currentPoint = L.latLng(lat, lon);
            const currentTime = time;

            return preReports.some(report => {
                const centerPoint = L.latLng(report.lat, report.lon);
                const rangeMeters = (report.rangeKm || 0.1) * 1000; 
                
                // ì‹œê°„ ì¡°ê±´ í™•ì¸
                const isTimeValid = currentTime >= report.startDate && currentTime <= report.endDate;
                
                // ê±°ë¦¬ ì¡°ê±´ í™•ì¸ (ë¯¸í„° ë‹¨ìœ„)
                const distance = currentPoint.distanceTo(centerPoint);
                const isDistanceValid = distance <= rangeMeters;

                return isTimeValid && isDistanceValid;
            });
        }

        async function fetchData() {
            try {
                // ë°ì´í„° ë¡œë”© ì¤‘ í‘œì‹œ
                document.querySelector('.control-panel button:first-child').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ë¡œë”© ì¤‘...';

                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const { sensorData, citizenReports, preReports } = await response.json();
                
                renderData(sensorData, citizenReports, preReports);

            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:', error);
                if (typeof showMessageBox === 'function') {
                    showMessageBox(`ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ìƒíƒœ(Vercel ë°°í¬)ë¥¼ í™•ì¸í•˜ì„¸ìš”: ${error.message}`, 'error');
                }
            } finally {
                // ë¡œë”© ì™„ë£Œ í›„ ë²„íŠ¼ ë³µêµ¬
                document.querySelector('.control-panel button:first-child').innerHTML = '<i class="fas fa-sync mr-2"></i> ì§€ë„ ìƒˆë¡œê³ ì¹¨';
            }
        }

        function renderData(sensorData, citizenReports, preReports) {
            try {
                // ê¸°ì¡´ ë§ˆì»¤ ë° ì› ì´ˆê¸°í™”
                markers.clearLayers();
                preReportGroup.clearLayers();
                
                // A. ì‚¬ì „ ì‹ ê³  ë°ì´í„° (preReports) ì²˜ë¦¬ (ë²”ìœ„ í‘œì‹œ)
                preReports.forEach(row => {
                    // âœ… ìš”ì²­ ì‚¬í•­ 1: ì†Œê° ì •ë³´ ë²”ìœ„ë¥¼ ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½
                    L.circle([row.lat, row.lon], {
                        color: '#10b981',      /* ì´ˆë¡ìƒ‰ í…Œë‘ë¦¬ (emerald-600) */
                        fillColor: '#34d399',   /* ì´ˆë¡ìƒ‰ ì±„ìš°ê¸° (emerald-400) */
                        fillOpacity: 0.2,
                        radius: (row.rangeKm || 0.1) * 1000 // KM to meters, ì•ˆì „ì„ ìœ„í•´ ê¸°ë³¸ê°’ 0.1km
                    }).bindPopup(`
                        <b>[ì‚¬ì „ ì‹ ê³ ]</b><br>
                        <b>ì‹œì‘:</b> ${new Date(row.startDate).toLocaleString()}<br>
                        <b>ì¢…ë£Œ:</b> ${new Date(row.endDate).toLocaleString()}<br>
                        <b>ë°˜ê²½:</b> ${row.rangeKm || 0.1} km
                    `).addTo(preReportGroup);
                });

                map.addLayer(preReportGroup); // ì‚¬ì „ ì‹ ê³  ì› ë¨¼ì € ì§€ë„ì— ì¶”ê°€

                // B. ì„¼ì„œ ë°ì´í„° (sensorData) ì²˜ë¦¬
                sensorData.forEach(row => {
                    if (row.lat && row.lon) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        const color = isReported ? '#ff8c00' : '#dc2626'; // ì‹ ê³ ë¨: ì£¼í™©ìƒ‰, ë¯¸ì‹ ê³ : ë¹¨ê°„ìƒ‰
                        const icon = createSquareIcon(color);
                        
                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[ì§ì ‘ ê°ì§€]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // C. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; // ì‹ ê³ ë¨: ì£¼í™©ìƒ‰, ë¯¸ì‹ ê³ : ë¹¨ê°„ìƒ‰
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                        <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
            }
        }
        
        // --- 3. ë°ì´í„° ì¶”ê°€ ëª¨ë‹¬ ë¡œì§ (ì›ë³¸ ë³µì›) ---
        
        function showDataModal(type) {
            currentDataType = type;
            const modal = document.getElementById('dataModal');
            const title = document.getElementById('modalTitle');
            const smokeSection = document.getElementById('smokeSection');
            const submitBtn = document.getElementById('submitBtn');
            
            if (!lastClickedLatLng) {
                showMessageBox('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ë¨¼ì € í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì§€ì •í•˜ì„¸ìš”.', 'info');
                return;
            }

            // ì œëª© ì„¤ì • ë° í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
            if (type === 'sensor') {
                title.textContent = 'ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€';
                smokeSection.style.display = 'block';
                document.getElementById('smoke').setAttribute('required', 'required');
                submitBtn.textContent = 'ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€';
                submitBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                submitBtn.classList.add('bg-red-600', 'hover:bg-red-700');
            } else if (type === 'citizen') {
                title.textContent = 'ì‹œë¯¼ ì‹ ê³  ë“±ë¡';
                smokeSection.style.display = 'none';
                document.getElementById('smoke').removeAttribute('required');
                submitBtn.textContent = 'ì‹œë¯¼ ì‹ ê³  ë“±ë¡';
                submitBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                submitBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            }

            // ì¢Œí‘œ ì…ë ¥
            document.getElementById('lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('lon').value = lastClickedLatLng.lng.toFixed(6);
            
            // í˜„ì¬ ì‹œê°„ ì„¤ì •
            const now = new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('time').value = now;

            modal.style.display = 'flex';
        }

        function closeDataModal() {
            document.getElementById('dataModal').style.display = 'none';
            // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì„ì‹œ ë§ˆì»¤ ì œê±°
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
                lastClickedLatLng = null;
            }
        }
        
        document.getElementById('dataForm').addEventListener('submit', handleDataSubmit);

        async function handleDataSubmit(e) {
            e.preventDefault();

            const lat = document.getElementById('lat').value;
            const lon = document.getElementById('lon').value;
            const smoke = document.getElementById('smoke').value;
            const timeISO = document.getElementById('time').value;

            // ISO ì‹œê°„ì„ Unix Timestampë¡œ ë³€í™˜
            const time = new Date(timeISO).getTime(); 

            if (!lat || !lon || !time) {
                showMessageBox('ìœ„ì¹˜, ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ì €ì¥ ì¤‘...';
            
            closeDataModal();
            showMessageBox('ë°ì´í„° ì €ì¥ ì¤‘...', 'info');

            try {
                let url;
                let payload = { lat: parseFloat(lat), lon: parseFloat(lon), time: time };

                if (currentDataType === 'sensor') {
                    if (!smoke) {
                        showMessageBox('ì§ì ‘ ê°ì§€ëŠ” ì—°ê¸°ëŸ‰ì„ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                        submitBtn.disabled = false;
                        return;
                    }
                    url = '/api/add/sensor';
                    payload.smoke = parseInt(smoke);
                } else if (currentDataType === 'citizen') {
                    url = '/api/add/citizen';
                }

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                closeMessageBox(); 

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`âœ… ë°ì´í„° ì¶”ê°€ ì„±ê³µ! (ID: ${result.id})`, 'success');
                    fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    let errorDetails = `[HTTP Status: ${response.status}] ì„œë²„ ì˜¤ë¥˜`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || errorDetails;
                    } catch (e) {
                        errorDetails = `[HTTP Status: ${response.status}] ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. Vercel ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.`;
                    }
                    showMessageBox(`âŒ ë°ì´í„° ì¶”ê°€ ì‹¤íŒ¨: ${errorDetails}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = (currentDataType === 'sensor') ? 'ì§ì ‘ ê°ì§€ ë°ì´í„° ì¶”ê°€' : 'ì‹œë¯¼ ì‹ ê³  ë“±ë¡';
            }
        }
        
        // --- 4. ì‚¬ì „ ì‹ ê³  ëª¨ë‹¬ ë¡œì§ (ì›ë³¸ ë³µì›) ---
        
        function showPreReportModal() {
            const modal = document.getElementById('preReportModal');
            
            if (!lastClickedLatLng) {
                showMessageBox('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ë¨¼ì € í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì—¬ ì§€ì •í•˜ì„¸ìš”.', 'info');
                return;
            }

            document.getElementById('preLat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('preLon').value = lastClickedLatLng.lng.toFixed(6);
            
            // í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì‹œì‘/ì¢…ë£Œ ì‹œê°„ ì´ˆê¸°í™”
            const now = new Date(Date.now() - (new Date().getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('startDate').value = now;
            document.getElementById('endDate').value = now;

            modal.style.display = 'flex';
        }

        function closePreReportModal() {
            document.getElementById('preReportModal').style.display = 'none';
            // ëª¨ë‹¬ ë‹«ì„ ë•Œ ì„ì‹œ ë§ˆì»¤ ì œê±°
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
                lastClickedLatLng = null;
            }
        }

        document.getElementById('preReportForm').addEventListener('submit', handlePreReportSubmit);

        async function handlePreReportSubmit(e) {
            e.preventDefault();

            const lat = document.getElementById('preLat').value;
            const lon = document.getElementById('preLon').value;
            const rangeKm = document.getElementById('rangeKm').value;
            const startDateISO = document.getElementById('startDate').value;
            const endDateISO = document.getElementById('endDate').value;

            const startDate = new Date(startDateISO).getTime();
            const endDate = new Date(endDateISO).getTime();

            if (!lat || !lon || !startDate || !endDate || !rangeKm) {
                showMessageBox('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            if (startDate >= endDate) {
                showMessageBox('ì‹œì‘ ì‹œê°„ì€ ì¢…ë£Œ ì‹œê°„ë³´ë‹¤ ë¹¨ë¼ì•¼ í•©ë‹ˆë‹¤.', 'error');
                return;
            }

            const submitBtn = document.getElementById('preReportSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ë“±ë¡ ì¤‘...';
            
            closePreReportModal();
            showMessageBox('ì‚¬ì „ ì‹ ê³  ë“±ë¡ ì¤‘...', 'info');

            try {
                const url = '/api/add/pre';
                const payload = { 
                    lat: parseFloat(lat), 
                    lon: parseFloat(lon), 
                    startDate: startDate, 
                    endDate: endDate, 
                    rangeKm: parseFloat(rangeKm)
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closeMessageBox(); 

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`âœ… ì‚¬ì „ ì‹ ê³  ë“±ë¡ ì„±ê³µ! (ID: ${result.id})`, 'success');
                    fetchData(); // ì„±ê³µ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    let errorDetails = `[HTTP Status: ${response.status}] ì„œë²„ ì˜¤ë¥˜`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || errorDetails;
                    } catch (e) {
                        errorDetails = `[HTTP Status: ${response.status}] ì„œë²„ ì‘ë‹µì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
                    }
                    showMessageBox(`âŒ ì‚¬ì „ ì‹ ê³  ë“±ë¡ ì‹¤íŒ¨: ${errorDetails}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("âŒ ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ì‚¬ì „ ì‹ ê³  ë“±ë¡';
            }
        }
        
        // --- 5. ì§€ë„ í´ë¦­ ë° ë“œë˜ê·¸ ì´ë²¤íŠ¸ (ì„ì‹œ í•€ ë° ì¢Œí‘œ ì €ì¥) ---
        map.on('click', (e) => {
            lastClickedLatLng = e.latlng;

            // 1. ê¸°ì¡´ ì„ì‹œ ë§ˆì»¤ ì œê±°
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }

            // 2. ìƒˆ ì„ì‹œ ë§ˆì»¤ ìƒì„± (íŒŒë€ìƒ‰ í•€) - draggable: true ì¶”ê°€
            const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
            tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
            tempMarker.bindPopup(`<b>í´ë¦­ëœ ìœ„ì¹˜:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
            
            // 3. ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            tempMarker.on('dragend', function(event) {
                const marker = event.target;
                const position = marker.getLatLng();
                lastClickedLatLng = position; // ì „ì—­ ì¢Œí‘œ ì—…ë°ì´íŠ¸
                
                // íŒì—… ë‚´ìš© ì—…ë°ì´íŠ¸
                marker.setPopupContent(`<b>ë“œë˜ê·¸ëœ ìœ„ì¹˜:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                // ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°, ì¢Œí‘œ í•„ë“œ ì—…ë°ì´íŠ¸
                if (document.getElementById('dataModal').style.display === 'flex') {
                    document.getElementById('lat').value = position.lat.toFixed(6);
                    document.getElementById('lon').value = position.lng.toFixed(6);
                } else if (document.getElementById('preReportModal').style.display === 'flex') {
                    document.getElementById('preLat').value = position.lat.toFixed(6);
                    document.getElementById('preLon').value = position.lng.toFixed(6);
                }
            });
        });
        
        // --- 6. ìœ í‹¸ë¦¬í‹° ëª¨ë‹¬ ë¡œì§ (ë©”ì‹œì§€/í™•ì¸) ---

        function showMessageBox(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const messageIcon = document.getElementById('messageIcon');
            
            messageText.textContent = message;
            
            let iconClass = '';
            let iconColor = '';

            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    iconColor = 'text-green-500';
                    break;
                case 'error':
                    iconClass = 'fas fa-times-circle';
                    iconColor = 'text-red-500';
                    break;
                default: // info
                    iconClass = 'fas fa-info-circle';
                    iconColor = 'text-blue-500';
            }
            
            messageIcon.innerHTML = `<i class="${iconClass} ${iconColor}"></i>`;
            messageBox.style.display = 'flex';
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }

        // --- 7. ë°ì´í„° ì¼ê´„ ì‚­ì œ ê¸°ëŠ¥ ë¡œì§ (ì¶”ê°€ ìš”ì²­ ì‚¬í•­) ---
        
        function showConfirmDelete() {
            document.getElementById('confirmModal').style.display = 'flex';
        }

        function closeConfirmBox() {
            document.getElementById('confirmModal').style.display = 'none';
        }

        async function deleteAllData(confirmed) {
            closeConfirmBox();

            if (!confirmed) return;

            showMessageBox("ë°ì´í„° ì‚­ì œ ì¤‘...", 'info');
            
            try {
                // index.jsì— êµ¬í˜„ëœ ëª¨ë“  ë°ì´í„° ì‚­ì œ API í˜¸ì¶œ
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('âœ… ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    fetchData(); // ì‚­ì œ í›„ ì§€ë„ ìƒˆë¡œê³ ì¹¨
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`âŒ ì‚­ì œ ì‹¤íŒ¨: ${errorData.message || errorData.error || 'ì„œë²„ ì˜¤ë¥˜'}`, 'error');
                }
            } catch (error) {
                console.error('ì‚­ì œ API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                showMessageBox('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ë¡œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. ì´ˆê¸°í™” ---

        function initializeMap() {
            // ì„œìš¸ ì‹œì²­ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            fetchData();
        }

        window.onload = initializeMap;

    </script>
</body>
</html>
