<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불법 소각 감지 지도</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* 커스텀 CSS */
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* 모바일 대응 */
        }
        
        /* 모달 스타일 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none; /* 기본 숨김 */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: #dc2626;
            border-bottom: 2px solid #dc2626;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .close-btn {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close-btn:hover {
            color: #333;
        }

        /* 메시지 박스 스타일 */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 1100;
            display: none;
            text-align: center;
            max-width: 80%;
            min-width: 250px;
            font-weight: bold;
            font-size: 1rem;
            line-height: 1.4;
        }
        .message-success { background-color: #d1fae5; color: #047857; border: 2px solid #065f46; }
        .message-error { background-color: #fee2e2; color: #b91c1c; border: 2px solid #991b1b; }
        .message-info { background-color: #dbeafe; color: #1e40af; border: 2px solid #1e3a8a; }
        .message-box-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.1);
            z-index: 1099;
            display: none;
        }

    </style>
</head>
<body>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- 타이틀 -->
    <h1 class="text-xl md:text-2xl font-bold bg-white p-3 shadow-md">
        <i class="fas fa-fire-extinguisher text-red-600 mr-2"></i> 불법 소각 감지 시스템 대시보드
    </h1>

    <!-- 컨트롤 패널 -->
    <div class="control-panel">
        <button onclick="openPreReportModal()" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-flag-checkered mr-2"></i> 소각 사전 신고
        </button>
        <button onclick="openManualDataModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-thermometer-half mr-2"></i> 직접 데이터 입력
        </button>
        <button onclick="fetchData()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-sync-alt mr-2"></i> 데이터 새로고침
        </button>
        <button onclick="confirmDeleteAll()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-md flex items-center">
            <i class="fas fa-eraser mr-2"></i> 전체 데이터 삭제
        </button>
    </div>

    <!-- 지도 영역 -->
    <div id="map"></div>

    <!-- 메시지 박스 오버레이 -->
    <div id="messageBoxOverlay" class="message-box-overlay" onclick="closeMessageBox()"></div>
    <!-- 메시지 박스 -->
    <div id="messageBox"></div>

    <!-- 1. 소각 사전 신고 모달 -->
    <div id="preReportModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('preReportModal')">&times;</span>
            <h2 class="text-red-600">소각 사전 신고</h2>
            
            <div class="space-y-4">
                <!-- 날짜 및 시간 입력 필드 수정 -->
                <div>
                    <label for="pre_start_date" class="block text-sm font-medium text-gray-700">소각 시작 날짜 및 시간</label>
                    <input type="datetime-local" id="pre_start_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="pre_end_date" class="block text-sm font-medium text-gray-700">소각 종료 날짜 및 시간</label>
                    <input type="datetime-local" id="pre_end_date" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <!-- /날짜 및 시간 입력 필드 수정 -->
                
                <div>
                    <label for="pre_range_km" class="block text-sm font-medium text-gray-700">유효 범위 (Km)</label>
                    <input type="number" id="pre_range_km" step="0.01" min="0.01" value="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500">
                </div>
                <div>
                    <label for="pre_lat" class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                    <input type="text" id="pre_lat" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="pre_lon" class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                    <input type="text" id="pre_lon" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                
                <p class="text-sm text-gray-500">지도를 클릭하여 위치를 설정하거나, 핀을 드래그하여 정확한 위치를 지정하세요.</p>
                
                <button onclick="submitPreReport(this)" id="preReportSubmitBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg mt-4">
                    사전 신고 등록
                </button>
            </div>
        </div>
    </div>

    <!-- 2. 직접 감지 데이터 입력 모달 -->
    <div id="manualDataModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('manualDataModal')">&times;</span>
            <h2 class="text-blue-600">직접 감지 데이터 등록</h2>
            
            <div class="space-y-4">
                <!-- 시간 필드를 온도 필드로 수정 -->
                <div>
                    <label for="manual_temp" class="block text-sm font-medium text-gray-700">온도 (°C)</label>
                    <!-- 시간(time) 대신 온도(temp)를 입력받습니다. -->
                    <input type="number" id="manual_temp" step="1" placeholder="감지 온도 (°C, 예: 300)" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <!-- /시간 필드를 온도 필드로 수정 -->
                
                <div>
                    <label for="manual_smoke" class="block text-sm font-medium text-gray-700">연기량 (0.0~1.0)</label>
                    <input type="number" id="manual_smoke" step="0.01" min="0" max="1" value="0.5" placeholder="0.0~1.0 사이 값" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="manual_lat" class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                    <input type="text" id="manual_lat" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="manual_lon" class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                    <input type="text" id="manual_lon" readonly class="mt-1 block w-full p-2 border border-gray-300 bg-gray-100 rounded-md shadow-sm">
                </div>
                
                <p class="text-sm text-gray-500">지도를 클릭하여 위치를 설정하거나, 핀을 드래그하여 정확한 위치를 지정하세요.</p>
                
                <button onclick="submitManualData(this)" id="manualSubmitBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200 shadow-lg mt-4">
                    데이터 등록
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // 전역 변수
        let map;
        let lastClickedLatLng = null; // 마지막 클릭/드래그된 위치
        let tempMarker = null; // 임시 핀 마커
        let markers = new L.LayerGroup(); // 모든 마커 그룹
        let isMessageBoxOpen = false;
        
        // --- 1. 유틸리티 함수 (모달, 메시지 박스) ---

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }

        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('messageBox');
            const overlay = document.getElementById('messageBoxOverlay');
            box.textContent = message;
            box.className = `message-${type}`; // 클래스 변경
            box.style.display = 'block';
            overlay.style.display = 'block';
            isMessageBoxOpen = true;
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
            document.getElementById('messageBoxOverlay').style.display = 'none';
            isMessageBoxOpen = false;
        }

        // --- 2. Leaflet 관련 함수 (마커 생성 등) ---

        // 커스텀 DIV 아이콘 생성 함수
        function createDivIcon(html, className, color) {
            return L.divIcon({
                className: className,
                html: `<div style="color: ${color}; font-size: 24px; text-shadow: 0 0 2px rgba(0,0,0,0.5);">${html}</div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 24], // 핀 끝이 위치를 가리키도록 설정
                popupAnchor: [0, -20]
            });
        }

        // 삼각형 아이콘 (시민 신고)
        function createTriangleIcon(color) {
            return createDivIcon('<i class="fas fa-exclamation-triangle"></i>', 'citizen-report-icon', color);
        }

        // 원형 아이콘 (직접 감지)
        function createCircleIcon(color) {
            return createDivIcon('<i class="fas fa-circle-notch fa-spin"></i>', 'direct-data-icon', color);
        }

        // --- 3. 데이터 입력 모달 열기 ---

        function openPreReportModal() {
            if (!lastClickedLatLng) {
                showMessageBox('❌ 지도를 클릭하여 소각 위치를 먼저 지정해 주세요.', 'error');
                return;
            }
            document.getElementById('pre_lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('pre_lon').value = lastClickedLatLng.lng.toFixed(6);
            
            // 날짜/시간 초기값 설정 (선택 사항)
            const now = new Date();
            // YYYY-MM-DDTHH:MM 형식으로 포맷팅
            const isoString = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('pre_start_date').value = isoString;
            document.getElementById('pre_end_date').value = isoString;

            openModal('preReportModal');
        }

        function openManualDataModal() {
            if (!lastClickedLatLng) {
                showMessageBox('❌ 지도를 클릭하여 감지 위치를 먼저 지정해 주세요.', 'error');
                return;
            }
            document.getElementById('manual_lat').value = lastClickedLatLng.lat.toFixed(6);
            document.getElementById('manual_lon').value = lastClickedLatLng.lng.toFixed(6);
            // 온도 필드는 비워두거나 기본값 설정
            document.getElementById('manual_temp').value = '300';
            document.getElementById('manual_smoke').value = '0.5';

            openModal('manualDataModal');
        }


        // --- 4. 데이터 전송 (API) ---

        /**
         * 소각 사전 신고 데이터 전송
         */
        async function submitPreReport(submitBtn) {
            submitBtn.disabled = true;
            
            // 날짜/시간 값을 ISO 문자열로 가져온 후 타임스탬프로 변환
            const startDateStr = document.getElementById('pre_start_date').value;
            const endDateStr = document.getElementById('pre_end_date').value;
            const rangeKm = document.getElementById('pre_range_km').value;
            const lat = document.getElementById('pre_lat').value;
            const lon = document.getElementById('pre_lon').value;

            // Date.parse는 ISO 8601 문자열을 밀리초 타임스탬프로 변환합니다.
            const startDate = Date.parse(startDateStr); 
            const endDate = Date.parse(endDateStr); 

            if (isNaN(startDate) || isNaN(endDate) || !rangeKm || !lat || !lon) {
                showMessageBox('❌ 모든 필드를 올바르게 입력했는지 확인해 주세요. (날짜/시간 포함)', 'error');
                submitBtn.disabled = false;
                return;
            }

            if (startDate >= endDate) {
                showMessageBox('❌ 종료 날짜/시간은 시작 날짜/시간보다 늦어야 합니다.', 'error');
                submitBtn.disabled = false;
                return;
            }
            
            closeModal('preReportModal');
            showMessageBox("사전 신고 등록 중...", 'info');
            
            try {
                const payload = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    startDate: startDate, // 밀리초 타임스탬프 전송
                    endDate: endDate,     // 밀리초 타임스탬프 전송
                    rangeKm: parseFloat(rangeKm)
                };

                const response = await fetch('/api/add/pre', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showMessageBox('✅ 사전 신고가 성공적으로 등록되었습니다.', 'success');
                    fetchData();
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 사전 신고 등록 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }

            } catch (error) {
                console.error('사전 신고 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 등록에 실패했습니다.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        /**
         * 직접 감지 데이터 (온도, 연기량) 전송
         */
        async function submitManualData(submitBtn) {
            submitBtn.disabled = true;

            // 'manual_time' 대신 'manual_temp'에서 온도를 가져옵니다.
            const tempStr = document.getElementById('manual_temp').value; 
            const smokeStr = document.getElementById('manual_smoke').value;
            const lat = document.getElementById('manual_lat').value;
            const lon = document.getElementById('manual_lon').value;

            const temp = parseFloat(tempStr);
            const smoke = parseFloat(smokeStr);

            if (isNaN(temp) || isNaN(smoke) || smoke < 0 || smoke > 1 || !lat || !lon) {
                showMessageBox('❌ 온도와 연기량(0.0~1.0), 위치를 모두 정확히 입력해 주세요.', 'error');
                submitBtn.disabled = false;
                return;
            }
            
            closeModal('manualDataModal');
            showMessageBox("직접 데이터 등록 중...", 'info');
            
            try {
                const payload = {
                    lat: parseFloat(lat),
                    lon: parseFloat(lon),
                    temp: temp, // 온도 데이터 전송
                    smoke: smoke,
                    time: Date.now() // 감지 시간은 현재 시간으로 설정
                };

                const response = await fetch('/api/add/manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showMessageBox('✅ 직접 감지 데이터가 성공적으로 등록되었습니다.', 'success');
                    fetchData();
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 직접 데이터 등록 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }

            } catch (error) {
                console.error('직접 데이터 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 등록에 실패했습니다.', 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        // --- 5. 데이터 가져오기 및 시각화 ---

        function isInPreReport(lat, lon, time, preReports) {
            // 사전 신고된 위치에서 0.1km(기본값) 이내, 지정된 시간 범위 내인지 확인
            const point = L.latLng(lat, lon);
            
            return preReports.some(report => {
                const reportCenter = L.latLng(report.lat, report.lon);
                const distanceMeters = point.distanceTo(reportCenter);
                const rangeMeters = (report.rangeKm || 0.1) * 1000;
                
                // 거리 및 시간 비교
                return distanceMeters <= rangeMeters && time >= report.startDate && time <= report.endDate;
            });
        }

        function renderData(directData, citizenReports, preReports) {
            // 기존 마커 제거
            markers.clearLayers();

            try {
                // A. 직접 감지 데이터 (directData) 처리
                directData.forEach(row => {
                    // directData에는 이제 'time', 'temp', 'smoke'가 포함됩니다.
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    
                    // 불법 소각 의심 기준: 연기량 0.4 초과 AND 온도 100°C 초과 (임시 기준)
                    const isBurn = row.smoke > 0.4 && row.temp > 100;

                    let color;
                    if (isReported) {
                        color = '#ff8c00'; // 주황: 신고된 소각
                    } else if (isBurn) {
                        color = '#dc2626'; // 빨강: 불법 소각 의심
                    } else {
                        color = '#10b981'; // 초록: 정상 범위
                    }

                    const icon = createCircleIcon(color);
                    
                    // 팝업 내용 수정: '온도' 필드 추가 및 '시간' 포맷팅 개선
                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[직접 감지]</b><br>
                        <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>온도:</b> ${row.temp}°C<br> 
                        <b>연기량:</b> ${row.smoke}<br>
                        <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : (isBurn ? '🚨 불법 소각 의심' : '🟢 정상')}<br>
                        <small>등록 시간: ${new Date(row.createdAt).toLocaleString()}</small>
                    `);
                    markers.addLayer(marker);
                });

                // B. 시민 신고 데이터 (citizenReports) 처리
                citizenReports.forEach(row => {
                    // citizenReports에는 'time'(신고된 시점)이 포함됩니다.
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; 
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[시민 신고]</b><br>
                        <b>신고 시점:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);

            } catch (error) {
                console.error('데이터 로딩 및 시각화 오류:', error);
                showMessageBox('❌ 데이터 시각화 중 오류 발생.', 'error');
            }
        }

        async function fetchData() {
            showMessageBox("데이터를 불러오는 중...", 'info');
            try {
                // index.js API 호출
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Firestore Timestamp는 초 단위로 저장되므로 밀리초로 변환합니다.
                const preReports = data.preReports.map(report => ({
                    ...report,
                    startDate: report.startDate, // 이미 클라이언트에서 ms로 전송
                    endDate: report.endDate
                }));

                const directData = data.directData.map(d => ({
                    ...d,
                    time: d.time, // 클라이언트에서 ms로 전송
                    createdAt: d.createdAt ? d.createdAt.seconds * 1000 : Date.now()
                }));

                const citizenReports = data.citizenReports.map(r => ({
                    ...r,
                    time: r.time, // 클라이언트에서 ms로 전송
                    createdAt: r.createdAt ? r.createdAt.seconds * 1000 : Date.now()
                }));
                
                renderData(directData, citizenReports, preReports);
                closeMessageBox();
                
            } catch (error) {
                console.error('데이터 로딩 오류:', error);
                showMessageBox(`❌ 데이터 로딩에 실패했습니다: ${error.message}. Vercel API 서버 상태를 확인하세요.`, 'error');
            }
        }
        
        // --- 6. 지도 클릭 및 드래그 이벤트 (임시 핀 및 좌표 저장) ---
        function setupMapEvents() {
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. 기존 임시 마커 제거
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. 새 임시 마커 생성 (파란색 핀) - draggable: true 추가
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>클릭된 위치:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. 드래그 이벤트 리스너 추가
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // 전역 좌표 업데이트
                    
                    // 팝업 내용 업데이트
                    marker.setPopupContent(`<b>드래그된 위치:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // 모달이 열려있는 경우, 좌표 필드도 업데이트
                    const preReportModal = document.getElementById('preReportModal');
                    const manualDataModal = document.getElementById('manualDataModal');

                    if (preReportModal.style.display === 'flex') {
                        document.getElementById('pre_lat').value = position.lat.toFixed(6);
                        document.getElementById('pre_lon').value = position.lng.toFixed(6);
                    } else if (manualDataModal.style.display === 'flex') {
                        document.getElementById('manual_lat').value = position.lat.toFixed(6);
                        document.getElementById('manual_lon').value = position.lng.toFixed(6);
                    }
                });
            });
        }
        
        // --- 7. 전체 삭제 확인 ---
        function confirmDeleteAll() {
            if (isMessageBoxOpen) return;

            const box = document.getElementById('messageBox');
            const overlay = document.getElementById('messageBoxOverlay');
            
            box.innerHTML = `
                <p class="text-lg mb-4">⚠️ 경고: 데이터베이스의 모든 데이터를 삭제하시겠습니까?</p>
                <button id="confirmDeleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg mr-2 transition duration-200">
                    삭제 확인
                </button>
                <button onclick="closeMessageBox()" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-200">
                    취소
                </button>
            `;
            box.className = 'message-error';
            box.style.display = 'block';
            overlay.style.display = 'block';
            isMessageBoxOpen = true;

            document.getElementById('confirmDeleteBtn').onclick = deleteAllData;
        }

        async function deleteAllData() {
            closeMessageBox();
            showMessageBox("데이터 삭제 중...", 'info');
            
            try {
                // index.js에 구현된 모든 데이터 삭제 API 호출
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('✅ 데이터베이스의 모든 데이터가 성공적으로 삭제되었습니다.', 'success');
                    fetchData(); // 삭제 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 삭제 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error('삭제 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 삭제에 실패했습니다.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. 초기화 ---

        function initializeMap() {
            // 서울 시청을 중심으로 지도 초기화
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            setupMapEvents(); // 지도 이벤트 설정
            fetchData();      // 초기 데이터 로드

            // 맵 크기 변경 시 타일 다시 로드
            window.addEventListener('resize', () => map.invalidateSize());
        }

        window.onload = initializeMap;

    </script>
</body>
</html>
