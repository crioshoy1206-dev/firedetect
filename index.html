<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불법 소각 감지 지도</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Noto Sans KR Font -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        /* 기본 레이아웃: 화면 전체를 차지하도록 설정 */
        body { 
            margin: 0; 
            font-family: 'Noto Sans KR', sans-serif; 
            display: flex; 
            flex-direction: column; 
            height: 100vh; 
            background-color: #f8f8f8;
        }
        
        /* 맵 컨테이너: flex-grow로 남은 공간 모두 차지 */
        #map { 
            flex-grow: 1; 
            width: 100%; 
            z-index: 0; 
            min-height: 50vh; /* 최소 높이 보장 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* 컨트롤 패널 스타일 */
        .control-panel {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }

        /* 커스텀 마커 아이콘 스타일 */
        .custom-div-icon {
            text-align: center;
            line-height: 1;
            font-size: 1.5rem;
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            animation: pulse 1.5s infinite;
        }

        .temp-pin-icon {
            font-size: 1.8rem;
            animation: none;
            box-shadow: none;
        }

        @keyframes pulse {
            0% { transform: scale(0.9); opacity: 0.8; }
            70% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.8; }
        }

        /* 메시지 박스 스타일 */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            font-weight: 700;
            text-align: center;
            display: none;
            max-width: 90%;
            min-width: 250px;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box-content {
            white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .message-box-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            cursor: pointer;
            position: absolute;
            top: 10px;
            right: 15px;
        }
    </style>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Firebase JS Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug'); // Firestore 로그 레벨 설정

        // --- 글로벌 변수 설정 (Canvas 환경 변수 사용) ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase 초기화 ---
        if (Object.keys(firebaseConfig).length > 0) {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.db = getFirestore(window.firebaseApp);
            window.auth = getAuth(window.firebaseApp);

            // 사용자 인증 처리
            if (initialAuthToken) {
                signInWithCustomToken(window.auth, initialAuthToken)
                    .then(() => {
                        console.log("✅ Firebase Custom Token Sign-In Success.");
                    })
                    .catch((error) => {
                        console.error("❌ Firebase Custom Token Sign-In Failed:", error);
                        signInAnonymously(window.auth); // 실패 시 익명 로그인 시도
                    });
            } else {
                signInAnonymously(window.auth)
                    .then(() => console.log("✅ Firebase Anonymous Sign-In Success."))
                    .catch((error) => console.error("❌ Firebase Anonymous Sign-In Failed:", error));
            }
        } else {
            console.warn("⚠️ Firebase Config is missing. Data persistence/API usage may be affected.");
        }
        window.appId = appId;
    </script>
</head>
<body>
    <header class="bg-white shadow-md p-4 flex flex-col sm:flex-row justify-between items-center">
        <h1 class="text-xl font-bold text-red-600 mb-2 sm:mb-0">
            <i class="fas fa-fire-extinguisher mr-2"></i>불법 소각 감지 시스템 지도
        </h1>
        <div class="flex flex-wrap justify-center gap-2">
            <button onclick="openPreReportModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-calendar-alt mr-1"></i> 소각 사전 신고
            </button>
            <button onclick="openAddDetectionModal()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-plus-circle mr-1"></i> 감지 데이터 추가
            </button>
            <a href="/citizen_report.html" target="_blank" class="bg-yellow-500 hover:bg-yellow-600 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center">
                <i class="fas fa-megaphone mr-1"></i> 시민 신고 페이지
            </a>
            <button onclick="confirmDeleteAllData()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
                <i class="fas fa-trash-alt mr-1"></i> 데이터 전체 삭제
            </button>
        </div>
    </header>

    <main class="p-4 flex-grow relative">
        <div id="map" class="h-full w-full"></div>
    </main>

    <!-- ----------------------- 모달 템플릿 (사전 신고 / 감지 데이터 추가) ----------------------- -->

    <!-- 1. 사전 신고 모달 -->
    <div id="preReportModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-blue-600 border-b pb-2">소각 사전 신고 (예정)</h2>
            <form id="preReportForm" onsubmit="submitPreReport(event)">
                <div class="mb-4">
                    <label for="preLat" class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                    <input type="number" id="preLat" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preLon" class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                    <input type="number" id="preLon" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preRangeKm" class="block text-sm font-medium text-gray-700">소각 범위 (Km)</label>
                    <input type="number" id="preRangeKm" step="0.1" value="0.5" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="preStartDate" class="block text-sm font-medium text-gray-700">시작 일시</label>
                    <input type="datetime-local" id="preStartDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-6">
                    <label for="preEndDate" class="block text-sm font-medium text-gray-700">종료 일시</label>
                    <input type="datetime-local" id="preEndDate" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closePreReportModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        취소
                    </button>
                    <button type="submit" id="preSubmitBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg">
                        신고 접수
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 2. 감지 데이터 추가 모달 -->
    <div id="addDetectionModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
            <h2 class="text-2xl font-bold mb-4 text-green-600 border-b pb-2">감지 데이터 수동 추가</h2>
            <form id="addDetectionForm" onsubmit="submitDetectionData(event)">
                <div class="mb-4">
                    <label for="detLat" class="block text-sm font-medium text-gray-700">위도 (Lat)</label>
                    <input type="number" id="detLat" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="detLon" class="block text-sm font-medium text-gray-700">경도 (Lon)</label>
                    <input type="number" id="detLon" step="0.000001" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-4">
                    <label for="detSmoke" class="block text-sm font-medium text-gray-700">연기량 (1-100)</label>
                    <input type="number" id="detSmoke" min="1" max="100" value="50" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="mb-6">
                    <label for="detTime" class="block text-sm font-medium text-gray-700">감지 시각</label>
                    <input type="datetime-local" id="detTime" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeAddDetectionModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg">
                        취소
                    </button>
                    <button type="submit" id="detSubmitBtn" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg">
                        데이터 추가
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 3. 범용 메시지 박스 -->
    <div id="message-box" class="hidden">
        <div class="message-box-content" id="message-text"></div>
        <button class="message-box-close" onclick="closeMessageBox()">&times;</button>
    </div>


    <script>
        // --- 전역 변수 ---
        let map; // Leaflet 지도 객체
        let markers; // 마커 그룹 레이어
        let tempMarker = null; // 지도 클릭 시 생성되는 임시 마커
        let lastClickedLatLng = null; // 마지막으로 클릭된/드래그된 좌표
        let preReportCircles = []; // 사전 신고 범위 시각화 (Circle Marker)
        let isMessageBoxOpen = false;

        // --- 1. 유틸리티 함수: 메시지 박스 표시 ---
        function showMessageBox(message, type = 'info') {
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const closeBtn = box.querySelector('.message-box-close');
            
            // 스타일 초기화
            box.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden');
            box.style.color = 'white';

            // 타입별 스타일 설정
            switch (type) {
                case 'success':
                    box.classList.add('bg-green-500');
                    break;
                case 'error':
                    box.classList.add('bg-red-500');
                    break;
                case 'warning':
                    box.classList.add('bg-yellow-500');
                    box.style.color = '#333'; // 경고는 텍스트 색상을 어둡게
                    closeBtn.style.color = '#333';
                    break;
                case 'info':
                default:
                    box.classList.add('bg-blue-500');
                    break;
            }

            text.textContent = message;
            box.style.display = 'block';
            isMessageBoxOpen = true;

            // 3초 후 자동 닫기 (오류/경고는 제외)
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    if (isMessageBoxOpen) closeMessageBox();
                }, 3000);
            }
        }

        function closeMessageBox() {
            document.getElementById('message-box').style.display = 'none';
            document.getElementById('message-box').querySelector('.message-box-close').style.color = 'white'; // 색상 복구
            isMessageBoxOpen = false;
        }

        // --- 2. Leaflet 커스텀 아이콘 생성 ---

        /**
         * 연기 감지 마커 (원형 아이콘) 생성
         * @param {string} color - CSS 색상
         * @param {number} smokeLevel - 연기량 (1~100)
         * @returns {L.DivIcon}
         */
        function createSmokeIcon(color, smokeLevel) {
            const size = 30 + (smokeLevel / 100) * 20; // 연기량에 따라 크기 조절 (30px ~ 50px)
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<i class="fas fa-smog" style="color: ${color}; font-size: ${size * 0.6}px;"></i>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                style: `background-color: ${color}20; border: 2px solid ${color}; width: ${size}px; height: ${size}px;`
            });
        }

        /**
         * 시민 신고 마커 (삼각형 아이콘) 생성
         * @param {string} color - CSS 색상
         * @returns {L.DivIcon}
         */
        function createTriangleIcon(color) {
            const size = 30;
            return L.divIcon({
                className: 'custom-div-icon temp-pin-icon', // 애니메이션 미적용
                html: `<i class="fas fa-exclamation-triangle" style="color: ${color}; font-size: 24px;"></i>`,
                iconSize: [size, size],
                iconAnchor: [size / 2, size / 2],
                style: `background-color: ${color}20; border: 2px solid ${color}; width: ${size}px; height: ${size}px;`
            });
        }
        
        /**
         * 일반 핀 아이콘 생성 (모달 위치 지정용)
         */
        function createDivIcon(htmlContent, className, color) {
            return L.divIcon({
                className: `custom-div-icon ${className}`,
                html: htmlContent,
                iconSize: [35, 35],
                iconAnchor: [17, 35],
                style: `color: ${color}; background-color: white; border: 2px solid ${color};`
            });
        }

        // --- 3. 데이터 로딩 및 시각화 ---

        /**
         * 사전 신고 구역 내에 감지/신고 데이터가 있는지 확인하는 유틸리티
         * @param {number} lat - 감지/신고 위도
         * @param {number} lon - 감지/신고 경도
         * @param {number} time - 감지/신고 시간 (timestamp)
         * @param {Array<Object>} preReports - 사전 신고 목록
         * @returns {boolean} - 사전 신고 구역 내에 있으면 true
         */
        function isInPreReport(lat, lon, time, preReports) {
            const point = L.latLng(lat, lon);
            
            return preReports.some(report => {
                const center = L.latLng(report.lat, report.lon);
                const distance = center.distanceTo(point); // Leaflet의 거리 계산 (미터)
                const rangeMeters = report.rangeKm * 1000;
                
                // 시간 조건: 감지/신고 시간이 사전 신고 기간 내에 있어야 함
                const isTimeValid = time >= report.startDate && time <= report.endDate;
                
                // 거리 조건: 감지/신고 위치가 사전 신고 범위 내에 있어야 함
                const isLocationValid = distance <= rangeMeters;

                return isTimeValid && isLocationValid;
            });
        }

        /**
         * API를 호출하여 데이터를 가져와 시각화
         */
        async function fetchData() {
            showMessageBox("데이터를 지도에 불러오는 중...", 'info');
            
            try {
                // API 호출: 모든 데이터 한 번에 가져오기
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`데이터 로드 실패: [HTTP ${response.status}]`);
                }
                
                const data = await response.json();
                
                const detectionData = data.detectionData || [];
                const citizenReports = data.citizenReports || [];
                const preReports = data.preReports || [];
                
                visualizeData(detectionData, citizenReports, preReports);

                showMessageBox(`✅ 데이터 로드 완료. (감지 ${detectionData.length}, 신고 ${citizenReports.length}, 사전 ${preReports.length})`, 'success');

            } catch (error) {
                console.error('데이터 로딩 오류:', error);
                showMessageBox(`❌ 데이터 로딩 실패: ${error.message || '네트워크 오류'}`, 'error');
            }
        }

        /**
         * 데이터를 Leaflet 마커로 시각화
         */
        function visualizeData(detectionData, citizenReports, preReports) {
            // 기존 마커/레이어 제거
            if (markers) {
                map.removeLayer(markers);
            }
            markers = L.layerGroup(); // 새로운 마커 그룹 생성

            // 기존 사전 신고 범위 원 제거
            preReportCircles.forEach(circle => map.removeLayer(circle));
            preReportCircles = [];

            // A. 사전 신고 데이터 (preReports) 시각화 (범위 원형 표시)
            preReports.forEach(report => {
                const color = '#3b82f6'; // 파란색
                const circle = L.circle([report.lat, report.lon], {
                    color: color,
                    fillColor: `${color}80`, // 반투명
                    fillOpacity: 0.2,
                    radius: report.rangeKm * 1000 // Km를 Meter로 변환
                }).bindPopup(`
                    <b>[사전 신고 구역]</b><br>
                    <b>범위:</b> ${report.rangeKm} Km<br>
                    <b>기간:</b> ${new Date(report.startDate).toLocaleString()} ~ ${new Date(report.endDate).toLocaleString()}
                `).addTo(map);
                preReportCircles.push(circle);
            });


            // B. 직접 감지 데이터 (detectionData) 처리
            detectionData.forEach(row => {
                // 사전 신고 여부 확인
                const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);

                // 마커 색상 및 아이콘 결정
                const color = isReported ? '#ff8c00' : '#dc2626'; // 신고됨: 주황, 불법 의심: 빨강
                const icon = createSmokeIcon(color, row.smoke);

                const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                    <b>[직접 감지]</b><br>
                    <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                    <b>연기량:</b> ${row.smoke}<br>
                    <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                `);
                markers.addLayer(marker);
            });

            // C. 시민 신고 데이터 (citizenReports) 처리
            citizenReports.forEach(row => {
                // 사전 신고 여부 확인 (시민 신고 위치와 시간 기반)
                const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                
                // 마커 색상 및 아이콘 결정
                const color = isReported ? '#1e40af' : '#65a30d'; // 신고됨: 파랑, 불법 의심: 초록
                const icon = createTriangleIcon(color);

                const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                    <b>[시민 신고]</b><br>
                    <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                    <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🔔 단순 신고'}
                `);
                markers.addLayer(marker);
            });

            map.addLayer(markers);
        }
        
        // --- 4. 모달 열기/닫기 유틸리티 ---
        function openPreReportModal() {
            const modal = document.getElementById('preReportModal');
            modal.style.display = 'flex';
            // 마지막 클릭 좌표가 있으면 위도/경도 입력 필드에 채우기
            if (lastClickedLatLng) {
                document.getElementById('preLat').value = lastClickedLatLng.lat.toFixed(6);
                document.getElementById('preLon').value = lastClickedLatLng.lng.toFixed(6);
            }
        }

        function closePreReportModal() {
            document.getElementById('preReportModal').style.display = 'none';
        }

        function openAddDetectionModal() {
            const modal = document.getElementById('addDetectionModal');
            modal.style.display = 'flex';
            // 마지막 클릭 좌표가 있으면 위도/경도 입력 필드에 채우기
            if (lastClickedLatLng) {
                document.getElementById('detLat').value = lastClickedLatLng.lat.toFixed(6);
                document.getElementById('detLon').value = lastClickedLatLng.lng.toFixed(6);
            }
            // 현재 시각으로 설정
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('detTime').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        function closeAddDetectionModal() {
            document.getElementById('addDetectionModal').style.display = 'none';
        }
        
        // --- 5. 데이터 제출 API 호출 함수 ---

        // Unix Timestamp (ms) 변환 유틸리티
        function toTimestamp(dateTimeLocalString) {
            // Input format: YYYY-MM-DDTHH:MM
            return new Date(dateTimeLocalString).getTime();
        }


        /**
         * 사전 신고 데이터 제출
         */
        async function submitPreReport(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('preSubmitBtn');
            submitBtn.disabled = true;

            const lat = parseFloat(document.getElementById('preLat').value);
            const lon = parseFloat(document.getElementById('preLon').value);
            const rangeKm = parseFloat(document.getElementById('preRangeKm').value);
            const startDateStr = document.getElementById('preStartDate').value;
            const endDateStr = document.getElementById('preEndDate').value;

            if (isNaN(lat) || isNaN(lon) || !startDateStr || !endDateStr) {
                showMessageBox("위도, 경도, 시작/종료 일시를 모두 입력해주세요.", 'warning');
                submitBtn.disabled = false;
                return;
            }
            
            const startDate = toTimestamp(startDateStr);
            const endDate = toTimestamp(endDateStr);

            if (endDate <= startDate) {
                showMessageBox("종료 일시는 시작 일시보다 늦어야 합니다.", 'warning');
                submitBtn.disabled = false;
                return;
            }

            showMessageBox("사전 신고 접수 중...", 'info');
            
            const payload = { lat, lon, rangeKm, startDate, endDate };

            try {
                const response = await fetch('/api/add/pre', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closePreReportModal();

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`✅ 사전 신고 접수 성공! (ID: ${result.id})`, 'success');
                    fetchData(); // 성공 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessageBox(`❌ 사전 신고 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("❌ 네트워크 연결 오류: 서버와 통신할 수 없습니다.", 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }

        /**
         * 감지 데이터 수동 추가
         */
        async function submitDetectionData(event) {
            event.preventDefault();
            const submitBtn = document.getElementById('detSubmitBtn');
            submitBtn.disabled = true;

            const lat = parseFloat(document.getElementById('detLat').value);
            const lon = parseFloat(document.getElementById('detLon').value);
            const smoke = parseInt(document.getElementById('detSmoke').value, 10);
            const timeStr = document.getElementById('detTime').value;

            if (isNaN(lat) || isNaN(lon) || isNaN(smoke) || !timeStr) {
                showMessageBox("위도, 경도, 연기량, 감지 시각을 모두 입력해주세요.", 'warning');
                submitBtn.disabled = false;
                return;
            }
            
            const time = toTimestamp(timeStr);

            showMessageBox("감지 데이터 추가 중...", 'info');

            const payload = { lat, lon, smoke, time };

            try {
                const response = await fetch('/api/add/detection', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                closeAddDetectionModal();

                if (response.ok) {
                    const result = await response.json();
                    showMessageBox(`✅ 감지 데이터 추가 성공! (ID: ${result.id})`, 'success');
                    fetchData(); // 성공 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({}));
                    showMessageBox(`❌ 데이터 추가 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error("Fetch Error:", error);
                showMessageBox("❌ 네트워크 연결 오류: 서버와 통신할 수 없습니다.", 'error');
            } finally {
                submitBtn.disabled = false;
            }
        }
        
        // --- 6. 지도 클릭 및 드래그 이벤트 (임시 핀 및 좌표 저장) ---
        function setupMapEvents() {
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. 기존 임시 마커 제거
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. 새 임시 마커 생성 (파란색 핀) - draggable: true 추가
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>클릭된 위치:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. 드래그 이벤트 리스너 추가
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // 전역 좌표 업데이트
                    
                    // 팝업 내용 업데이트
                    marker.setPopupContent(`<b>드래그된 위치:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // 모달이 열려있는 경우, 좌표 필드 업데이트
                    updateModalLatLng(position);
                });

                // 모달이 열려있는 경우, 좌표 필드 업데이트
                updateModalLatLng(lastClickedLatLng);
            });
        }
        
        function updateModalLatLng(position) {
            const preModalOpen = document.getElementById('preReportModal').style.display === 'flex';
            const detModalOpen = document.getElementById('addDetectionModal').style.display === 'flex';

            if (preModalOpen) {
                document.getElementById('preLat').value = position.lat.toFixed(6);
                document.getElementById('preLon').value = position.lng.toFixed(6);
            }
            if (detModalOpen) {
                document.getElementById('detLat').value = position.lat.toFixed(6);
                document.getElementById('detLon').value = position.lng.toFixed(6);
            }
        }
        
        // --- 7. 데이터 전체 삭제 (주의 필요) ---

        /**
         * 데이터 전체 삭제 확인
         */
        function confirmDeleteAllData() {
            // 경고 메시지를 표시하는 메시지 박스 사용
            const box = document.getElementById('message-box');
            const text = document.getElementById('message-text');
            const closeBtn = box.querySelector('.message-box-close');
            
            box.classList.remove('bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 'hidden');
            box.classList.add('bg-red-700');
            box.style.color = 'white';
            closeBtn.style.color = 'white';
            
            text.innerHTML = `
                <div class="text-xl mb-4">🚨 경고: 모든 데이터를 삭제하시겠습니까?</div>
                <div class="mb-6">이 작업은 되돌릴 수 없습니다. Firestore 데이터베이스의<br>
                'detectionData', 'citizenReports', 'preReports' 컬렉션의<br>
                모든 문서가 삭제됩니다.</div>
                <button id="finalDeleteBtn" class="bg-white hover:bg-gray-200 text-red-700 font-bold py-2 px-4 rounded-lg mr-3 shadow-lg" onclick="deleteAllData()">
                    예, 모두 삭제합니다
                </button>
                <button class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-lg" onclick="closeMessageBox()">
                    취소
                </button>
            `;
            box.style.display = 'block';
            isMessageBoxOpen = true; // 자동 닫기 방지
        }

        /**
         * 데이터 전체 삭제 실행
         */
        async function deleteAllData() {
            closeMessageBox(); // 확인 모달 닫기
            showMessageBox("데이터 삭제 중...", 'info');
            
            try {
                // index.js에 구현된 모든 데이터 삭제 API 호출
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('✅ 데이터베이스의 모든 데이터가 성공적으로 삭제되었습니다.', 'success');
                    fetchData(); // 삭제 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 삭제 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error('삭제 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 삭제에 실패했습니다.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. 초기화 ---

        function initializeMap() {
            // 서울 시청을 중심으로 지도 초기화
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 지도 이벤트 설정
            setupMapEvents();

            // 데이터 불러오기
            fetchData();
        }

        // --- 9. 시작 ---
        window.onload = initializeMap;

    </script>
</body>
</html>
