<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불법 소각 감지 지도</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { 
            flex-grow: 1; 
            width: 100%; 
            z-index: 0; 
            position: relative; /* 범례를 포함하기 위해 relative 설정 */
        }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none; /* for <a> tag */
            color: white;
            font-size: 0.9rem;
        }
        .action-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        /* [수정] 직접 감지 데이터 추가 버튼 스타일 */
        .action-btn.primary { background-color: #059669; } /* Green for Add Direct Data */
        .action-btn.secondary { background-color: #f59e0b; } /* Amber for Report */
        .action-btn.success { background-color: #10b981; } /* Green for Pre-Report */
        .action-btn.danger { background-color: #dc2626; } /* Red for Delete All */

        /* Custom Marker Icon Styles */
        .circle-icon {
            border-radius: 50%;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border: 2px solid white;
        }

        .triangle-icon {
            /* Using a div and Font Awesome for a distinctive pin look */
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            color: white;
            font-size: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            border-radius: 50%;
        }

        /* 임시 핀 아이콘 스타일 */
        .temp-pin-icon {
            font-size: 24px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
            color: #1e40af; /* 파란색 */
        }
        
        /* MessageBox Styles */
        #messageBox {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            text-align: center;
            min-width: 300px;
            font-weight: bold;
            display: none;
            color: #333;
        }

        #messageBox.info { background-color: #bfdbfe; border: 2px solid #3b82f6; }
        #messageBox.success { background-color: #d1fae5; border: 2px solid #10b981; }
        #messageBox.error { background-color: #fee2e2; border: 2px solid #ef4444; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            backdrop-filter: blur(3px);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 90%;
            position: relative;
        }
        .modal-content h2 {
            margin-top: 0;
            /* [수정] 직접 감지 모달 헤더 색상 변경 */
            color: #059669; 
            border-bottom: 2px solid #d1fae5;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        .modal-content label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #4b5563;
            font-size: 0.9rem;
        }
        .modal-content input, .modal-content select {
            width: 100%;
            padding: 8px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box;
        }
        .modal-content button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            /* [수정] 직접 감지 모달 버튼 색상 변경 */
            background-color: #059669;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-content button:hover:not(:disabled) {
            background-color: #047857;
        }
        .modal-content button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            line-height: 1;
        }
        .close:hover,
        .close:focus {
            color: #333;
            text-decoration: none;
        }

        /* --- New Legend Styles (범례 스타일) --- */
        .legend {
            position: absolute;
            bottom: 20px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000; /* Ensure it's above the map */
            max-width: 250px;
            line-height: 1.6;
        }
        .legend h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1rem;
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 5px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .legend-icon {
            width: 14px;
            height: 14px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        /* Icon Shapes */
        .legend-icon.circle {
            border-radius: 50%;
        }
        .legend-icon.triangle {
            width: 0;
            height: 0;
            background: none; /* No background needed for CSS triangle */
            box-shadow: none;
            border-left: 7px solid transparent;
            border-right: 7px solid transparent;
            /* Color is set via specific class */
            border-bottom-width: 14px;
            border-bottom-style: solid;
        }
        .legend-icon.square {
            border-radius: 4px;
            box-shadow: none;
            color: inherit; /* Inherit color for the pin icon */
            font-size: 1.2rem;
            width: auto;
            height: auto;
        }
        /* Icon Colors */
        .legend-icon.red { background-color: #dc2626; border-bottom-color: #dc2626; }
        .legend-icon.orange { background-color: #ff8c00; border-bottom-color: #ff8c00; }
        .legend-icon.blue { color: #1e40af; } /* Pin icon color */

        /* Pre-Report Area Visual */
        .legend-icon.area {
             width: 14px;
             height: 14px;
             border: 2px solid #10b981; /* Green border */
             background-color: rgba(16, 185, 129, 0.3); /* Transparent Green fill */
             border-radius: 50%;
             box-shadow: none;
        }
    </style>
</head>
<body>
    <h1>불법 소각 감지 지도 (Illegal Burning Detection Map)</h1>
    <div class="control-panel">
        <!-- [수정] 버튼 이름 및 ID 변경 -->
        <button id="addDirectDataBtn" class="action-btn primary"><i class="fas fa-microchip"></i> 직접 감지 데이터 추가</button>
        <a href="citizen_report.html" class="action-btn secondary"><i class="fas fa-bullhorn"></i> 신고하기</a>
        <button id="addPreReportBtn" class="action-btn success"><i class="fas fa-calendar-check"></i> 소각 사전 신고</button>
        <button id="deleteAllBtn" class="action-btn danger"><i class="fas fa-trash-alt"></i> 데이터 모두 삭제 (Admin)</button>
    </div>

    <div id="map">
        <!-- 지도 레전드 (범례) -->
        <div class="legend">
            <h3>지도 범례 (Legend)</h3>
            
            <!-- A. 직접 감지 (Direct Detection - Circle) -->
            <div class="legend-item">
                <div class="legend-icon circle red"></div>
                직접 감지 (🚨 불법 소각 의심)
            </div>
            <div class="legend-item">
                <div class="legend-icon circle orange"></div>
                직접 감지 (✅ 사전 신고됨)
            </div>

            <!-- B. 시민 신고 (Citizen Report - Triangle) -->
            <div class="legend-item">
                <div class="legend-icon triangle red"></div>
                시민 신고 (🚨 불법 소각 의심)
            </div>
            <div class="legend-item">
                <div class="legend-icon triangle orange"></div>
                시민 신고 (✅ 사전 신고됨)
            </div>

            <!-- C. 사전 신고 구역 (Pre-Report Area - L.Circle) -->
            <div class="legend-item">
                <div class="legend-icon area"></div>
                사전 신고 구역 (반경)
            </div>

            <!-- D. 지도 클릭 위치 (Temporary Pin) -->
            <div class="legend-item">
                <div class="legend-icon square blue"><i class="fas fa-thumbtack"></i></div>
                임시 위치 핀 (클릭/드래그)
            </div>
        </div>
    </div>

    <!-- [추가] 직접 감지 데이터 입력 모달 (Direct Data Input Modal) -->
    <div id="directDataModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDirectDataModal()">&times;</span>
            <h2><i class="fas fa-fire-alt"></i> 직접 감지 데이터 입력</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #6b7280;">
                선택된 위치에 대한 온도와 연기량을 입력합니다.
            </p>
            <form id="directDataForm">
                <label for="directLat">위도 (Latitude):</label>
                <input type="text" id="directLat" name="directLat" required readonly>
                
                <label for="directLon">경도 (Longitude):</label>
                <input type="text" id="directLon" name="directLon" required readonly>

                <label for="temperature">온도 (°C):</label>
                <!-- 온도 입력 필드 추가 -->
                <input type="number" id="temperature" name="temperature" placeholder="온도를 입력하세요 (예: 50.5)" step="0.1" min="0" required>

                <label for="smokeLevel">연기량 (0-100):</label>
                <!-- 연기량 입력 필드 추가 -->
                <input type="number" id="smokeLevel" name="smokeLevel" placeholder="연기량을 입력하세요 (0-100)" min="0" max="100" required>

                <button type="submit" id="directDataSubmitBtn"><i class="fas fa-upload"></i> 감지 데이터 등록</button>
            </form>
        </div>
    </div>
    
    <!-- 소각 사전 신고 모달 (Pre-Report Modal) -->
    <div id="preReportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePreReportModal()">&times;</span>
            <h2><i class="fas fa-calendar-check"></i> 소각 사전 신고</h2>
            <p style="margin-bottom: 20px; font-size: 0.9rem; color: #6b7280;">
                지도를 클릭하여 위치를 선택하고 소각 예정 정보를 입력해주세요.
            </p>
            <form id="preReportForm">
                <label for="preLat">위도 (Latitude):</label>
                <input type="text" id="preLat" name="preLat" required readonly>
                
                <label for="preLon">경도 (Longitude):</label>
                <input type="text" id="preLon" name="preLon" required readonly>

                <label for="preStartDate">시작일시 (Start Date/Time):</label>
                <input type="datetime-local" id="preStartDate" name="preStartDate" required>

                <label for="preEndDate">종료일시 (End Date/Time):</label>
                <input type="datetime-local" id="preEndDate" name="preEndDate" required>

                <label for="preRangeKm">영향 반경 (Km):</label>
                <input type="number" id="preRangeKm" name="preRangeKm" value="0.1" min="0.01" step="0.01" required>

                <button type="submit" id="preReportSubmitBtn"><i class="fas fa-upload"></i> 신고 등록</button>
            </form>
        </div>
    </div>

    <!-- 메시지 박스 -->
    <div id="messageBox"></div>

    <script>
        // --- 1. 전역 변수 설정 ---
        let map;
        let markers = new L.LayerGroup();
        let preReportsCircles = new L.LayerGroup(); // 사전 신고 구역 표시용
        let lastClickedLatLng = null; // 마지막 클릭된 좌표 저장
        let tempMarker = null; // 지도 클릭 시 임시 마커 저장

        // --- 2. Leaflet Custom Icon 생성 함수 (DivIcon 사용) ---
        
        // 🛠️ 임시 핀 및 일반 마커에 사용되는 기본 DivIcon 생성 함수
        function createDivIcon(htmlContent, className, color) {
            return L.divIcon({
                // htmlContent를 클래스 내부가 아닌, 직접 DivIcon의 HTML로 사용 (이전 템플릿과 충돌 방지)
                html: `<div class="${className}" style="color: ${color};">${htmlContent}</div>`,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [0, 24], // 핀의 아래쪽 끝을 좌표에 맞춤
                popupAnchor: [10, -20]
            });
        }
        
        // 직접 감지용 원형 아이콘 생성 (실제 마커 렌더링에 사용)
        function createCircleIcon(color) {
            return L.divIcon({
                html: `<div class="circle-icon" style="background-color: ${color};">S</div>`,
                className: 'custom-div-icon',
                iconSize: [24, 24],
                iconAnchor: [12, 12],
                popupAnchor: [0, -10]
            });
        }

        // 시민 신고용 아이콘 (핀 모양으로 대체)
        function createTriangleIcon(color) {
             return L.divIcon({
                html: `<div class="triangle-icon" style="background-color: ${color};"><i class="fas fa-map-pin"></i></div>`,
                className: 'custom-div-icon',
                iconSize: [24, 30],
                iconAnchor: [12, 30],
                popupAnchor: [0, -25]
            });
        }

        // --- 3. 유틸리티 함수 (거리 및 시간 비교) ---

        /**
         * 두 좌표 간의 거리를 킬로미터(Km) 단위로 계산합니다.
         */
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 지구 반지름 (킬로미터)
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // 거리 (Km)
        }

        /**
         * 감지/신고 데이터가 사전 신고 구역 및 시간 범위 내에 있는지 확인합니다.
         */
        function isInPreReport(lat, lon, time, preReports) {
            if (!Array.isArray(preReports) || preReports.length === 0) {
                return false;
            }
            
            return preReports.some(pre => {
                const distance = calculateDistance(lat, lon, pre.lat, pre.lon);
                const isWithinRange = distance <= pre.rangeKm;
                const isWithinTime = time >= pre.startDate && time <= pre.endDate;
                
                return isWithinRange && isWithinTime;
            });
        }

        // --- 4. 메시지 박스 및 모달 제어 함수 ---

        function showMessageBox(message, type) {
            const box = document.getElementById('messageBox');
            box.textContent = message;
            box.className = ''; // 기존 클래스 제거
            box.classList.add(type);
            box.style.display = 'block';
            setTimeout(() => {
                box.style.display = 'none';
            }, 4000); // 4초 후 자동 숨김
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
        }
        
        // [추가] 직접 감지 데이터 모달 제어
        const directDataModal = document.getElementById('directDataModal');
        const directLatInput = document.getElementById('directLat');
        const directLonInput = document.getElementById('directLon');
        const directDataSubmitBtn = document.getElementById('directDataSubmitBtn');

        function openDirectDataModal() {
             if (lastClickedLatLng) {
                directLatInput.value = lastClickedLatLng.lat.toFixed(6);
                directLonInput.value = lastClickedLatLng.lng.toFixed(6);
                directDataModal.style.display = 'flex';
            } else {
                showMessageBox("🚨 지도를 클릭하여 감지 위치를 먼저 선택해주세요.", 'error');
            }
        }

        function closeDirectDataModal() {
            directDataModal.style.display = 'none';
        }


        // 사전 신고 모달 제어
        const preReportModal = document.getElementById('preReportModal');
        const preLatInput = document.getElementById('preLat');
        const preLonInput = document.getElementById('preLon');
        const preReportSubmitBtn = document.getElementById('preReportSubmitBtn');

        function openPreReportModal() {
            if (lastClickedLatLng) {
                preLatInput.value = lastClickedLatLng.lat.toFixed(6);
                preLonInput.value = lastClickedLatLng.lng.toFixed(6);
                preReportModal.style.display = 'flex';
            } else {
                showMessageBox("🚨 지도를 클릭하여 소각 예정 위치를 먼저 선택해주세요.", 'error');
            }
        }

        function closePreReportModal() {
            preReportModal.style.display = 'none';
        }

        // --- 5. 데이터 Fetch 및 시각화 함수 ---
        
        // 서버에서 모든 데이터 (감지, 신고, 사전신고)를 가져와 지도에 표시
        async function fetchData() {
            try {
                showMessageBox("데이터를 불러오는 중입니다...", 'info');
                
                const response = await fetch('/api/data');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // 🛠️ 데이터 유효성 검사 추가 (null/undefined/non-array 처리)
                const directDetections = Array.isArray(data.directDetections) ? data.directDetections : [];
                const citizenReports = Array.isArray(data.citizenReports) ? data.citizenReports : [];
                const preReports = Array.isArray(data.preReports) ? data.preReports : [];
                
                showMessageBox(`✅ 데이터 로딩 완료! (감지: ${directDetections.length}, 신고: ${citizenReports.length})`, 'success');
                visualizeData(directDetections, citizenReports, preReports);

            } catch (error) {
                console.error('데이터 로딩 오류:', error);
                showMessageBox('❌ 데이터를 불러오는 데 실패했습니다. 서버 상태를 확인하세요.', 'error');
            }
        }

        // 지도 시각화
        function visualizeData(directDetections, citizenReports, preReports) {
            try {
                // 기존 마커 및 원 제거
                markers.clearLayers();
                preReportsCircles.clearLayers();

                // A. 사전 신고 구역 (preReports) 시각화 (L.Circle)
                preReports.forEach(pre => {
                    // Km를 미터로 변환 (Leaflet CircleMarker는 미터 단위)
                    const radiusMeters = pre.rangeKm * 1000; 

                    // 사전 신고 구역을 반투명한 녹색 원으로 표시
                    const circle = L.circle([pre.lat, pre.lon], {
                        color: '#10b981', // Green
                        fillColor: '#10b981',
                        fillOpacity: 0.3,
                        radius: radiusMeters 
                    }).bindPopup(`
                        <b>[사전 신고 구역]</b><br>
                        <b>시작:</b> ${new Date(pre.startDate).toLocaleString()}<br>
                        <b>종료:</b> ${new Date(pre.endDate).toLocaleString()}<br>
                        <b>반경:</b> ${pre.rangeKm} Km
                    `);
                    preReportsCircles.addLayer(circle);
                });
                map.addLayer(preReportsCircles);

                // B. 직접 감지 데이터 (directDetections) 처리
                directDetections.forEach(row => {
                    // 데이터가 유효한지 재확인 (혹시 모를 상황 대비)
                    if (row.lat && row.lon && row.time) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        
                        // 신고 여부에 따라 마커 색상 결정
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createCircleIcon(color);

                        // 온도 정보 추가
                        const temperature = row.temperature !== undefined ? `${row.temperature}°C` : 'N/A';

                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[직접 감지]</b><br>
                            <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>온도:</b> ${temperature}<br>
                            <b>연기량:</b> ${row.smoke}<br>
                            <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // C. 시민 신고 데이터 (citizenReports) 처리
                citizenReports.forEach(row => {
                     // 데이터가 유효한지 재확인
                    if (row.lat && row.lon && row.time) {
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        
                        // 신고 여부에 따라 마커 색상 결정
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createTriangleIcon(color);

                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[시민 신고]</b><br>
                            <b>시간:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>신고 여부:</b> ${isReported ? '✅ 사전 신고됨' : '🚨 불법 소각 의심'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('데이터 로딩 및 시각화 오류:', error);
            }
        }
        
        /**
         * 💡 모든 데이터 삭제 (관리자용)
         */
        async function deleteAllData() {
            showMessageBox("데이터 삭제 중...", 'info');
            
            try {
                // index.js에 구현된 모든 데이터 삭제 API 호출
                const response = await fetch('/api/delete/all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showMessageBox('✅ 데이터베이스의 모든 데이터가 성공적으로 삭제되었습니다.', 'success');
                    fetchData(); // 삭제 후 지도 새로고침
                } else {
                    const errorData = await response.json().catch(() => ({})); 
                    showMessageBox(`❌ 삭제 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                }
            } catch (error) {
                console.error('삭제 API 호출 오류:', error);
                showMessageBox('❌ 네트워크 오류 또는 서버 응답 오류로 삭제에 실패했습니다.', 'error');
            }
        }
        // ----------------------------------------------------


        // --- 8. 초기화 ---

        function initializeMap() {
            // 서울 시청을 중심으로 지도 초기화
            map = L.map('map').setView([37.5665, 126.9780], 12); 

            // OSM 타일 레이어 추가
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // 초기 데이터 로드
            fetchData();
            
            
            // --- 6. 지도 클릭 및 드래그 이벤트 (임시 핀 및 좌표 저장) ---
            map.on('click', (e) => {
                lastClickedLatLng = e.latlng;

                // 1. 기존 임시 마커 제거
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }

                // 2. 새 임시 마커 생성 (파란색 핀) - draggable: true 추가
                const pinIcon = createDivIcon('<i class="fas fa-thumbtack"></i>', 'temp-pin-icon', '#1e40af'); // Dark Blue Pin
                
                tempMarker = L.marker(lastClickedLatLng, { icon: pinIcon, draggable: true }).addTo(map);
                tempMarker.bindPopup(`<b>클릭된 위치:</b><br>Lat: ${lastClickedLatLng.lat.toFixed(6)}<br>Lon: ${lastClickedLatLng.lng.toFixed(6)}`).openPopup();
                
                // 3. 드래그 이벤트 리스너 추가
                tempMarker.on('dragend', function(event) {
                    const marker = event.target;
                    const position = marker.getLatLng();
                    lastClickedLatLng = position; // 전역 좌표 업데이트
                    
                    // 팝업 내용 업데이트
                    marker.setPopupContent(`<b>드래그된 위치:</b><br>Lat: ${position.lat.toFixed(6)}<br>Lon: ${position.lng.toFixed(6)}`).openPopup();

                    // 모달이 열려있는 경우, 좌표 필드 업데이트
                    if (preReportModal.style.display === 'flex') {
                        preLatInput.value = position.lat.toFixed(6);
                        preLonInput.value = position.lng.toFixed(6);
                    }
                     // [추가] 직접 감지 모달이 열려있는 경우, 좌표 필드 업데이트
                     if (directDataModal.style.display === 'flex') {
                        directLatInput.value = position.lat.toFixed(6);
                        directLonInput.value = position.lng.toFixed(6);
                    }
                });

                // 모달이 열려있는 경우, 좌표 필드 업데이트
                if (preReportModal.style.display === 'flex') {
                    preLatInput.value = lastClickedLatLng.lat.toFixed(6);
                    preLonInput.value = lastClickedLatLng.lng.toFixed(6);
                }
                // [추가] 직접 감지 모달이 열려있는 경우, 좌표 필드 업데이트
                if (directDataModal.style.display === 'flex') {
                    directLatInput.value = lastClickedLatLng.lat.toFixed(6);
                    directLonInput.value = lastClickedLatLng.lng.toFixed(6);
                }
            });


            // --- 7. 이벤트 리스너 및 API 호출 (버튼) ---
            
            // [수정] 직접 감지 데이터 추가 버튼 (Modal Open)
            document.getElementById('addDirectDataBtn').addEventListener('click', openDirectDataModal);
            
            // [추가] 직접 감지 데이터 폼 제출 처리
            document.getElementById('directDataForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                directDataSubmitBtn.disabled = true;

                const form = e.target;
                const lat = parseFloat(form.directLat.value);
                const lon = parseFloat(form.directLon.value);
                // [수정] 온도 및 연기량 값 가져오기
                const temperature = parseFloat(form.temperature.value);
                const smoke = parseInt(form.smokeLevel.value);

                if (isNaN(temperature) || isNaN(smoke) || smoke < 0 || smoke > 100) {
                    showMessageBox("🚨 온도 또는 연기량 입력값이 올바르지 않습니다.", 'error');
                    directDataSubmitBtn.disabled = false;
                    return;
                }

                showMessageBox("직접 감지 데이터 등록 중...", 'info');

                const payload = {
                    lat, 
                    lon, 
                    temperature, // 온도 추가
                    smoke,       // 연기량 추가
                    time: Date.now() 
                };

                try {
                    const response = await fetch('/api/add/direct', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        closeDirectDataModal();
                        showMessageBox('✅ 직접 감지 데이터가 성공적으로 추가되었습니다.', 'success');
                        fetchData(); // 성공 후 지도 새로고침
                    } else {
                        const errorData = await response.json().catch(() => ({})); 
                        showMessageBox(`❌ 추가 실패: ${errorData.message || errorData.error || '서버 오류. 콘솔 확인.'}`, 'error');
                        console.error('Add Direct API Error:', errorData);
                    }
                } catch (error) {
                    console.error('API 호출 오류:', error);
                    showMessageBox('❌ 네트워크 오류로 데이터 추가에 실패했습니다.', 'error');
                } finally {
                    directDataSubmitBtn.disabled = false;
                }
            });

            // 사전 신고 버튼 (Modal Open)
            document.getElementById('addPreReportBtn').addEventListener('click', openPreReportModal);

            // 사전 신고 폼 제출 처리
            document.getElementById('preReportForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                preReportSubmitBtn.disabled = true;

                const form = e.target;
                const lat = parseFloat(form.preLat.value);
                const lon = parseFloat(form.preLon.value);
                const startDate = new Date(form.preStartDate.value).getTime();
                const endDate = new Date(form.preEndDate.value).getTime();
                const rangeKm = parseFloat(form.preRangeKm.value);

                if (startDate >= endDate) {
                    showMessageBox("🚨 종료 일시는 시작 일시보다 늦어야 합니다.", 'error');
                    preReportSubmitBtn.disabled = false;
                    return;
                }

                showMessageBox("소각 사전 신고 정보 등록 중...", 'info');
                
                const payload = {
                    lat, lon, startDate, endDate, rangeKm
                };

                try {
                    const response = await fetch('/api/add/pre', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        closePreReportModal();
                        showMessageBox('✅ 소각 사전 신고가 성공적으로 등록되었습니다.', 'success');
                        fetchData(); // 성공 후 지도 새로고침
                    } else {
                        const errorData = await response.json().catch(() => ({})); 
                        showMessageBox(`❌ 등록 실패: ${errorData.message || errorData.error || '서버 오류'}`, 'error');
                    }
                } catch (error) {
                    console.error('API 호출 오류:', error);
                    showMessageBox('❌ 네트워크 오류로 신고 등록에 실패했습니다.', 'error');
                } finally {
                    preReportSubmitBtn.disabled = false;
                }
            });
            
            // 데이터 모두 삭제 버튼 (Admin)
            document.getElementById('deleteAllBtn').addEventListener('click', () => {
                // 경고 메시지 대신 메시지 박스를 사용
                const confirmMessage = "⚠️ 경고: 데이터베이스의 모든 데이터를 영구적으로 삭제하시겠습니까? (되돌릴 수 없습니다!)";
                showMessageBox(confirmMessage, 'error');

                // 간소화된 버전: 바로 삭제 함수 호출 (실제 환경에서는 인증 필요)
                if (window.confirm("정말로 모든 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) {
                    deleteAllData();
                }
            });
        }

        window.onload = initializeMap;

    </script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  try {
    if (typeof initializeMap === 'function') {
      initializeMap();
    } else {
      console.error('initializeMap 함수가 정의되어 있지 않습니다.');
    }
  } catch (e) {
    console.error('지도 초기화 중 오류:', e);
    if (typeof showMessageBox === 'function') {
      showMessageBox('❌ 지도 초기화 오류: ' + (e.message || e), 'error');
    }
  }
});
</script>
</body>
</html>
