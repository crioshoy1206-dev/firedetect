<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>불법 소각 감지 대시보드</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Noto Sans KR', 'Inter', sans-serif; 
            background-color: #f3f4f6; 
            color: #1f2937;
        }
        #map { 
            height: 400px; 
            width: 100%; 
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); 
            margin-bottom: 2rem;
        }
        .container { 
            max-width: 1000px; 
            margin: 2rem auto; 
            padding: 1.5rem; 
            background: white; 
            border-radius: 1rem;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }
        h1 { font-weight: 700; color: #dc2626; font-size: 2.25rem; }
        .subtitle { color: #4b5563; margin-bottom: 1.5rem; }

        /* Admin Tools Styles */
        .admin-tools {
            padding: 1rem;
            margin-bottom: 2rem;
            border: 2px solid #fca5a5;
            border-radius: 0.5rem;
            background-color: #fee2e2;
            color: #991b1b;
        }
        .admin-tools h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: #dc2626;
        }
        .admin-danger-btn {
            background-color: #dc2626;
            color: white;
            padding: 10px 15px;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: background-color 0.2s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .admin-danger-btn:hover { background-color: #991b1b; }
        .admin-danger-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .report-legend {
            display: flex;
            gap: 1.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #4b5563;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center">불법 소각 감지 대시보드</h1>
        <p class="subtitle text-center">실시간 드론 감지 및 시민 신고 현황</p>

        <!-- 관리자 도구 섹션 -->
        <div class="admin-tools">
            <h2>🧑‍💻 관리자 도구</h2>
            <p>주의: 이 버튼은 **모든 시민 신고 데이터**를 영구적으로 삭제합니다.</p>
            <button class="admin-danger-btn" id="cleanup-btn" onclick="confirmDataCleanup()">🚨 모든 신고 데이터 일괄 삭제</button>
        </div>
        <!-- 끝: 관리자 도구 섹션 -->
        
        <div class="report-legend">
            <span>🔴 드론 감지</span>
            <span>🔥 시민 신고</span>
        </div>
        
        <div id="map"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-gray-100 p-4 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-2 text-red-600">최근 감지 현황 (드론)</h3>
                <ul id="drone-list" class="space-y-2 text-sm">
                    <!-- 드론 감지 데이터가 여기에 로드됩니다. -->
                    <li><div class="text-gray-500">데이터를 로딩 중...</div></li>
                </ul>
            </div>
            <div class="bg-gray-100 p-4 rounded-lg shadow">
                <h3 class="font-bold text-lg mb-2 text-orange-600">최근 신고 현황 (시민)</h3>
                <ul id="citizen-list" class="space-y-2 text-sm">
                    <!-- 시민 신고 데이터가 여기에 로드됩니다. -->
                    <li><div class="text-gray-500">데이터를 로딩 중...</div></li>
                </ul>
            </div>
        </div>

    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // API 엔드포인트
        const API_GET_DRONE = "/api/get/drone";
        const API_GET_CITIZENS = "/api/get/citizens";
        const API_DELETE_ALL = "/api/delete/citizens/all"; // 새 관리자 엔드포인트

        const INITIAL_VIEW = [37.5665, 126.9780]; // 서울 시청
        const INITIAL_ZOOM = 13;

        let map = null;
        let droneMarkers = L.layerGroup();
        let citizenMarkers = L.layerGroup();
        let isFetching = false;

        // 드론 감지 마커를 위한 커스텀 아이콘 (빨간색)
        const droneIcon = new L.DivIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color:#dc2626; width:15px; height:15px; border-radius:50%; border: 3px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);"></div>',
            iconSize: [15, 15],
            iconAnchor: [7, 7]
        });

        // 시민 신고 마커를 위한 커스텀 아이콘 (불꽃 이모지)
        const fireIcon = L.divIcon({
            className: 'fire-icon',
            html: '<span style="font-size: 18px;">🔥</span>',
            iconSize: [18, 18],
            iconAnchor: [9, 9]
        });

        /** 지도를 초기화합니다. */
        function initializeMap() {
            if (map) return;

            map = L.map('map').setView(INITIAL_VIEW, INITIAL_ZOOM);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            droneMarkers.addTo(map);
            citizenMarkers.addTo(map);

            // 맵 이동이 멈출 때마다 데이터 새로고침
            map.on('moveend', fetchAndDisplayAllReports);
            
            // 초기 데이터 로드
            fetchAndDisplayAllReports();
        }

        /** 두 종류의 신고 데이터를 모두 가져와 지도에 표시합니다. */
        async function fetchAndDisplayAllReports() {
            if (isFetching) return;
            isFetching = true;

            const center = map.getCenter();
            const bounds = map.getBounds();
            const urlParams = `?minLat=${bounds.getSouth()}&maxLat=${bounds.getNorth()}&minLon=${bounds.getWest()}&maxLon=${bounds.getEast()}`;

            try {
                // 1. 드론 감지 데이터 가져오기
                const droneResponse = await fetch(API_GET_DRONE + urlParams);
                if (droneResponse.ok) {
                    const droneReports = await droneResponse.json();
                    displayDroneReports(droneReports);
                } else {
                    console.error("드론 데이터 로드 실패:", droneResponse.status);
                }

                // 2. 시민 신고 데이터 가져오기
                const citizenResponse = await fetch(API_GET_CITIZENS);
                if (citizenResponse.ok) {
                    const citizenReports = await citizenResponse.json();
                    displayCitizenReports(citizenReports);
                } else {
                    console.error("시민 신고 데이터 로드 실패:", citizenResponse.status);
                }

            } catch (error) {
                console.error("데이터 로드 중 네트워크 오류:", error);
            } finally {
                isFetching = false;
            }
        }

        /** 드론 감지 데이터를 지도에 표시하고 목록을 업데이트합니다. */
        function displayDroneReports(reports) {
            droneMarkers.clearLayers();
            const listElement = document.getElementById('drone-list');
            listElement.innerHTML = '';
            
            if (reports.length === 0) {
                listElement.innerHTML = '<li><div class="text-gray-500">현재 드론 감지된 소각이 없습니다.</div></li>';
            }

            reports.forEach(report => {
                const lat = parseFloat(report.lat);
                const lon = parseFloat(report.lon);
                const time = new Date(report.time).toLocaleString('ko-KR');

                if (!isNaN(lat) && !isNaN(lon)) {
                    L.marker([lat, lon], {icon: droneIcon})
                        .bindPopup(`<b>드론 감지</b><br>시각: ${time}<br>위치: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
                        .addTo(droneMarkers);
                }

                const listItem = document.createElement('li');
                listItem.className = 'border-b border-gray-200 pb-2';
                listItem.innerHTML = `<span class="font-semibold text-red-700">${time}</span><br>위치: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                listElement.appendChild(listItem);
            });
        }
        
        /** 시민 신고 데이터를 지도에 표시하고 목록을 업데이트합니다. */
        function displayCitizenReports(reports) {
            citizenMarkers.clearLayers();
            const listElement = document.getElementById('citizen-list');
            listElement.innerHTML = '';
            
            if (reports.length === 0) {
                listElement.innerHTML = '<li><div class="text-gray-500">현재 접수된 시민 신고가 없습니다.</div></li>';
            }

            reports.forEach(report => {
                const lat = parseFloat(report.lat);
                const lon = parseFloat(report.lon);
                const time = new Date(report.time).toLocaleString('ko-KR');

                if (!isNaN(lat) && !isNaN(lon)) {
                    L.marker([lat, lon], {icon: fireIcon})
                        .bindPopup(`<b>시민 신고</b><br>시각: ${time}<br>위치: ${lat.toFixed(4)}, ${lon.toFixed(4)}`)
                        .addTo(citizenMarkers);
                }
                
                const listItem = document.createElement('li');
                listItem.className = 'border-b border-gray-200 pb-2';
                listItem.innerHTML = `<span class="font-semibold text-orange-700">${time}</span><br>위치: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                listElement.appendChild(listItem);
            });
        }
        
        // -------------------------------------------------------------------
        // 관리자 기능 (데이터 일괄 삭제)
        // -------------------------------------------------------------------

        /** 관리자 데이터 일괄 삭제를 확인하는 함수 */
        function confirmDataCleanup() {
            const message = "⚠️ 경고: 모든 시민 신고 데이터를 영구적으로 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다!";
            
            // window.confirm을 사용하여 사용자에게 최종 확인을 받습니다.
            if (confirm(message)) {
                deleteReportData();
            }
        }

        /** 모든 시민 신고 데이터를 삭제하는 API 호출 */
        async function deleteReportData() {
            const cleanupBtn = document.getElementById('cleanup-btn');
            const originalText = cleanupBtn.textContent;
            
            cleanupBtn.disabled = true;
            cleanupBtn.textContent = '🚨 삭제 진행 중... (잠시만 기다려주세요)';

            try {
                const response = await fetch(API_DELETE_ALL, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`✅ 성공: ${result.message}`);
                    // 삭제 후 지도 데이터 새로고침
                    fetchAndDisplayAllReports();
                } else {
                    let errorDetails = `[HTTP Status: ${response.status}] 서버 오류`;
                    try {
                        const errorData = await response.json();
                        errorDetails = errorData.message || errorData.error || errorDetails;
                    } catch (e) {
                        errorDetails = `[HTTP Status: ${response.status}] 서버 응답을 읽을 수 없습니다. (Vercel 로그 확인)`;
                    }
                    alert(`❌ 실패: ${errorDetails}`);
                }
            } catch (error) {
                console.error("Delete API Error:", error);
                alert("❌ 네트워크 오류: API 서버와 통신할 수 없습니다.");
            } finally {
                cleanupBtn.disabled = false;
                cleanupBtn.textContent = originalText;
            }
        }

        // -------------------------------------------------------------------

        window.onload = initializeMap;

    </script>
</body>
</html>
