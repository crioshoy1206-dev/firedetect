<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¶ˆë²• ì†Œê° ê°ì§€ ì§€ë„</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        body { margin: 0; font-family: 'Noto Sans KR', sans-serif; display: flex; flex-direction: column; height: 100vh; }
        h1 { text-align: center; margin: 1vh 0; font-size: 1.5rem; color: #333; }
        
        #map { flex-grow: 1; width: 100%; z-index: 0; }
        
        .control-panel { 
            display: flex; 
            justify-content: center; 
            gap: 10px; 
            padding: 10px; 
            background: #f4f4f4;
            border-bottom: 1px solid #ddd;
        }

        .action-button {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .action-button:hover { opacity: 0.9; }
        
        #btn-sensor { background-color: #3b82f6; color: white; } /* Blue */
        #btn-citizen { background-color: #22c55e; color: white; } /* Green */
        #btn-pre-report { background-color: #f59e0b; color: white; } /* Amber */

        /* ì •ë³´ ë° ìƒíƒœ í‘œì‹œ */
        .info-panel {
            position: absolute;
            top: 60px;
            right: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .status-message {
            margin-top: 10px;
            font-size: 0.85rem;
            padding: 5px;
            border-radius: 4px;
            text-align: center;
        }
        .status-message.success { background-color: #d1fae5; color: #065f46; }
        .status-message.error { background-color: #fee2e2; color: #991b1b; }
        .status-message.waiting { background-color: #fffbeb; color: #b45309; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 50px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto; 
            padding: 20px;
            border-radius: 8px;
            width: 90%; 
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .modal-content h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-content label, .modal-content input { display: block; width: 100%; margin-bottom: 10px; }
        .modal-content input[type="number"], .modal-content input[type="date"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-actions button { padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ë¶ˆë²• ì†Œê° ê°ì§€ ì‹¤ì‹œê°„ ì§€ë„</h1>

    <div class="control-panel">
        <button id="btn-sensor" class="action-button" onclick="startInput('sensor')"><i class="fas fa-microchip"></i> ì§ì ‘ ê°ì§€ ê°’ ì‹œë®¬ë ˆì´ì…˜</button>
        <button id="btn-citizen" class="action-button" onclick="startInput('citizen')"><i class="fas fa-user-edit"></i> ì‹œë¯¼ ì‹ ê³ </button>
        <button id="btn-pre-report" class="action-button" onclick="startInput('pre-report')"><i class="fas fa-flag"></i> ì†Œê° ì‚¬ì „ ì‹ ê³ </button>
    </div>

    <div id="map"></div>

    <div id="info-panel" class="info-panel">
        <p><b>ì„ íƒ ìœ„ì¹˜:</b></p>
        <p id="current-coords">ì§€ë„ë¥¼ í´ë¦­í•´ ì£¼ì„¸ìš”.</p>
        <hr>
        <div class="legend">
            <p>â— ì§ì ‘ ê°ì§€ / â–² ì‹œë¯¼ ì‹ ê³ </p>
            <span style="color: #ff8c00;">â–  ì‹ ê³ O (ì£¼í™©ìƒ‰)</span>
            <span style="color: #dc2626;">â–  ì‹ ê³ X (ë¹¨ê°„ìƒ‰)</span>
        </div>
    </div>
    
    <!-- ëª¨ë‹¬ UI -->
    <div id="input-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title"></h2>
            <div id="modal-form-content"></div>
            <p id="modal-coords"></p>
            <div class="modal-actions">
                <button onclick="closeModal()">ì·¨ì†Œ</button>
                <button id="submit-data" style="background-color: #3b82f6; color: white;">ë“±ë¡</button>
            </div>
            <div id="modal-status" class="status-message" style="display: none;"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        const map = L.map('map').setView([37.5665, 126.9780], 12); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const markers = L.markerClusterGroup();
        map.addLayer(markers);

        let currentInputType = null;
        let selectedCoords = null;
        let tempMarker = null; // ì„ì‹œ ë§ˆì»¤

        // DOM ìš”ì†Œ ìºì‹œ
        const currentCoordsEl = document.getElementById('current-coords');
        const modalEl = document.getElementById('input-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const modalFormContentEl = document.getElementById('modal-form-content');
        const modalCoordsEl = document.getElementById('modal-coords');
        const modalStatusEl = document.getElementById('modal-status');
        const submitButton = document.getElementById('submit-data');


        // ---------------------------------------------------------------------
        // 1. ì»¤ìŠ¤í…€ ì•„ì´ì½˜ íŒ©í† ë¦¬ (ì´ì „ ì½”ë“œì™€ ë™ì¼)
        // ---------------------------------------------------------------------

        const createCircleIcon = (color) => L.divIcon({
            html: `<svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="8" fill="${color}" stroke="black" stroke-width="1.5"/></svg>`,
            className: 'circle-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10], 
            popupAnchor: [0, -10]
        });

        const createTriangleIcon = (color) => L.divIcon({
            html: `<svg width="20" height="20" viewBox="0 0 100 100" class="triangle-icon"><polygon points="50,10 90,90 10,90" fill="${color}" stroke="black" stroke-width="5"/></svg>`,
            className: 'triangle-icon',
            iconSize: [20, 20],
            iconAnchor: [10, 10], 
            popupAnchor: [0, -10]
        });


        // ---------------------------------------------------------------------
        // 2. ì§€ë„ í´ë¦­ ë° ì…ë ¥ ìƒíƒœ ê´€ë¦¬
        // ---------------------------------------------------------------------

        map.on('click', (e) => {
            const lat = e.latlng.lat.toFixed(6);
            const lon = e.latlng.lng.toFixed(6);
            selectedCoords = { lat: parseFloat(lat), lon: parseFloat(lon) };
            
            currentCoordsEl.innerHTML = `ìœ„ë„: ${lat}, ê²½ë„: ${lon}`;

            // ì„ì‹œ ë§ˆì»¤ í‘œì‹œ
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            tempMarker = L.marker(selectedCoords, {
                icon: L.divIcon({ className: 'current-selection', html: '<i class="fas fa-map-marker-alt" style="color:#007bff; font-size:24px;"></i>' })
            }).addTo(map);

            // ì…ë ¥ ëª¨ë“œë¼ë©´ ëª¨ë‹¬ ì—´ê¸°
            if (currentInputType) {
                openModal(currentInputType);
                currentInputType = null; // ëª¨ë‹¬ì„ ì—´ì—ˆìœ¼ë¯€ë¡œ ì…ë ¥ ëª¨ë“œ ì¢…ë£Œ
            }
        });

        // ì‚¬ìš©ìê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì…ë ¥ ëª¨ë“œ ì‹œì‘
        function startInput(type) {
            currentInputType = type;
            if (selectedCoords) {
                // ì´ë¯¸ ìœ„ì¹˜ê°€ ì„ íƒëœ ê²½ìš° ì¦‰ì‹œ ëª¨ë‹¬ ì—´ê¸°
                openModal(type);
                currentInputType = null; 
            } else {
                // ìœ„ì¹˜ê°€ ì„ íƒë˜ì§€ ì•Šì€ ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
                alert('ì§€ë„ì—ì„œ ìœ„ì¹˜ë¥¼ ë¨¼ì € í´ë¦­í•´ ì£¼ì„¸ìš”.');
            }
        }


        // ---------------------------------------------------------------------
        // 3. ëª¨ë‹¬ ë° í¼ ìƒì„± ë¡œì§
        // ---------------------------------------------------------------------

        function openModal(type) {
            if (!selectedCoords) return;

            let title = '';
            let formHtml = '';
            
            modalCoordsEl.textContent = `ì„ íƒ ìœ„ì¹˜: ìœ„ë„ ${selectedCoords.lat.toFixed(6)}, ê²½ë„ ${selectedCoords.lon.toFixed(6)}`;
            
            // í¼ HTML ì •ì˜
            if (type === 'sensor') {
                title = 'ì§ì ‘ ê°ì§€ ê°’ ì‹œë®¬ë ˆì´ì…˜';
                formHtml = `
                    <label for="sensor-smoke">ì—°ê¸°ëŸ‰ (50 ì´ìƒ ê¶Œì¥):</label>
                    <input type="number" id="sensor-smoke" value="100" min="0" required>
                    <label for="sensor-temp">ì˜¨ë„ (Â°C):</label>
                    <input type="number" id="sensor-temp" value="30" min="0" required>
                    <input type="hidden" id="sensor-time" value="${Date.now()}">
                `;
            } else if (type === 'citizen') {
                title = 'ì‹œë¯¼ ì‹ ê³ ';
                formHtml = `
                    <p>ì‹ ê³  ì‹œê°„: ${new Date().toLocaleString()}</p>
                    <input type="hidden" id="citizen-time" value="${Date.now()}">
                `;
            } else if (type === 'pre-report') {
                title = 'ì†Œê° ì‚¬ì „ ì‹ ê³ ';
                formHtml = `
                    <label for="pre-report-start">ì†Œê° ì‹œì‘ ë‚ ì§œ/ì‹œê°„:</label>
                    <input type="datetime-local" id="pre-report-start" required>
                    <label for="pre-report-end">ì†Œê° ì¢…ë£Œ ë‚ ì§œ/ì‹œê°„:</label>
                    <input type="datetime-local" id="pre-report-end" required>
                    <label for="pre-report-range">ì†Œê° ë°˜ê²½ (km):</label>
                    <input type="number" id="pre-report-range" value="0.5" min="0.1" step="0.1" required>
                `;
            }

            modalTitleEl.textContent = title;
            modalFormContentEl.innerHTML = formHtml;
            submitButton.onclick = () => submitData(type);
            modalStatusEl.style.display = 'none';
            modalEl.style.display = 'block';
        }

        function closeModal() {
            modalEl.style.display = 'none';
            modalStatusEl.style.display = 'none';
        }

        // ---------------------------------------------------------------------
        // 4. ë°ì´í„° ì „ì†¡ (POST ìš”ì²­) ë¡œì§
        // ---------------------------------------------------------------------

        async function submitData(type) {
            if (!selectedCoords) return;

            modalStatusEl.className = 'status-message waiting';
            modalStatusEl.textContent = 'ë°ì´í„° ë“±ë¡ ì¤‘...';
            modalStatusEl.style.display = 'block';

            let payload = { lat: selectedCoords.lat, lon: selectedCoords.lon };
            let endpoint = '';

            // í¼ ë°ì´í„° ìˆ˜ì§‘
            if (type === 'sensor') {
                const smoke = document.getElementById('sensor-smoke').value;
                const temp = document.getElementById('sensor-temp').value;
                if (!smoke || !temp) { return updateStatus('error', 'ì—°ê¸°ëŸ‰ê³¼ ì˜¨ë„ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); }

                payload = { 
                    ...payload, 
                    smoke: parseFloat(smoke), 
                    temp: parseFloat(temp), 
                    time: Date.now(),
                    humidity: 60 // ì„ì˜ì˜ ê°’ ì¶”ê°€
                };
                endpoint = '/api/add/sensor';
            } else if (type === 'citizen') {
                payload = { ...payload, time: Date.now() };
                endpoint = '/api/add/citizen';
            } else if (type === 'pre-report') {
                const startTimeStr = document.getElementById('pre-report-start').value;
                const endTimeStr = document.getElementById('pre-report-end').value;
                const range = document.getElementById('pre-report-range').value;
                if (!startTimeStr || !endTimeStr || !range) { return updateStatus('error', 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); }
                
                const startDate = new Date(startTimeStr).getTime();
                const endDate = new Date(endTimeStr).getTime();

                payload = { 
                    ...payload, 
                    startDate: startDate, 
                    endDate: endDate, 
                    rangeKm: parseFloat(range) 
                };
                endpoint = '/api/add/pre';
            } else {
                return;
            }

            // POST ìš”ì²­
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `API ë“±ë¡ ì‹¤íŒ¨ (${response.status} ${response.statusText})`;
                    
                    // JSON.parse ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ ì‘ë‹µ ë³¸ë¬¸ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
                    try {
                        const errorText = await response.text();
                        if (errorText) {
                            // JSON íŒŒì‹±ì„ ì‹œë„í•˜ê³ , ì‹¤íŒ¨í•˜ë©´ í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                            try {
                                const errorData = JSON.parse(errorText);
                                // ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ êµ¬ì¡°í™”ë˜ì–´ ìˆìœ¼ë©´ ì¶”ì¶œ
                                errorMessage = errorData.error || errorData.message || JSON.stringify(errorData);
                            } catch (e) {
                                // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ, í…ìŠ¤íŠ¸ ìì²´ë¥¼ ì˜¤ë¥˜ ë©”ì‹œì§€ë¡œ ì‚¬ìš© (ê¸¸ì´ ì œí•œ)
                                errorMessage = errorText.substring(0, 200); 
                            }
                        } else {
                            // ë³¸ë¬¸ì´ ë¹„ì–´ ìˆëŠ” ê²½ìš°, ìƒíƒœ í…ìŠ¤íŠ¸ë¥¼ ì‚¬ìš©
                            errorMessage = response.statusText || 'ì‘ë‹µ ë³¸ë¬¸ ì—†ìŒ';
                        }
                    } catch (e) {
                        // ì‘ë‹µ ë³¸ë¬¸ì„ ì½ëŠ” ë° ì‹¤íŒ¨í•œ ê²½ìš°
                        errorMessage = `ì‘ë‹µ ë³¸ë¬¸ ì½ê¸° ì˜¤ë¥˜. ìƒíƒœ ì½”ë“œ: ${response.status}`;
                    }

                    // ìµœì¢… ì˜¤ë¥˜ ë©”ì‹œì§€ë¡œ ì˜ˆì™¸ ë°œìƒ
                    throw new Error(errorMessage);
                }

                updateStatus('success', `${modalTitleEl.textContent}ì´(ê°€) ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!`);
                
                // ë°ì´í„° ë“±ë¡ í›„ 1ì´ˆ ë’¤ì— ëª¨ë‹¬ ë‹«ê³  ì§€ë„ ìƒˆë¡œê³ ì¹¨
                setTimeout(() => {
                    closeModal();
                    loadAndDisplayData();
                }, 1000);

            } catch (error) {
                console.error('ë°ì´í„° ì „ì†¡ ì˜¤ë¥˜:', error);
                updateStatus('error', `ë“±ë¡ ì˜¤ë¥˜: ${error.message}`);
            }
        }

        function updateStatus(type, message) {
            modalStatusEl.className = `status-message ${type}`;
            modalStatusEl.textContent = message;
        }


        // ---------------------------------------------------------------------
        // 5. ì‹œê°í™” ë¡œì§ (ì´ì „ ì½”ë“œì™€ ë™ì¼, isInPreReport í•¨ìˆ˜ëŠ” map ìŠ¤í¬ë¦½íŠ¸ ì™¸ë¶€ë¡œ ì´ë™)
        // ---------------------------------------------------------------------
        
        // ì´ í•¨ìˆ˜ëŠ” ì„œë²„ì—ì„œ ë°›ì€ preReports ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë§ˆì»¤ì˜ ìƒ‰ìƒì„ ê²°ì •í•©ë‹ˆë‹¤.
        const isInPreReport = (lat, lon, time, preReports) => {
            const currentTime = time; // timeì€ Unix Time Milliseconds
            
            for (const report of preReports) {
                const radiusKm = report.rangeKm || 0.1;
                const centerLat = report.lat;
                const centerLon = report.lon;
                const startTime = report.startDate; 
                const endTime = report.endDate; 
                
                // Haversine ê³µì‹ (ëŒ€ëµì ì¸ ê±°ë¦¬ ê³„ì‚°)
                const R = 6371; 
                const dLat = (lat - centerLat) * (Math.PI / 180);
                const dLon = (lon - centerLon) * (Math.PI / 180);

                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(centerLat * (Math.PI / 180)) * Math.cos(lat * (Math.PI / 180)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const distanceKm = R * c;

                const isWithinTime = currentTime >= startTime && currentTime <= endTime;
                const isWithinRange = distanceKm <= radiusKm;
                
                if (isWithinTime && isWithinRange) {
                    return true;
                }
            }
            return false;
        };
        
        async function loadAndDisplayData() {
            try {
                const response = await fetch('/api/data'); 
                if (!response.ok) throw new Error('Failed to fetch data from API');
                
                const allData = await response.json();
                
                const preReports = allData.preReports || [];
                const sensorData = allData.sensorData || [];
                const citizenReports = allData.citizenReports || [];
                
                markers.clearLayers(); 

                // A. ì§ì ‘ ê°ì§€ ë°ì´í„° (sensorData) ì²˜ë¦¬
                sensorData.forEach(row => {
                    if (row.smoke && row.smoke > 50) { 
                        const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                        const color = isReported ? '#ff8c00' : '#dc2626'; 
                        const icon = createCircleIcon(color);
                        const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                            <b>[ì§ì ‘ ê°ì§€]</b><br>
                            <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                            <b>ì—°ê¸°ëŸ‰:</b> ${row.smoke}<br>
                            <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                        `);
                        markers.addLayer(marker);
                    }
                });

                // B. ì‹œë¯¼ ì‹ ê³  ë°ì´í„° (citizenReports) ì²˜ë¦¬
                citizenReports.forEach(row => {
                    const isReported = isInPreReport(row.lat, row.lon, row.time, preReports);
                    const color = isReported ? '#ff8c00' : '#dc2626'; 
                    const icon = createTriangleIcon(color);

                    const marker = L.marker([row.lat, row.lon], { icon: icon }).bindPopup(`
                        <b>[ì‹œë¯¼ ì‹ ê³ ]</b><br>
                        <b>ì‹œê°„:</b> ${new Date(row.time).toLocaleString()}<br>
                        <b>ì‹ ê³  ì—¬ë¶€:</b> ${isReported ? 'âœ… ì‚¬ì „ ì‹ ê³ ë¨' : 'ğŸš¨ ë¶ˆë²• ì†Œê° ì˜ì‹¬'}
                    `);
                    markers.addLayer(marker);
                });

                map.addLayer(markers);
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë”© ë° ì‹œê°í™” ì˜¤ë¥˜:', error);
            }
        }
        
        loadAndDisplayData();
        setInterval(loadAndDisplayData, 10000); 

    </script>
</body>
</html>